<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Ailamazyan</title>
</head>


<body>
<div class="head">
<h1>Theory Ailamazyan</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Ailamazyan
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Eval_FO.html">Eval_FO</a> <a href="Cluster.html">Cluster</a> <a href="Mapping_Code.html">Mapping_Code</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">SP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SP</span> <span class="main">(</span>Eqa <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SP</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">SP</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SP</span> <span class="main">(</span>Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">SP</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">SP</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SP</span> <span class="main">(</span>Disj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">SP</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">SP</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SP</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">SP</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SP</span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">SP</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SP</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SP_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"SP <span class="free">φ</span> <span class="main">⊆</span> fv_fo_fmla <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> SP.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_SP<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>SP <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> SP_fv finite_fv_fo_fmla finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">SP_list_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SP_list_rec</span> <span class="main">(</span>Eqa <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="keyword1">then</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SP_list_rec</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">SP_list_rec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SP_list_rec</span> <span class="main">(</span>Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">SP_list_rec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">@</span> <span class="free">SP_list_rec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SP_list_rec</span> <span class="main">(</span>Disj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">SP_list_rec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">@</span> <span class="free">SP_list_rec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SP_list_rec</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="bound">m</span><span class="main">)</span> <span class="main">(</span><span class="free">SP_list_rec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SP_list_rec</span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="bound">m</span><span class="main">)</span> <span class="main">(</span><span class="free">SP_list_rec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">SP_list_rec</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SP_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SP_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> remdups_adj <span class="main">(</span>sort <span class="main">(</span>SP_list_rec <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SP_list_set<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>SP_list <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> SP <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SP_list_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> SP.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_terms_set_list<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_distinct_SP_list<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="main">(</span>SP_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SP_list_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> distinct_remdups_adj_sort<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">(</span>Eqa <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="keyword1">then</span> <span class="numeral">2</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">d</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">(</span>Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">d</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span><span class="free">d</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>card <span class="main">(</span>SP <span class="main">(</span>Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">(</span>Disj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">d</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span><span class="free">d</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>card <span class="main">(</span>SP <span class="main">(</span>Disj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">d</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">d</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> d_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> d <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> d.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> card_SP_d<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>SP <span class="free">φ</span><span class="main">)</span> <span class="main">≤</span> d <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dual_order.trans
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> SP.induct<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Diff1_le finite_SP<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_eterm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> val <span class="main">⇒</span> <span class="tfree">'a</span> fo_term <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⋅e</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_eterm</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> Inl <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_eterm</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eval_eterms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> val <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> fo_term<span class="main">)</span> list <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> list"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊙e</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_eterms</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> map <span class="main">(</span>eval_eterm <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_eterm_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> fv_fo_term_set <span class="free">t</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">σ'</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span>
  eval_eterm <span class="free">σ</span> <span class="free">t</span> <span class="main">=</span> eval_eterm <span class="free">σ'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_eterms_fv_fo_terms_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">σ'</span> <span class="keyword1">⊙e</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">∈</span> fv_fo_terms_set <span class="free">ts</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="free">n</span> <span class="main">=</span> <span class="free">σ'</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def fv_fo_terms_set_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def fv_fo_terms_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_eterms_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> fv_fo_terms_set <span class="free">ts</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">σ'</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span>
  eval_eterms <span class="free">σ</span> <span class="free">ts</span> <span class="main">=</span> eval_eterms <span class="free">σ'</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def fv_fo_terms_set_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_eterm_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_terms_eterms<span class="main">:</span> <span class="quoted"><span class="quoted">"map Inl <span class="main">(</span><span class="free">σ</span> <span class="main">⊙</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Inl <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span> <span class="keyword1">⊙e</span> <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_terms_def eval_eterms_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_terms_def eval_eterms_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ad_equiv_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ad_equiv_pair</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sp_equiv_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_equiv_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ad_equiv_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ad_equiv_list</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">.</span> ad_equiv_pair <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sp_equiv_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_equiv_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">∧</span> pairwise sp_equiv_pair <span class="main">(</span>set <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ad_agr_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ad_agr_list</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">∧</span> ad_equiv_list <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">∧</span> sp_equiv_list <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_equiv_pair_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> ad_equiv_pair.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_equiv_pair_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">a'</span><span class="main">)</span> <span class="main">⟷</span> ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="free">a'</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_equiv_pair.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_equiv_pair_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> ad_equiv_pair <span class="free">Y</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">a'</span><span class="main">)</span> <span class="main">⟹</span> ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sp_equiv_pair_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_equiv_pair <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> sp_equiv_pair <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sp_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> val <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> val <span class="main">⇒</span> nat set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sp_equiv</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟷</span> pairwise sp_equiv_pair <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">n</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sp_equiv_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">⟹</span> sp_equiv <span class="free">σ</span> <span class="free">τ</span> <span class="free">J</span> <span class="main">⟹</span> sp_equiv <span class="free">σ</span> <span class="free">τ</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_def pairwise_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ad_agr_sets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> val <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> val <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ad_agr_sets</span> <span class="free"><span class="bound"><span class="entity">FV</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">FV</span></span></span><span class="main">.</span> ad_equiv_pair <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> sp_equiv <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_sets_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_sets <span class="free">FV</span> <span class="free">S</span> <span class="free">X</span> <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> ad_agr_sets <span class="free">FV</span> <span class="free">S</span> <span class="free">X</span> <span class="free">τ</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ad_agr_sets_def sp_equiv_def pairwise_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ad_equiv_pair_comm<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_sets_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> ad_agr_sets <span class="free">FV</span> <span class="free">S</span> <span class="free">Y</span> <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> ad_agr_sets <span class="free">FV</span> <span class="free">S</span> <span class="free">X</span> <span class="free">σ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ad_equiv_pair_mono
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_sets_mono'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> ad_agr_sets <span class="free">FV</span> <span class="free">S'</span> <span class="free">X</span> <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> ad_agr_sets <span class="free">FV</span> <span class="free">S</span> <span class="free">X</span> <span class="free">σ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def sp_equiv_def pairwise_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_equiv_list_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_equiv_list <span class="free">X</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> ad_equiv_list <span class="free">X</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_equiv_list_def<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> ad_equiv_pair_comm in_set_zip prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_equiv_list_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> ad_equiv_list <span class="free">Y</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> ad_equiv_list <span class="free">X</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ad_equiv_pair_mono
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_equiv_list_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_equiv_list_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ad_equiv_list <span class="free">X</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"ad_equiv_list <span class="free">X</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ad_equiv_list <span class="free">X</span> <span class="free">xs</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> lens<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_equiv_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⟹</span> ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms lens i_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip y_def ad_equiv_list_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_equiv_list_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_equiv_list_link<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="free">ns</span><span class="main">.</span> ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">,</span> <span class="free">τ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
  ad_equiv_list <span class="free">X</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>map <span class="free">τ</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_equiv_list_def set_zip<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth nth_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_zip_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_zip prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_zip_map<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>zip <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>map <span class="free">τ</span> <span class="free">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">n</span><span class="main">,</span> <span class="free">τ</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sp_equiv_list_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> sp_equiv_list <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sp_equiv_list_def
  <span class="keyword1"><span class="command">using</span></span> set_zip_comm
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pairwise_def<span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sp_equiv_list_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="free">xs</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> lens<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise sp_equiv_pair <span class="main">(</span>set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pairwiseI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xz</span> <span class="skolem">xz'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xz</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xz'</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> xz_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">xz</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">z'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xz'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">z'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sp_equiv_pair <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">y'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sp_equiv_pair <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y'</span><span class="main">,</span> <span class="skolem">z'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms lens xz_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_list_def pairwise_def y_def y'_def set_zip<span class="main">)</span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_equiv_pair <span class="skolem">xz</span> <span class="skolem">xz'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xz_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_list_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sp_equiv_list_link<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>map <span class="free">τ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">⟷</span> sp_equiv <span class="free">σ</span> <span class="free">τ</span> <span class="main">(</span>set <span class="free">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_list_def sp_equiv_def pairwise_def set_zip in_set_conv_nth<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> nth_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> nth_map<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">X</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> ad_agr_list <span class="free">X</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ad_equiv_list_comm sp_equiv_list_comm
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> ad_agr_list <span class="free">Y</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> ad_agr_list <span class="free">X</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ad_equiv_list_mono
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_rev_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> ad_agr_list <span class="free">Y</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span>
  Inl <span class="main">-`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> Inl <span class="main">-`</span> set <span class="free">ys</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> ad_agr_list <span class="free">X</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">a</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">b</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vimage_def set_zip<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Collect_mem_eq Collect_mono_iff imageI nth_mem<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Collect_mem_eq Collect_mono_iff imageI nth_mem<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Collect_mem_eq Collect_mono_iff imageI nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Inl_Inr_False image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">X</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> ad_agr_list <span class="free">X</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟹</span> ad_agr_list <span class="free">X</span> <span class="free">xs</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ad_equiv_list_trans sp_equiv_list_trans
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">X</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def set_zip ad_equiv_pair.simps
      sp_equiv_list_def pairwise_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_set<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">X</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> Inl <span class="free">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> Inl <span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def set_zip in_set_conv_nth<span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> ad_equiv_pair.simps image_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_length<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">X</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> <span class="free">AD</span> <span class="main">⟹</span> ad_agr_list <span class="free">AD</span> <span class="main">(</span>map Inl <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map Inl <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def set_zip ad_equiv_pair.simps
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sp_equiv_list_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ms</span> <span class="main">⊆</span> set <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σ'</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="main">(</span>map <span class="free">σ</span> <span class="free">ms</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σ'</span> <span class="free">ms</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sp_equiv_list_def length_map pairwise_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">(</span>map <span class="free">σ</span> <span class="free">ms</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σ'</span> <span class="free">ms</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">(</span>map <span class="free">σ</span> <span class="free">ms</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σ'</span> <span class="free">ms</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σ'</span> <span class="free">ns</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σ'</span> <span class="free">ns</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth nth_map subset_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_equiv_pair <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_list_def pairwise_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ms</span> <span class="main">⊆</span> set <span class="free">ns</span> <span class="main">⟹</span> ad_agr_list <span class="free">X</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σ'</span> <span class="free">ns</span><span class="main">)</span> <span class="main">⟹</span>
  ad_agr_list <span class="free">X</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ms</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σ'</span> <span class="free">ms</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def sp_equiv_list_subset set_zip<span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> in_set_conv_nth nth_map subset_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_link<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_sets <span class="main">(</span>set <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>set <span class="free">ns</span><span class="main">)</span> <span class="free">AD</span> <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟷</span>
  ad_agr_list <span class="free">AD</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>map <span class="free">τ</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ad_agr_sets_def ad_agr_list_def
  <span class="keyword1"><span class="command">using</span></span> ad_equiv_list_link sp_equiv_list_link
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ad_agr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> val <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> val <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ad_agr</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟷</span> ad_agr_sets <span class="main">(</span>fv_fo_fmla <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>SP <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_sets_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ad_agr_sets <span class="main">(</span>set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">AD</span> <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> ad_agr <span class="free">φ</span> <span class="free">AD</span> <span class="free">σ</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sp_equiv_mono SP_fv
  <span class="keyword1"><span class="command">unfolding</span></span> fv_fo_fmla_list_set
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def ad_agr_def<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_Inl<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> finite <span class="main">(</span>Inl <span class="main">-`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_vimageI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted">Inl</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_out<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∉</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> Suc <span class="main">(</span>card <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> card_mono<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="free">X</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> extend_τ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ad_agr_sets <span class="main">(</span><span class="free">FV</span> <span class="main">-</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="free">X</span> <span class="free">σ</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">FV</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">`</span> <span class="main">(</span><span class="free">FV</span> <span class="main">-</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Z</span>"</span></span>
    <span class="quoted"><span class="quoted">"Inl <span class="main">`</span> <span class="free">X</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>max <span class="main">1</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> <span class="free">τ</span> <span class="main">`</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">Z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="free">Z</span><span class="main">.</span> ad_agr_sets <span class="free">FV</span> <span class="free">S</span> <span class="free">X</span> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">note</span></span> n_in_S <span class="main">=</span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free">X</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms n_in_S True
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def sp_equiv_def pairwise_def<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> True insert_Diff insert_iff subsetD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">note</span></span> σ_n_not_Inl <span class="main">=</span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="free">σ</span> <span class="bound">m</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">σ</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> τ_m_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="skolem">m</span> <span class="main">∈</span> <span class="free">Z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms m_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">τ</span></span> <span class="skolem"><span class="skolem">m</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms n_in_S σ_n_not_Inl True m_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def sp_equiv_def pairwise_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> out<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">σ</span> <span class="main">`</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Inr <span class="main">-`</span> <span class="free">τ</span> <span class="main">`</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_vimageI<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Inr <span class="skolem">k</span> <span class="main">∉</span> <span class="free">τ</span> <span class="main">`</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> <span class="free">τ</span> <span class="main">`</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_out<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inr <span class="skolem"><span class="skolem">k</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms n_in_S σ_n_not_Inl out k_def assms<span class="main">(</span>5<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def sp_equiv_def pairwise_def<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI insertE insert_Diff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free">X</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms False
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def sp_equiv_def pairwise_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inr <span class="main"><span class="main">0</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms False
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def sp_equiv_def pairwise_def<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> esat_Pred<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ad_agr_sets <span class="free">FV</span> <span class="free">S</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"fv_fo_terms_set <span class="free">ts</span> <span class="main">⊆</span> <span class="free">FV</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span> <span class="main">∈</span> map Inl <span class="main">`</span> <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">⋅e</span> <span class="free">t</span> <span class="main">=</span> <span class="free">τ</span> <span class="keyword1">⋅e</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> vs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span> <span class="main">=</span> map Inl <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">n</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def Var<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">n</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vs_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> vs_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="free">FV</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Var fv_fo_terms_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps ad_agr_sets_def Var
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sp_equiv_list_fv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> fv_fo_terms_set <span class="free">ts</span> <span class="main">⟹</span> ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">,</span> <span class="free">τ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set_fo_term <span class="main">`</span> set <span class="free">ts</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"sp_equiv <span class="free">σ</span> <span class="free">τ</span> <span class="main">(</span>fv_fo_terms_set <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(⋅e)</span> <span class="free">σ</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(⋅e)</span> <span class="free">τ</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(⋅e)</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(⋅e)</span> <span class="free">τ</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_terms_set_def sp_equiv_def pairwise_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Const <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> c_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Const<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> fv_t<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_term_set <span class="skolem">t</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Const<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> set <span class="skolem">ts</span> <span class="main">⟹</span> sp_equiv_pair <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⋅e</span> <span class="skolem">t</span><span class="main">,</span> <span class="free">τ</span> <span class="keyword1">⋅e</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⋅e</span> <span class="bound">t'</span><span class="main">,</span> <span class="free">τ</span> <span class="keyword1">⋅e</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> c_X Const Cons<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_terms_set_def<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ad_equiv_pair.simps fv_fo_terms_setI image_insert insert_iff list.set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
            mk_disjoint_insert<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(⋅e)</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(⋅e)</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ind pairwise_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted">sp_equiv_pair</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">⋅e</span> <span class="skolem">t</span><span class="main">,</span> <span class="free">τ</span> <span class="keyword1">⋅e</span> <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> sp_equiv_list_def set_zip_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_pair_comm fv_fo_terms_set_def fv_t<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ad_n<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="free">σ</span> <span class="skolem">n</span><span class="main">,</span> <span class="free">τ</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_terms_set_def Var<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> sp_equiv_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n'</span><span class="main">.</span> Var <span class="bound">n'</span> <span class="main">∈</span> set <span class="skolem">ts</span> <span class="main">⟹</span> sp_equiv_pair <span class="main">(</span><span class="free">σ</span> <span class="skolem">n</span><span class="main">,</span> <span class="free">τ</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">n'</span><span class="main">,</span> <span class="free">τ</span> <span class="bound">n'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_def pairwise_def fv_fo_terms_set_def Var<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> set <span class="skolem">ts</span> <span class="main">⟹</span> sp_equiv_pair <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⋅e</span> <span class="skolem">t</span><span class="main">,</span> <span class="free">τ</span> <span class="keyword1">⋅e</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⋅e</span> <span class="bound">t'</span><span class="main">,</span> <span class="free">τ</span> <span class="keyword1">⋅e</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> sp_equiv_Var
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Var<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> SUP_le_iff ad_equiv_pair.simps ad_n fo_term.set_intros imageI subset_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> SUP_le_iff ad_equiv_pair.simps ad_n fo_term.set_intros imageI subset_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ind pairwise_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted">sp_equiv_pair</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">⋅e</span> <span class="skolem">t</span><span class="main">,</span> <span class="free">τ</span> <span class="keyword1">⋅e</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⋅e</span> <span class="bound">n</span><span class="main">,</span> <span class="free">τ</span> <span class="keyword1">⋅e</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set <span class="skolem">ts</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> sp_equiv_list_def set_zip_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_pair_comm<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_def sp_equiv_list_def fv_fo_terms_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> esat_Pred_inf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fv_fo_terms_set <span class="free">ts</span> <span class="main">⊆</span> <span class="free">FV</span>"</span></span> <span class="quoted"><span class="quoted">"fv_fo_terms_set <span class="free">ts</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"ad_agr_sets <span class="free">FV</span> <span class="free">S</span> <span class="free">AD</span> <span class="free">σ</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span> <span class="free">vs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set_fo_term <span class="main">`</span> set <span class="free">ts</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span><span class="free">τ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span> <span class="free">vs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_equiv <span class="free">σ</span> <span class="free">τ</span> <span class="main">(</span>fv_fo_terms_set <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> sp_equiv_mono
    <span class="keyword1"><span class="command">unfolding</span></span> ad_agr_sets_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> fv_fo_terms_set <span class="free">ts</span> <span class="main">⟹</span> ad_equiv_pair <span class="free">AD</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">,</span> <span class="free">τ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(⋅e)</span> <span class="free">σ</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(⋅e)</span> <span class="free">τ</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sp_equiv_list_fv<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> sp<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ad_agr_list<span class="main">:</span>
    <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span> <span class="main">(</span><span class="free">τ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eval_eterms_def ad_agr_list_def ad_equiv_list_link<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_equiv_pair.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fv_fo_terms_setI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_list_comm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ad_agr_list_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ad_agr_list_comm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> ad_agr_list<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> fo_t <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">×</span> nat <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> table"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">esat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> table<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_intp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> val <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">esat</span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">⊙e</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">∈</span> map Inl <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">esat</span> <span class="main">(</span>Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">esat</span> <span class="main">(</span>Eqa <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">⋅e</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">⋅e</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">esat</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="main">¬</span><span class="free">esat</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">esat</span> <span class="main">(</span>Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="free">esat</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> <span class="free">esat</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">esat</span> <span class="main">(</span>Disj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="free">esat</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∨</span> <span class="free">esat</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">esat</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="free">esat</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">esat</span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="free">esat</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sz_fmla</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sz_fmla</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">sz_fmla</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sz_fmla</span> <span class="main">(</span>Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">sz_fmla</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="free">sz_fmla</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sz_fmla</span> <span class="main">(</span>Disj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">sz_fmla</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="free">sz_fmla</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sz_fmla</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">sz_fmla</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sz_fmla</span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span><span class="free">sz_fmla</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sz_fmla</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sz_fmla_induct<span class="main">[</span><span class="operator">case_names</span> Pred Bool Eqa Neg Conj Disj Exists Forall<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">r</span> <span class="bound">ts</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Pred <span class="bound">r</span> <span class="bound">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Bool <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Eqa <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Neg <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Conj <span class="bound">φ</span> <span class="bound">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Disj <span class="bound">φ</span> <span class="bound">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">n</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Exists <span class="bound">n</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">n</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Exists <span class="bound">n</span> <span class="main">(</span>Neg <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Forall <span class="bound">n</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"sz_fmla <span class="free">φ</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> sz_fmla <span class="bound">ψ</span> <span class="main">&lt;</span> sz_fmla <span class="skolem">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">,</span>8<span class="main">,</span>9<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> esat_fv_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> fv_fo_fmla <span class="free">φ</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">σ'</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> <span class="free">X</span> <span class="main">⟷</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ'</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">σ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sz_fmla_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">r</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def fv_fo_terms_set_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">smt</span> comp_apply eval_eterm_cong fv_fo_term_set_cong image_insert insertCI map_eq_conv
        mk_disjoint_insert<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eqa <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Neg<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="skolem">σ'</span></span><span class="main">]</span> Neg<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conj <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Conj<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ'</span></span></span></span><span class="main">]</span> Conj<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Disj <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Disj<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ'</span></span></span></span><span class="main">]</span> Disj<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">σ</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"esat <span class="skolem">φ</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> x_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"esat <span class="skolem">φ</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Exists<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">]</span> Exists<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> x_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">σ'</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">σ'</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"esat <span class="skolem">φ</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> x_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"esat <span class="skolem">φ</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Exists<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">]</span> Exists<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> x_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">σ</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Forall <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ad_terms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> fo_term<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ad_terms</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map set_fo_term <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">act_edom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> table<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_intp <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">act_edom</span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> ad_terms <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">act_edom</span> <span class="main">(</span>Bool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">act_edom</span> <span class="main">(</span>Eqa <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> set_fo_term <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∪</span> set_fo_term <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">act_edom</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="free">act_edom</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">act_edom</span> <span class="main">(</span>Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="free">act_edom</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∪</span> <span class="free">act_edom</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">act_edom</span> <span class="main">(</span>Disj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="free">act_edom</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∪</span> <span class="free">act_edom</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">act_edom</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="free">act_edom</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">act_edom</span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="free">act_edom</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_act_edom<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="free">φ</span> <span class="free">I</span> <span class="main">⟹</span> finite <span class="main">(</span>act_edom <span class="free">φ</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_Inl
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_fo_intp.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_set_fo_term vimage_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fo_adom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> fo_t <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fo_adom</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr <span class="free">φ</span> <span class="free">AD</span> <span class="free">σ</span> <span class="free">τ</span> <span class="main">⟹</span> act_edom <span class="free">φ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">AD</span> <span class="main">⟹</span>
  Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>d <span class="free">φ</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">τ</span> <span class="main">`</span> fv_fo_fmla <span class="free">φ</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span>
  esat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> UNIV <span class="main">⟷</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="free">τ</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sz_fmla_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">r</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fv_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_terms_set <span class="skolem">ts</span> <span class="main">⊆</span> fv_fo_fmla <span class="main">(</span>Pred <span class="skolem">r</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sub_AD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pred<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> esat.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊙e</span> <span class="skolem">ts</span> <span class="main">∈</span> map Inl <span class="main">`</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊙e</span> <span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">τ</span> <span class="keyword1">⊙e</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> esat_Pred<span class="main">[</span><span class="operator">OF</span> ad_agr_sets_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sub_AD Pred<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ad_agr_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
            fv_sub assm<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="keyword1">⊙e</span> <span class="skolem">ts</span> <span class="main">∈</span> map Inl <span class="main">`</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="keyword1">⊙e</span> <span class="skolem">ts</span> <span class="main">∈</span> map Inl <span class="main">`</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="keyword1">⊙e</span> <span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="keyword1">⊙e</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> esat_Pred<span class="main">[</span><span class="operator">OF</span> ad_agr_sets_comm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ad_agr_sets_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span>
            sub_AD Pred<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ad_agr_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> fv_sub assm<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊙e</span> <span class="skolem">ts</span> <span class="main">∈</span> map Inl <span class="main">`</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> length <span class="skolem">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eqa <span class="skolem">x1</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">c'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> Const <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">=</span> Const <span class="skolem">c'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Eqa <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">m'</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> Const <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">=</span> Var <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Eqa<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">m'</span> <span class="main">=</span> Inl <span class="skolem">c</span> <span class="main">⟷</span> <span class="skolem">τ</span> <span class="skolem">m'</span> <span class="main">=</span> Inl <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_def ad_agr_sets_def<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">c'</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> Var <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">=</span> Const <span class="skolem">c'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Eqa<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">c'</span> <span class="main">⟷</span> <span class="skolem">τ</span> <span class="skolem">m</span> <span class="main">=</span> Inl <span class="skolem">c'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_def ad_agr_sets_def<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">m'</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> Var <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">=</span> Var <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Eqa<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">m'</span> <span class="main">⟷</span> <span class="skolem">τ</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">τ</span> <span class="skolem">m'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_def ad_agr_sets_def sp_equiv_def pairwise_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Neg<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ad_agr <span class="skolem">φ</span> <span class="free">AD</span> <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Neg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conj <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr <span class="skolem">φ1</span> <span class="free">AD</span> <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span> <span class="quoted"><span class="quoted">"ad_agr <span class="skolem">φ2</span> <span class="free">AD</span> <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span>
    <span class="quoted"><span class="quoted">"Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>d <span class="skolem">φ1</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>d <span class="skolem">φ2</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">`</span> fv_fo_fmla <span class="skolem">φ1</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">`</span> fv_fo_fmla <span class="skolem">φ2</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Conj<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_def ad_agr_sets_def sp_equiv_def pairwise_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Conj<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> aux<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ aux<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> aux<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> Conj<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> aux<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ aux<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> aux<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> Conj<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Disj <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr <span class="skolem">φ1</span> <span class="free">AD</span> <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span> <span class="quoted"><span class="quoted">"ad_agr <span class="skolem">φ2</span> <span class="free">AD</span> <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span>
    <span class="quoted"><span class="quoted">"Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>d <span class="skolem">φ1</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>d <span class="skolem">φ2</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">`</span> fv_fo_fmla <span class="skolem">φ1</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">`</span> fv_fo_fmla <span class="skolem">φ2</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Disj<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_def ad_agr_sets_def sp_equiv_def pairwise_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Disj<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> aux<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ aux<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> aux<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> Disj<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> aux<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ aux<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> aux<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> Disj<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">m</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="skolem">m</span> <span class="skolem">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">σ</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"esat <span class="skolem">φ</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> SP <span class="skolem">φ</span> <span class="main">⟹</span> Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> <span class="skolem">τ</span> <span class="main">`</span> <span class="main">(</span>SP <span class="skolem">φ</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>SP <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_insert_absorb card_image card_le_Suc_iff finite_Diff finite_SP
          image_vimage_subset inj_Inr mk_disjoint_insert surj_card_le<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Inr <span class="main">-`</span> <span class="skolem">τ</span> <span class="main">`</span> SP <span class="skolem">φ</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>SP <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_image finite_SP image_vimage_subset inj_Inr surj_card_le<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max <span class="main">1</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> <span class="skolem">τ</span> <span class="main">`</span> <span class="main">(</span>SP <span class="skolem">φ</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">m</span> <span class="main">∈</span> SP <span class="skolem">φ</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> d <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d_pos card_SP_d<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> ad_agr <span class="skolem">φ</span> <span class="free">AD</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> extend_τ<span class="main">[</span><span class="operator">OF</span> Exists<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ad_agr_def fv_fo_fmla.simps SP.simps<span class="main"><span class="main">]</span></span>
            SP_fv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main"><span class="main">]</span></span> finite_SP Exists<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fv_fo_fmla.simps<span class="main"><span class="main">]</span></span><span class="main">]</span>
            Exists<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"ad_agr <span class="skolem">φ</span> <span class="free">AD</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Exists<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">`</span> fv_fo_fmla <span class="skolem">φ</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x'_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"esat <span class="skolem">φ</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Exists x'_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> assm
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> x'_def <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="skolem">m</span> <span class="skolem">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">τ</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="skolem">m</span> <span class="skolem">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">τ</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"esat <span class="skolem">φ</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_sets <span class="main">(</span>fv_fo_fmla <span class="skolem">φ</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>SP <span class="skolem">φ</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">m</span><span class="main">}</span><span class="main">)</span> <span class="free">AD</span> <span class="skolem">τ</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Exists<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> ad_agr_def fv_fo_fmla.simps SP.simps<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_sets_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> ad_agr <span class="skolem">φ</span> <span class="free">AD</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> extend_τ<span class="main">[</span><span class="operator">OF</span> ad_agr SP_fv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main"><span class="main">]</span></span> finite_SP subset_UNIV subset_UNIV<span class="main">]</span> ad_agr_sets_comm
      <span class="keyword1"><span class="command">unfolding</span></span> ad_agr_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr <span class="skolem">φ</span> <span class="free">AD</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">`</span> fv_fo_fmla <span class="main">(</span>Exists <span class="skolem">m</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Exists
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> x_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"esat <span class="skolem">φ</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">m</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Exists assm
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="skolem">m</span> <span class="skolem">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">σ</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Forall <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"act_edom <span class="main">(</span>Forall <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="free">I</span> <span class="main">=</span> act_edom <span class="main">(</span>Exists <span class="skolem">n</span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>d <span class="main">(</span>Forall <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>d <span class="main">(</span>Exists <span class="skolem">n</span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"fv_fo_fmla <span class="main">(</span>Forall <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> fv_fo_fmla <span class="main">(</span>Exists <span class="skolem">n</span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr <span class="main">(</span>Exists <span class="skolem">n</span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">AD</span> <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Forall<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Forall<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> pred Forall<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> unfold<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> main_cor_inf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ad_agr <span class="free">φ</span> <span class="free">AD</span> <span class="free">σ</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"act_edom <span class="free">φ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span> <span class="quoted"><span class="quoted">"d <span class="free">φ</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">`</span> fv_fo_fmla <span class="free">φ</span> <span class="main">⊆</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> UNIV <span class="main">⟷</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="free">τ</span> <span class="main">(</span>Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> main<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> _ assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> esat_UNIV_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">+</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ad_agr <span class="free">φ</span> <span class="free">AD</span> <span class="free">σ</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"act_edom <span class="free">φ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> UNIV <span class="main">⟷</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="free">τ</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> main<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> subset_UNIV subset_UNIV<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> esat_UNIV_ad_agr_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">+</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>map <span class="free">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"act_edom <span class="free">φ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> UNIV <span class="main">⟷</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="free">τ</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">using</span></span> esat_UNIV_cong<span class="main">[</span><span class="operator">OF</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ad_agr_def<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ad_agr_sets_mono'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SP_fv<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span>
        <span class="operator">OF</span> iffD2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> ad_agr_list_link<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">unfolded</span> fv_fo_fmla_list_set<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fo_rep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> fo_t <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fo_rep</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ts'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> ad_agr_list <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">(</span>map Inl <span class="bound">ts</span><span class="main">)</span> <span class="bound">ts'</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_esat_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="free">φ</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> <span class="main">⟷</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Inl <span class="main">∘</span> <span class="free">σ</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sz_fmla_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">r</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sat.simps esat.simps comp_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> eval_terms_eterms<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eqa <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>Exists <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"esat <span class="skolem">φ</span> <span class="skolem">I</span> <span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">σ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Exists
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> Inl_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"Inl <span class="main">∘</span> <span class="skolem">σ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> Inl <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">I</span> <span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_def
      <span class="keyword1"><span class="command">unfolding</span></span> Inl_unfold
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">I</span> <span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"esat <span class="skolem">φ</span> <span class="skolem">I</span> <span class="main">(</span><span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>Exists <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> Inl_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Inl <span class="main">∘</span> <span class="skolem">σ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inl<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> x_def<span class="main">[</span><span class="operator">unfolded</span> Inl_unfold<span class="main">]</span> Exists
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">b</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∉</span> act_edom <span class="skolem">φ</span> <span class="skolem">I</span> <span class="main">∪</span> <span class="skolem">σ</span> <span class="main">`</span> fv_fo_fmla <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> arb_element finite_act_edom<span class="main">[</span><span class="operator">OF</span> Exists<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> finite_fv_fo_fmla
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Un finite_imageI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> wf_local<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="skolem">φ</span> <span class="skolem">I</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Exists<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="skolem">φ</span> <span class="skolem">I</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Exists<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_local<span class="main"><span class="main">]</span></span>
               iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> esat_UNIV_ad_agr_list<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subset_refl<span class="main"><span class="main">]</span></span> x_def<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Inr<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def fun_upd_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k l
          <span class="keyword1"><span class="command">using</span></span> c_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip ad_equiv_pair.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> c_def<span class="main">[</span><span class="operator">unfolded</span> fv_fo_fmla_list_set<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_list_def pairwise_def set_zip <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Forall <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Forall<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span> Forall<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_ad_agr_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">J</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_intp"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="free">φ</span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>map <span class="main">(</span>Inl <span class="main">∘</span> <span class="free">σ</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map <span class="main">(</span>Inl <span class="main">∘</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"act_edom <span class="free">φ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> <span class="main">⟷</span> sat <span class="free">φ</span> <span class="free">I</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> esat_UNIV_ad_agr_list<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> sat_esat_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nfv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nfv</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> length <span class="main">(</span>fv_fo_fmla_list <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfv_card<span class="main">:</span> <span class="quoted"><span class="quoted">"nfv <span class="free">φ</span> <span class="main">=</span> card <span class="main">(</span>fv_fo_fmla <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_distinct_fv_list
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fv_fo_fmla_list_set <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nfv_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rremdups</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rremdups</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rremdups</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">rremdups</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">(≠)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> filter_rremdups_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span>rremdups <span class="main">(</span>filter <span class="free">Q</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  rremdups <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Q</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_rremdups<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span>rremdups <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> rremdups <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> filter_rremdups_filter<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> filter <span class="free">P</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="bound">j</span> <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> filter.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> take_Cons' take_Suc_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> take0 take_Cons'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rremdups_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> rremdups <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="bound">j</span> <span class="main">(</span>rremdups <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_def<span class="main">:</span> <span class="quoted"><span class="quoted">"rremdups <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="skolem">j</span> <span class="main">(</span>rremdups <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> j'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≠)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>rremdups <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      take <span class="skolem">j'</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">(≠)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>rremdups <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> filter_take
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc filter_rremdups<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> j_def j'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Cons'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rremdups_app<span class="main">:</span> <span class="quoted"><span class="quoted">"rremdups <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> rremdups <span class="free">xs</span> <span class="main">@</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> filter.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> filter_append filter_rremdups<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rremdups_set<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>rremdups <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_rremdups<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_rremdups<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>rremdups <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">ys</span><span class="main">.</span> length <span class="main">(</span><span class="bound">ys</span> <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span>rremdups <span class="bound">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons rremdups_set le_imp_less_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_rremdups<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rremdups <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_card<span class="main">[</span><span class="operator">OF</span> distinct_rremdups<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rremdups_set<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_map_filter_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Inr <span class="main">-`</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nats</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nats</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fo_nmlzd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fo_nmlzd</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟷</span> Inl <span class="main">-`</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ns</span> <span class="main">=</span> List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span> nats <span class="main">(</span>rremdups <span class="bound">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlzd_all_AD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> Inl <span class="main">`</span> <span class="free">AD</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_def nats_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_Inr_vimage_le_length<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> List.finite_set card_inj_on_le image_vimage_subset inj_Inr<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_length<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlzd_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∩</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>min <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inr <span class="main">-`</span> set <span class="free">xs</span> <span class="main">=</span> <span class="main">{..&lt;</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def fo_nmlzd_def nats_def length_rremdups set_map_filter_sum rremdups_set
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">set</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∩</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UNIV_I UNIV_sum UnE image_iff subset_iff vimageI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Inr_vimage_le_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> min.absorb2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_filter_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> List.map_filter <span class="free">f</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="bound">j</span> <span class="main">(</span>List.map_filter <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> map_filter_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.case<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> take0 take_Cons'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> map_filter_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_filter_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.case<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> take_Cons' take_Suc_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlzd_take<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="free">xs</span> <span class="main">⟹</span> fo_nmlzd <span class="free">AD</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_def vimage_def nats_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> set_take_subset <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">using</span></span> map_filter_take<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"case_sum Map.empty Some"</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> j
    <span class="keyword1"><span class="command">using</span></span> rremdups_take<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="free">xs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add.left_neutral min.cobounded1 min_def take_all take_upt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_filter_app<span class="main">:</span> <span class="quoted"><span class="quoted">"List.map_filter <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> List.map_filter <span class="free">f</span> <span class="free">xs</span> <span class="main">@</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">f</span> <span class="free">x</span> <span class="keyword1">of</span> Some <span class="bound">y</span> <span class="main">⇒</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlzd_app_Inr<span class="main">:</span> <span class="quoted"><span class="quoted">"Inr <span class="free">n</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟹</span> Inr <span class="free">n'</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟹</span> fo_nmlzd <span class="free">AD</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Inr <span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
  fo_nmlzd <span class="free">AD</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Inr <span class="free">n'</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_simps fo_nmlzd_def nats_def Let_def map_filter_app
      rremdups_app set_map_filter_sum<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">all_tuples</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'c</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all_tuples</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">all_tuples</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">as</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">all_tuples</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nall_tuples</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nall_tuples</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">zs</span></span> <span class="main">∈</span> all_tuples <span class="main">(</span>Inl <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> fo_nmlzd <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="bound">zs</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_tuples_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">xs</span> <span class="main">⟹</span> finite <span class="main">(</span>all_tuples <span class="free">xs</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> all_tuples.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nall_tuples_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">AD</span> <span class="main">⟹</span> finite <span class="main">(</span>nall_tuples <span class="free">AD</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nall_tuples_def all_tuples_finite<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> all_tuplesI<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> set <span class="free">vs</span> <span class="main">⊆</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">vs</span> <span class="main">∈</span> all_tuples <span class="free">xs</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> all_tuples.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xs</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">#</span> <span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ws</span> <span class="main">⊆</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_length_conv contra_subsetD list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> order_trans set_subset_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nall_tuplesI<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> fo_nmlzd <span class="free">AD</span> <span class="free">vs</span> <span class="main">⟹</span> <span class="free">vs</span> <span class="main">∈</span> nall_tuples <span class="free">AD</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlzd_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">vs</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nall_tuples_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> all_tuplesI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> all_tuplesD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">∈</span> all_tuples <span class="free">xs</span> <span class="free">n</span> <span class="main">⟹</span> length <span class="free">vs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> set <span class="free">vs</span> <span class="main">⊆</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> all_tuples.induct<span class="main">)</span> <span class="operator">auto</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_tuples_setD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">∈</span> all_tuples <span class="free">xs</span> <span class="free">n</span> <span class="main">⟹</span> set <span class="free">vs</span> <span class="main">⊆</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> all_tuplesD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nall_tuplesD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">∈</span> nall_tuples <span class="free">AD</span> <span class="free">n</span> <span class="main">⟹</span>
  length <span class="free">vs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> set <span class="free">vs</span> <span class="main">⊆</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> fo_nmlzd <span class="free">AD</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nall_tuples_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> all_tuplesD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> all_tuples_set<span class="main">:</span> <span class="quoted"><span class="quoted">"all_tuples <span class="free">xs</span> <span class="free">n</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> set <span class="bound">ys</span> <span class="main">⊆</span> <span class="free">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> all_tuples.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xs</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subset_antisym<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> all_tuples <span class="skolem">xs</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">∧</span> set <span class="bound">ys</span> <span class="main">⊆</span> <span class="skolem">xs</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">∧</span> set <span class="bound">ys</span> <span class="main">⊆</span> <span class="skolem">xs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> all_tuples <span class="skolem">xs</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> zs_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> all_tuples <span class="skolem">xs</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nall_tuples_set<span class="main">:</span> <span class="quoted"><span class="quoted">"nall_tuples <span class="free">AD</span> <span class="free">n</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> fo_nmlzd <span class="free">AD</span> <span class="bound">ys</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlzd_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span><span class="main">]</span> card_Inr_vimage_le_length
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nall_tuples_def all_tuples_set<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> UnE nall_tuplesD nall_tuplesI subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pos</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pos</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">pos</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">of</span> Some <span class="bound">n</span> <span class="main">⇒</span> Some <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_set<span class="main">:</span> <span class="quoted"><span class="quoted">"pos <span class="free">a</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pos.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_length<span class="main">:</span> <span class="quoted"><span class="quoted">"pos <span class="free">a</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pos.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"pos <span class="free">a</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pos.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"pos <span class="free">a</span> <span class="free">xs</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">a</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pos.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rem_nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rem_nth</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rem_nth</span> <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rem_nth</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">rem_nth</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rem_nth_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="main">(</span>rem_nth <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rem_nth.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rem_nth_take_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> rem_nth <span class="free">i</span> <span class="free">xs</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">xs</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rem_nth.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rem_nth_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> pos <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span>
  rem_nth <span class="free">i</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="free">σ</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pos_set <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> filter_True<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_nth</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_nth</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="keyword1">of</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">#</span> <span class="free">add_nth</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_nth_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">zs</span> <span class="main">⟹</span> length <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">z</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add_nth.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_nth_take_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">zs</span> <span class="main">⟹</span> add_nth <span class="free">i</span> <span class="free">v</span> <span class="free">zs</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">zs</span> <span class="main">@</span> <span class="free">v</span> <span class="main">#</span> drop <span class="free">i</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add_nth.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_nth_rem_nth_map<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> pos <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span>
  add_nth <span class="free">i</span> <span class="free">a</span> <span class="main">(</span>rem_nth <span class="free">i</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pos_set <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_nth_rem_nth_self<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> add_nth <span class="free">i</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>rem_nth <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rem_nth.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rem_nth_add_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">zs</span> <span class="main">⟹</span> rem_nth <span class="free">i</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">z</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add_nth.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">mys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">nxs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nxs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">nxs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">mys</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">nxs</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">mys</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">merge</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">nxs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> merge_Nil2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"merge <span class="free">nxs</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">nxs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">nxs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> merge_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge <span class="free">nxs</span> <span class="free">mys</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>map fst <span class="free">nxs</span> <span class="main">@</span> map fst <span class="free">mys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nxs</span></span> <span class="quoted"><span class="free">mys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> insort_aux_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">nxs</span><span class="main">.</span> <span class="free">n</span> <span class="main">≤</span> fst <span class="bound">x</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">mys</span><span class="main">.</span> <span class="free">m</span> <span class="main">≤</span> fst <span class="bound">x</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span>
  insort <span class="free">n</span> <span class="main">(</span>sort <span class="main">(</span>map fst <span class="free">nxs</span> <span class="main">@</span> <span class="free">m</span> <span class="main">#</span> map fst <span class="free">mys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">#</span> sort <span class="main">(</span>map fst <span class="free">nxs</span> <span class="main">@</span> <span class="free">m</span> <span class="main">#</span> map fst <span class="free">mys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nxs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insort_is_Cons insort_left_comm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insort_aux_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">nxs</span><span class="main">.</span> <span class="free">n</span> <span class="main">≤</span> fst <span class="bound">x</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">mys</span><span class="main">.</span> <span class="free">m</span> <span class="main">≤</span> fst <span class="bound">x</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span>
  insort <span class="free">n</span> <span class="main">(</span>sort <span class="main">(</span>map fst <span class="free">nxs</span> <span class="main">@</span> <span class="free">m</span> <span class="main">#</span> map fst <span class="free">mys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">m</span> <span class="main">#</span> insort <span class="free">n</span> <span class="main">(</span>sort <span class="main">(</span>map fst <span class="free">nxs</span> <span class="main">@</span> map fst <span class="free">mys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nxs</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insort_is_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans insort_key.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insort_left_comm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_fst_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="main">(</span>map fst <span class="free">nxs</span><span class="main">)</span> <span class="main">⟹</span> sorted_distinct <span class="main">(</span>map fst <span class="free">mys</span><span class="main">)</span> <span class="main">⟹</span>
  map fst <span class="main">(</span>merge <span class="free">nxs</span> <span class="free">mys</span><span class="main">)</span> <span class="main">=</span> sort <span class="main">(</span>map fst <span class="free">nxs</span> <span class="main">@</span> map fst <span class="free">mys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nxs</span></span> <span class="quoted"><span class="free">mys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_sort_id insort_is_Cons insort_aux_le insort_aux_gt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> merge_map'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="main">(</span>map fst <span class="free">nxs</span><span class="main">)</span> <span class="main">⟹</span> sorted_distinct <span class="main">(</span>map fst <span class="free">mys</span><span class="main">)</span> <span class="main">⟹</span>
  fst <span class="main">`</span> set <span class="free">nxs</span> <span class="main">∩</span> fst <span class="main">`</span> set <span class="free">mys</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
  map snd <span class="free">nxs</span> <span class="main">=</span> map <span class="free">σ</span> <span class="main">(</span>map fst <span class="free">nxs</span><span class="main">)</span> <span class="main">⟹</span> map snd <span class="free">mys</span> <span class="main">=</span> map <span class="free">σ</span> <span class="main">(</span>map fst <span class="free">mys</span><span class="main">)</span> <span class="main">⟹</span>
  map snd <span class="main">(</span>merge <span class="free">nxs</span> <span class="free">mys</span><span class="main">)</span> <span class="main">=</span> map <span class="free">σ</span> <span class="main">(</span>sort <span class="main">(</span>map fst <span class="free">nxs</span> <span class="main">@</span> map fst <span class="free">mys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nxs</span></span> <span class="quoted"><span class="free">mys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_sort_id insort_is_Cons insort_aux_le insort_aux_gt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> merge_map<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">ns</span> <span class="main">⟹</span> sorted_distinct <span class="free">ms</span> <span class="main">⟹</span> set <span class="free">ns</span> <span class="main">∩</span> set <span class="free">ms</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
  map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">ns</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">ms</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ms</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="free">σ</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">ns</span> <span class="main">@</span> <span class="free">ms</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> merge_map'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"zip <span class="free">ns</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"zip <span class="free">ms</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ms</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> length_map list.set_map map_fst_zip<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fo_nmlz_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat <span class="main">⇀</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fo_nmlz_rec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fo_nmlz_rec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="keyword1">then</span> Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">fo_nmlz_rec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Inr <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free">fo_nmlz_rec</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
    <span class="main">|</span> Some <span class="bound">j</span> <span class="main">⇒</span> Inr <span class="bound">j</span> <span class="main">#</span> <span class="free">fo_nmlz_rec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fo_nmlz_rec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span>
    Inr <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free">fo_nmlz_rec</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
  <span class="main">|</span> Some <span class="bound">j</span> <span class="main">⇒</span> Inr <span class="bound">j</span> <span class="main">#</span> <span class="free">fo_nmlz_rec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_rec_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"ran <span class="free">m</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⟹</span> filter <span class="main">(</span><span class="main">(≤)</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>rremdups
  <span class="main">(</span>List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="main">(</span>fo_nmlz_rec <span class="free">i</span> <span class="free">m</span> <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">ns</span> <span class="main">⟹</span>
  <span class="free">ns</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">i</span> <span class="main">+</span> length <span class="free">ns</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fo_nmlz_rec.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">AD</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span>Inl <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">have</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"ran <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>Suc <span class="skolem">i</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>4<span class="main">)</span> None
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def dom_def ran_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> filter <span class="main">(</span><span class="main">(≤)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rremdups
        <span class="main">(</span>List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="main">(</span>fo_nmlz_rec <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">AD</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>5<span class="main">)</span> False None
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_simps filter_rremdups<span class="main">)</span>
           <span class="main">(</span><span class="operator">metis</span> Suc_leD antisym not_less_eq_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> False None pred<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">smt</span> Suc_le_eq Suc_pred le_add1 le_zero_eq less_add_same_cancel1 not_less_eq_eq
            upt_Suc_append upt_rec<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_lt_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ns_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">(≤)</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>rremdups
        <span class="main">(</span>List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="main">(</span>fo_nmlz_rec <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>5<span class="main">)</span> False Some j_lt_i
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_simps filter_rremdups<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> leD<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> False Some 2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> ns_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span> <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span>Inr <span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">have</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"ran <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inr <span class="skolem">n</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>Suc <span class="skolem">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span> None
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def dom_def ran_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> filter <span class="main">(</span><span class="main">(≤)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rremdups
      <span class="main">(</span>List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="main">(</span>fo_nmlz_rec <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inr <span class="skolem">n</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">AD</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span> None
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_simps filter_rremdups<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Suc_leD antisym not_less_eq_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> None pred<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">smt</span> Suc_le_eq Suc_pred le_add1 le_zero_eq less_add_same_cancel1 not_less_eq_eq
          upt_Suc_append upt_rec<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_lt_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ns_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">(≤)</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>rremdups
      <span class="main">(</span>List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="main">(</span>fo_nmlz_rec <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span> Some j_lt_i
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_simps filter_rremdups<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> leD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 3<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> Some 3<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ns_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_simps<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">id_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat <span class="main">⇀</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">id_map</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> None <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> Some <span class="bound">x</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_rec_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> set <span class="free">ys</span> <span class="main">⊆</span> <span class="free">AD</span> <span class="main">⟹</span>
  rremdups <span class="main">(</span>List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">ns</span> <span class="main">⟹</span>
  set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">)</span> <span class="free">ns</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⟹</span> filter <span class="main">(</span><span class="main">(≤)</span> <span class="free">i</span><span class="main">)</span> <span class="free">ns</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">i</span> <span class="main">+</span> <span class="free">k</span><span class="main">]</span> <span class="main">⟹</span>
  fo_nmlz_rec <span class="free">i</span> <span class="main">(</span>id_map <span class="free">i</span><span class="main">)</span> <span class="free">AD</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">ns</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ _ Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> Cons<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inl List.map_filter_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> j_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False Cons<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr List.map_filter_simps filter_rremdups in_mono <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
           <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> upt_eq_Cons_conv<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">kk</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">kk</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr List.map_filter_simps j_i<span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ns'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns'</span> <span class="main">=</span> rremdups <span class="main">(</span>List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> id_map_None<span class="main">:</span> <span class="quoted"><span class="quoted">"id_map <span class="skolem">i</span> <span class="main">(</span>Inr <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> id_map_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"id_map <span class="skolem">i</span><span class="main">(</span>Inr <span class="skolem">i</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> id_map <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>Suc <span class="skolem">i</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≤)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ns'</span> <span class="main">=</span> <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr List.map_filter_simps j_i filter_rremdups<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ns'_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">smt</span> One_nat_def Suc_eq_plus1 Suc_le_eq add_diff_cancel_left' diff_is_0_eq'
            dual_order.order_iff_strict filter_cong n_not_Suc_n upt_eq_Cons_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> set <span class="skolem">ys</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>id_map <span class="skolem">i</span><span class="main">)</span><span class="main">(</span>Inr <span class="skolem">i</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">AD</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ ns'_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="skolem">kk</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns'_def k_def id_map_upd <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr j_i id_map_None<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ns'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns'</span> <span class="main">=</span> rremdups <span class="main">(</span>List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≤)</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ns'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">(≤)</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ns</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr List.map_filter_simps filter_rremdups<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ns'_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">smt</span> filter_cong leD<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">i</span> <span class="main">(</span>id_map <span class="skolem">i</span><span class="main">)</span> <span class="free">AD</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ ns'_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> Cons<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> Cons<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr id_map_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_rec_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fo_nmlz_rec <span class="free">i</span> <span class="free">m</span> <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fo_nmlz_rec.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_Inr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> insert <span class="main">(</span>Inr <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="bound">X</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_rec_set<span class="main">:</span> <span class="quoted"><span class="quoted">"ran <span class="free">m</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⟹</span> set <span class="main">(</span>fo_nmlz_rec <span class="free">i</span> <span class="free">m</span> <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span>
  set <span class="free">xs</span> <span class="main">∩</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">i</span> <span class="main">+</span> card <span class="main">(</span>set <span class="free">xs</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">-</span> dom <span class="free">m</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fo_nmlz_rec.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ 2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">AD</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True 2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span>Inl <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">have</span></span> pred<span class="main">:</span> <span class="quoted"><span class="quoted">"ran <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>Suc <span class="skolem">i</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>4<span class="main">)</span> None
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def dom_def ran_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="skolem">m</span> <span class="main">=</span>
        <span class="main">{</span>Inl <span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> None False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">+</span> card <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="skolem">i</span> <span class="main">+</span> card <span class="main">(</span>set <span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> None
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False None pred<span class="main">]</span> False None
        <span class="keyword1"><span class="command">unfolding</span></span> Suc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> insert_Inr<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_lt_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Some <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">card</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False Some 2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> False Some j_lt_i
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span> <span class="skolem">k</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span>Inr <span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"ran <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inr <span class="skolem">k</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>Suc <span class="skolem">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>Inr <span class="skolem">k</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="skolem">m</span> <span class="main">=</span>
      <span class="main">{</span>Inr <span class="skolem">k</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inr <span class="skolem">k</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> None
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">+</span> card <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inr <span class="skolem">k</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="skolem">i</span> <span class="main">+</span> card <span class="main">(</span>set <span class="main">(</span>Inr <span class="skolem">k</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> None
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> None 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> None preds<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> Suc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> insert_Inr<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">(</span>Inr <span class="skolem">k</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> card_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="skolem">xs</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>set <span class="main">(</span>Inr <span class="skolem">k</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="skolem">AD</span> <span class="main">-</span> dom <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Some <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">card</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> j_lt_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span> Some
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some 3<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> j_lt_i
      <span class="keyword1"><span class="command">unfolding</span></span> card_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def insert_Inr Some<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_rec_set_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fo_nmlz_rec <span class="free">i</span> <span class="free">m</span> <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">⊆</span> Inl <span class="main">`</span> <span class="free">AD</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fo_nmlz_rec.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_rec_map<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">m</span> <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> ran <span class="free">m</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">m'</span><span class="main">.</span> inj_on <span class="bound">m'</span> <span class="main">(</span>dom <span class="bound">m'</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">m</span> <span class="bound">n</span> <span class="main">≠</span> None <span class="main">⟶</span> <span class="bound">m'</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">m</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="main">(</span>fo_nmlz_rec <span class="free">i</span> <span class="free">m</span> <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">x'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">AD</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">m'</span> <span class="main">(</span>Inl <span class="bound">x'</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">=</span> Inr <span class="bound">j</span>
    <span class="main">|</span> Inr <span class="bound">n</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">m'</span> <span class="main">(</span>Inr <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">=</span> Inr <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fo_nmlz_rec.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ 2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">AD</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span>Inl <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dom <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ran <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inl <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>Suc <span class="skolem">i</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def ran_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False None preds<span class="main">]</span> False None
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> m'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">m'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False Some 2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> False Some
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> m'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">m'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span> <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span>Inr <span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inr <span class="skolem">n</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dom <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inr <span class="skolem">n</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ran <span class="main">(</span><span class="skolem">m</span><span class="main">(</span>Inr <span class="skolem">n</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>Suc <span class="skolem">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def ran_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> None preds<span class="main">]</span> None
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> m'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">m'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some 3<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> Some
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> m'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">m'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_map<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">⟹</span> inj_on <span class="free">m</span> <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">x'</span> <span class="main">⇒</span>
    <span class="keyword1">if</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">AD</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="free">m</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">y</span> <span class="keyword1">of</span> Inl <span class="bound">z</span> <span class="main">⇒</span> <span class="bound">z</span> <span class="main">∉</span> <span class="free">AD</span> <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>
  <span class="main">|</span> Inr <span class="bound">n</span> <span class="main">⇒</span> <span class="free">m</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">y</span> <span class="keyword1">of</span> Inl <span class="bound">z</span> <span class="main">⇒</span> <span class="bound">z</span> <span class="main">∉</span> <span class="free">AD</span> <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  ad_agr_list <span class="free">AD</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> a b
    <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
    <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_list_def pairwise_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> a b c
    <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> prems<span class="main">(</span>2<span class="main">,</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_splits<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> domI inj_onD prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> a b c
    <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> prems<span class="main">(</span>2<span class="main">,</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_rec_take<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="main">(</span>fo_nmlz_rec <span class="free">i</span> <span class="free">m</span> <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> fo_nmlz_rec <span class="free">i</span> <span class="free">m</span> <span class="free">AD</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fo_nmlz_rec.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fo_nmlz</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fo_nmlz</span> <span class="main">=</span> fo_nmlz_rec <span class="main">0</span> Map.empty"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">AD</span> <span class="keyword1">then</span> <span class="main">[</span>Inl <span class="bound">x</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[</span>Inr <span class="main">0</span><span class="main">]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">[</span>Inr <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_Cons_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">AD</span> <span class="keyword1">then</span> <span class="main">[</span>Inl <span class="bound">x</span><span class="main">,</span> Inl <span class="bound">x</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[</span>Inr <span class="main">0</span><span class="main">,</span> Inr <span class="main">0</span><span class="main">]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">[</span>Inr <span class="main">0</span><span class="main">,</span> Inr <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlz_rec_sound<span class="main">[</span><span class="operator">of</span> <span class="quoted">Map.empty</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> fo_nmlz_rec_set<span class="main">[</span><span class="operator">of</span> <span class="quoted">Map.empty</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_def fo_nmlz_def nats_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlz_rec_length
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">=</span> map <span class="bound">τ</span> <span class="free">ns</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">x'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">AD</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">m'</span> <span class="main">(</span>Inl <span class="bound">x'</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">=</span> Inr <span class="bound">j</span>
    <span class="main">|</span> Inr <span class="bound">n</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">m'</span> <span class="main">(</span>Inr <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">=</span> Inr <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_rec_map<span class="main">[</span><span class="operator">of</span> <span class="quoted">Map.empty</span> <span class="quoted"><span class="main">0</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"map <span class="free">σ</span> <span class="free">ns</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free">σ</span> <span class="bound">n</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">AD</span> <span class="keyword1">then</span> Inl <span class="bound">x</span> <span class="keyword1">else</span> Inr <span class="main">(</span>the <span class="main">(</span><span class="skolem">m'</span> <span class="main">(</span>Inl <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Inr <span class="bound">j</span> <span class="main">⇒</span> Inr <span class="main">(</span>the <span class="main">(</span><span class="skolem">m'</span> <span class="main">(</span>Inr <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>map <span class="skolem">τ</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fo_nmlz_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="quoted">"map <span class="free">σ</span> <span class="free">ns</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m'_def fo_nmlz_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="quoted">"map <span class="free">σ</span> <span class="free">ns</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip τ_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> nth_map<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> nth_map option.sel<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_set_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="free">xs</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Diff_subset List.finite_set card_length card_mono order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_set<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
  set <span class="free">xs</span> <span class="main">∩</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>min <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>card <span class="main">(</span>set <span class="free">xs</span> <span class="main">-</span> Inl <span class="main">`</span> <span class="free">AD</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlz_rec_set<span class="main">[</span><span class="operator">of</span> <span class="quoted">Map.empty</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fo_nmlz_def card_set_minus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_set_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">⊆</span> Inl <span class="main">`</span> <span class="free">AD</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlz_rec_set_rev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted">Map.empty</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="free">xs</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fo_nmlz_def
  <span class="keyword1"><span class="command">using</span></span> fo_nmlz_rec_map<span class="main">[</span><span class="operator">of</span> <span class="quoted">Map.empty</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">AD</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> m'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_rec_length<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"map_option Inr <span class="main"><span class="main">∘</span></span> <span class="skolem"><span class="skolem">m'</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span> <span class="quoted"><span class="quoted">Map.empty</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">AD</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">AD</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def dom_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlzd_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">AD</span> <span class="main">⟹</span> fo_nmlzd <span class="free">AD'</span> <span class="free">xs</span> <span class="main">⟹</span> fo_nmlzd <span class="free">AD</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="free">ys</span> <span class="main">⟹</span> fo_nmlz <span class="free">AD</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlz_rec_idem<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?i</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_def fo_nmlz_def id_map_def nats_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_take<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlz_rec_take
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nall_tuples_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nall_tuples_rec</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nall_tuples_rec</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">as</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>Inl <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span>
    <span class="free">nall_tuples_rec</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">λ</span><span class="bound">as</span><span class="main">.</span> Inr <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="bound">as</span><span class="main">)</span> <span class="main">`</span> <span class="free">nall_tuples_rec</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nall_tuples_rec_Inl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="free">i</span> <span class="free">n</span> <span class="main">⟹</span> Inl <span class="main">-`</span> set <span class="free">vs</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nall_tuples_rec.induct<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nall_tuples_rec_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="free">i</span> <span class="free">n</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nall_tuples_rec.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_upd_id_map<span class="main">:</span> <span class="quoted"><span class="quoted">"id_map <span class="free">i</span><span class="main">(</span>Inr <span class="free">i</span> <span class="main">↦</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> id_map <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> id_mapD<span class="main">:</span> <span class="quoted"><span class="quoted">"id_map <span class="free">j</span> <span class="main">(</span>Inr <span class="free">i</span><span class="main">)</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"id_map <span class="free">j</span> <span class="main">(</span>Inr <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nall_tuples_rec_fo_nmlz_rec_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="free">i</span> <span class="free">n</span> <span class="main">⟹</span>
  fo_nmlz_rec <span class="free">j</span> <span class="main">(</span>id_map <span class="free">j</span><span class="main">)</span> <span class="free">AD</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_id_map <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> id_mapD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.strict_trans2 id_mapD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_Some_eq sup.strict_order_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Suc_leI <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nall_tuples_rec_fo_nmlz_rec_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="free">j</span> <span class="main">(</span>id_map <span class="free">j</span><span class="main">)</span> <span class="free">AD</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="free">j</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> a_AD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">AD</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inl <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons a_AD
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> b_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> id_mapD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>id_map <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">AD</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr True fun_upd_id_map <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> id_mapD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> preds<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr True<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> b_lt_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> b_j False
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> id_map<span class="main">:</span> <span class="quoted"><span class="quoted">"id_map <span class="skolem">j</span> <span class="main">(</span>Inr <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> b_lt_j
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">j</span> <span class="main">(</span>id_map <span class="skolem">j</span><span class="main">)</span> <span class="free">AD</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr id_map<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> preds<span class="main">]</span> b_lt_j
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nall_tuples_rec_fo_nmlz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="main">0</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> fo_nmlz <span class="free">AD</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nall_tuples_rec_fo_nmlz_rec_sound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span>"</span></span><span class="main">]</span>
    nall_tuples_rec_fo_nmlz_rec_complete<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_def id_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlzd_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="free">xs</span> <span class="main">⟷</span> fo_nmlz <span class="free">AD</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlz_idem fo_nmlz_sound
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> nall_tuples_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nall_tuples <span class="free">AD</span> <span class="free">n</span> <span class="main">=</span> nall_tuples_rec <span class="free">AD</span> <span class="main">0</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nall_tuples_set
  <span class="keyword1"><span class="command">using</span></span> nall_tuples_rec_length trans<span class="main">[</span><span class="operator">OF</span> nall_tuples_rec_fo_nmlz fo_nmlzd_code<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> exists_map<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">⟹</span> distinct <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> map <span class="bound">f</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> map <span class="skolem">f</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">=</span> map <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> exists_fo_nmlzd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="bound">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlz_idem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> exists_map<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> list_induct2_rev<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_fo_nmlzd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="free">vs</span> <span class="free">vs'</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="free">vs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">=</span> <span class="free">vs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ad_agr_list_length<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">vs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2_rev<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> norms<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_def nats_def Let_def map_filter_app rremdups_app
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def sp_equiv_list_def pairwise_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> xs_ys <span class="main">=</span> 2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ad_agr norms<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"isl <span class="skolem">x</span> <span class="main">∨</span> isl <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isl <span class="skolem">x</span> <span class="main">⟶</span> projl <span class="skolem">x</span> <span class="main">∈</span> <span class="free">AD</span>"</span></span> <span class="quoted"><span class="quoted">"isl <span class="skolem">y</span> <span class="main">⟶</span> projl <span class="skolem">y</span> <span class="main">∈</span> <span class="free">AD</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> True
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def isl_def<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> inr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Inr <span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> Inr <span class="skolem">y'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> xs_ys
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> fo_nmlzd_app_Inr 2<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> inr xs_ys
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def sp_equiv_list_def pairwise_def set_zip in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_ys
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="free">vs</span> <span class="free">vs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">vs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="free">vs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ad_agr_list_fo_nmlzd<span class="main">[</span><span class="operator">OF</span>
        ad_agr_list_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ad_agr_list_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span>
        ad_agr_list_comm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_ad_agr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">vs</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">]</span></span>
        fo_nmlz_ad_agr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">vs'</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> fo_nmlz_sound fo_nmlz_sound<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">vs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="free">vs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="free">vs</span> <span class="free">vs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ad_agr_list_trans<span class="main">[</span><span class="operator">OF</span> fo_nmlz_ad_agr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">vs</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> assms<span class="main"><span class="main">]</span></span>
        ad_agr_list_comm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_ad_agr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">vs'</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">AD</span> <span class="main">⊆</span> <span class="free">AD'</span>"</span></span> <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD'</span> <span class="free">xs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">(</span>fo_nmlz <span class="free">AD'</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> fo_nmlz <span class="free">AD'</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_idem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlzd_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fo_nmlz_sound<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_set<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">xs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>fo_nmlz <span class="free">AD'</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_list_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_ad_agr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">proj_vals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> val set <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'c</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proj_vals</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">τ</span><span class="main">.</span> map <span class="bound">τ</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">proj_fmla</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> <span class="tfree">'c</span> val set <span class="main">⇒</span> <span class="tfree">'c</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proj_fmla</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> proj_vals <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>fv_fo_fmla_list <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> proj_fmla_map <span class="main">=</span> proj_fmla_def<span class="main">[</span><span class="operator">unfolded</span> proj_vals_def<span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">extends_subst</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">x</span> <span class="main">≠</span> None <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ext_tuple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> nat list <span class="main">⇒</span> nat list <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ext_tuple</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">fv_sub</span></span></span> <span class="free"><span class="bound"><span class="entity">fv_sub_comp</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">fv_sub_comp</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">}</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fs</span><span class="main">.</span> map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">fv_sub</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">fv_sub_comp</span></span></span> <span class="bound">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span>
    <span class="main">(</span>nall_tuples_rec <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">fv_sub_comp</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ext_tuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fv_sub</span> <span class="main">=</span> length <span class="free">as</span> <span class="main">⟹</span>
  ext_tuple <span class="free">AD</span> <span class="free">fv_sub</span> <span class="free">fv_sub_comp</span> <span class="free">as</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">fs</span><span class="main">.</span> map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">fv_sub</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">fv_sub_comp</span> <span class="bound">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span>
  <span class="main">(</span>nall_tuples_rec <span class="free">AD</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">fv_sub_comp</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlz_idem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ext_tuple_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_map_of<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">⟹</span> distinct <span class="free">xs</span> <span class="main">⟹</span>
  <span class="free">ys</span> <span class="main">=</span> map <span class="main">(</span>the <span class="main">∘</span> <span class="main">(</span>map_of <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_comp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> id_map_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"id_map <span class="main">0</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_rec_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="free">i</span> <span class="main">(</span>id_map <span class="free">i</span><span class="main">)</span> <span class="free">AD</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">⟹</span>
  <span class="free">i'</span> <span class="main">=</span> card <span class="main">(</span>Inr <span class="main">-`</span> <span class="main">(</span>Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span>
  fo_nmlz_rec <span class="free">i'</span> <span class="main">(</span>id_map <span class="free">i'</span><span class="main">)</span> <span class="free">AD</span> <span class="main">(</span>drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> drop <span class="free">n</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"id_map <span class="free">i</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">+</span> nat <span class="main">⇀</span> nat"</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fo_nmlz_rec.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">AD</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">AD</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">i</span> <span class="main">(</span>id_map <span class="skolem">i</span><span class="main">)</span> <span class="skolem">AD</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> k_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> i'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">=</span> card <span class="main">(</span>Inr <span class="main">-`</span> <span class="main">(</span>Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>take <span class="skolem">k</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc vimage_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> preds i'_def k_le<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_vimage_image_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i</span> <span class="skolem">AD</span> <span class="skolem">j</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> k_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> j_le_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> id_mapD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> id_map<span class="main">:</span> <span class="quoted"><span class="quoted">"id_map <span class="skolem">i</span> <span class="main">(</span>Inr <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"id_map <span class="skolem">i</span><span class="main">(</span>Inr <span class="skolem">j</span> <span class="main">↦</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> id_map <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> True fun_upd_id_map
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> norm_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>id_map <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">AD</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> id_mapD<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> i'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">=</span> card <span class="main">(</span>Inr <span class="main">-`</span> <span class="main">(</span>Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="skolem">i</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>take <span class="skolem">k</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc True inj_vimage_image_eq<span class="main">)</span>
           <span class="main">(</span><span class="operator">metis</span> Un_insert_left image_insert inj_Inr inj_vimage_image_eq lessThan_Suc vimage_Un<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> id_map norm_xs i'_def k_le<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> id_map<span class="main">:</span> <span class="quoted"><span class="quoted">"id_map <span class="skolem">i</span> <span class="main">(</span>Inr <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> j_le_i False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> norm_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">i</span> <span class="main">(</span>id_map <span class="skolem">i</span><span class="main">)</span> <span class="skolem">AD</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> i'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">=</span> card <span class="main">(</span>Inr <span class="main">-`</span> <span class="main">(</span>Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>take <span class="skolem">k</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span> j_le_i False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc inj_vimage_image_eq insert_absorb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> id_map norm_xs i'_def k_le<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_vimage_image_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">proj_tuple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proj_tuple</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">mys</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">proj_tuple</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">proj_tuple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">mys</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free">proj_tuple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mys</span></span></span> <span class="keyword1">else</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">proj_tuple</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">mys</span></span></span>
    <span class="keyword1">else</span> <span class="free">proj_tuple</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">mys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_tuple_idle<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_tuple <span class="main">(</span>map fst <span class="free">nxs</span><span class="main">)</span> <span class="free">nxs</span> <span class="main">=</span> map snd <span class="free">nxs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nxs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> proj_tuple_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="main">(</span>map fst <span class="free">nxs</span><span class="main">)</span> <span class="main">⟹</span> sorted_distinct <span class="main">(</span>map fst <span class="free">mys</span><span class="main">)</span> <span class="main">⟹</span>
  set <span class="main">(</span>map fst <span class="free">nxs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>map fst <span class="free">mys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
  proj_tuple <span class="main">(</span>map fst <span class="free">nxs</span><span class="main">)</span> <span class="main">(</span>merge <span class="free">nxs</span> <span class="free">mys</span><span class="main">)</span> <span class="main">=</span> map snd <span class="free">nxs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proj_tuple_idle
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nxs</span></span> <span class="quoted"><span class="free">mys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">auto</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_tuple_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">ms</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ns</span> <span class="main">⊆</span> set <span class="free">ms</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">ms</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ms</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="free">σ</span> <span class="free">ns</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ns'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">ns</span><span class="main">)</span> <span class="free">ms</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> sd_ns'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="skolem">ns'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> sorted_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ns</span> <span class="main">∩</span> set <span class="skolem">ns'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ms_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ms</span> <span class="main">=</span> sort <span class="main">(</span><span class="free">ns</span> <span class="main">@</span> <span class="skolem">ns'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_distinct_set_unique<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> zip<span class="main">:</span> <span class="quoted"><span class="quoted">"zip <span class="free">ms</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ms</span><span class="main">)</span> <span class="main">=</span> merge <span class="main">(</span>zip <span class="free">ns</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">ns'</span> <span class="main">(</span>map <span class="free">σ</span> <span class="skolem">ns'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> merge_map<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sd_ns' disj<span class="main">,</span> <span class="operator">folded</span> ms_def<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> map_fst_merge assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ms_def<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> length_map map_fst_merge map_fst_zip sd_ns' zip_map_fst_snd<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zip
    <span class="keyword1"><span class="command">using</span></span> proj_tuple_merge
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> disj length_map map_fst_zip map_snd_zip sd_ns'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ext_tuple_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_sub</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_sub_comp</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_all</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="free">fv_sub</span> <span class="main">∩</span> set <span class="free">fv_sub_comp</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fv_sub</span> <span class="main">∪</span> set <span class="free">fv_sub_comp</span> <span class="main">=</span> set <span class="free">fv_all</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ass</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">R</span> <span class="free">fv_sub</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> ad_agr_sets <span class="main">(</span>set <span class="free">fv_sub</span><span class="main">)</span> <span class="main">(</span>set <span class="free">fv_sub</span><span class="main">)</span> <span class="free">AD</span> <span class="bound">σ</span> <span class="bound">τ</span> <span class="main">⟹</span> <span class="bound">σ</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟷</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>ext_tuple <span class="free">AD</span> <span class="free">fv_sub</span> <span class="free">fv_sub_comp</span> <span class="main">`</span> <span class="free">ass</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">(</span>proj_tuple <span class="free">fv_sub</span> <span class="main">(</span>zip <span class="free">fv_all</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ass</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">R</span> <span class="free">fv_all</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fv_all_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fv_all</span> <span class="main">=</span> sort <span class="main">(</span><span class="free">fv_sub</span> <span class="main">@</span> <span class="free">fv_sub_comp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_distinct_set_unique<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_in_ass<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">ass</span> <span class="main">⟹</span> <span class="bound">xs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="bound">xs</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> length <span class="free">fv_sub</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> proj_vals_def fo_nmlz_length fo_nmlz_idem fo_nmlz_sound<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> as_fs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">ass</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="skolem">as</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">fv_sub_comp</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">fv_sub</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">fv_sub_comp</span> <span class="skolem">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_sound len_in_ass assms<span class="main">(</span>8<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ext_tuple_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vs_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_sound
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="free">fv_sub</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as_fs_def<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_vals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="free">fv_sub</span>"</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="free">fv_sub</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">τ</span> <span class="free">fv_sub</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_map fo_nmlz_ad_agr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> τ_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">)</span> ad_agr_list_link σ_def<span class="main">(</span>1<span class="main">)</span> τ_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free">fv_sub_comp</span> <span class="keyword1">then</span> the <span class="main">(</span>map_of <span class="main">(</span>zip <span class="free">fv_sub_comp</span> <span class="skolem">fs</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="skolem">τ</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> set <span class="free">fv_sub</span><span class="main">.</span> <span class="skolem">τ</span> <span class="bound">n</span> <span class="main">=</span> <span class="skolem">σ'</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> σ'_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">)</span> τ_R
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def sp_equiv_def pairwise_def ad_equiv_pair.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> length_as<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> length <span class="free">fv_sub</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as_fs_def<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_vals_def fo_nmlz_length<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> length_fs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">fs</span> <span class="main">=</span> length <span class="free">fv_sub_comp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as_fs_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nall_tuples_rec_length<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> map_fv_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="skolem">σ'</span> <span class="free">fv_sub</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="free">fv_sub</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> τ_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fs_map_map_of<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> map <span class="main">(</span>the <span class="main">∘</span> <span class="main">(</span>map_of <span class="main">(</span>zip <span class="free">fv_sub_comp</span> <span class="skolem">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">fv_sub_comp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_map_of length_fs assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> fs_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> map <span class="skolem">σ'</span> <span class="free">fv_sub_comp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> σ'_def length_fs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fs_map_map_of<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> vs_map_fv_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">σ'</span> <span class="free">fv_all</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> as_fs_def<span class="main">(</span>3<span class="main">)</span> τ_def<span class="main">(</span>1<span class="main">)</span> map_fv_sub<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> fs_map fv_all_sort
    <span class="keyword1"><span class="command">using</span></span> merge_map<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">R</span> <span class="free">fv_all</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> σ'_S vs_map_fv_all
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_vals_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map <span class="skolem">σ''</span> <span class="free">fv_all</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">fv_all</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> fo_nmlz_map vs_map_fv_all
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> proj<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">fv_sub</span> <span class="main">(</span>zip <span class="free">fv_all</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">σ''</span> <span class="free">fv_sub</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proj_tuple_map assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> σ''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> σ''_σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">σ''</span> <span class="free">fv_sub</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> σ''_def vs_map_fv_all σ_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> τ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ad_agr_list_subset assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> fo_nmlz_ad_agr fo_nmlz_eqI map_fv_sub sup_ge1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">(</span>proj_tuple <span class="free">fv_sub</span> <span class="main">(</span>zip <span class="free">fv_all</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ass</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> proj σ''_σ' map_fv_sub
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> as_fs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ext_tuple_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_sub</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_sub_comp</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_all</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="free">fv_sub</span> <span class="main">∩</span> set <span class="free">fv_sub_comp</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fv_sub</span> <span class="main">∪</span> set <span class="free">fv_sub_comp</span> <span class="main">=</span> set <span class="free">fv_all</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ass</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">R</span> <span class="free">fv_sub</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> ad_agr_sets <span class="main">(</span>set <span class="free">fv_sub</span><span class="main">)</span> <span class="main">(</span>set <span class="free">fv_sub</span><span class="main">)</span> <span class="free">AD</span> <span class="bound">σ</span> <span class="bound">τ</span> <span class="main">⟹</span> <span class="bound">σ</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟷</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">fv_all</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>ext_tuple <span class="free">AD</span> <span class="free">fv_sub</span> <span class="free">fv_sub_comp</span> <span class="main">`</span> <span class="free">ass</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fv_all_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fv_all</span> <span class="main">=</span> sort <span class="main">(</span><span class="free">fv_sub</span> <span class="main">@</span> <span class="free">fv_sub_comp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_distinct_set_unique<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> σ_def <span class="main">=</span> assms<span class="main">(</span>9<span class="main">,</span>8<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vs_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> σ_def<span class="main">(</span>2<span class="main">)</span> fo_nmlz_sound
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> map <span class="free">σ</span> <span class="free">fv_sub_comp</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> map <span class="free">σ</span> <span class="free">fv_sub</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nos</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">fs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">as'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as'</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">fv_sub</span><span class="main">)</span> <span class="skolem">nos</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fs'</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="free">fv_sub</span><span class="main">)</span> <span class="skolem">nos</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> length_as'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">as'</span> <span class="main">=</span> length <span class="free">fv_sub</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> as'_def nos_def as_def fo_nmlz_length<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> length_fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">fs'</span> <span class="main">=</span> length <span class="free">fv_sub_comp</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs'_def nos_def as_def fs_def fo_nmlz_length<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_fv_sub_nos<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fv_sub</span> <span class="main">≤</span> length <span class="skolem">nos</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nos_def fo_nmlz_length as_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> norm_as'<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="skolem">as'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlzd_take<span class="main">[</span><span class="operator">OF</span> fo_nmlz_sound<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> as'_def nos_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> as'_norm_as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as'</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="skolem">as</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> as'_def nos_def as_def fo_nmlz_take<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ad_agr_as'<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="skolem">as</span> <span class="skolem">as'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_ad_agr
    <span class="keyword1"><span class="command">unfolding</span></span> as'_norm_as <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> nos_as'_fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nos</span> <span class="main">=</span> <span class="skolem">as'</span> <span class="main">@</span> <span class="skolem">fs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_as' length_fs'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> as'_def fs'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as'</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="free">fv_sub</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fs'</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="free">fv_sub_comp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">fv_sub</span> <span class="main">@</span> <span class="free">fv_sub_comp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as'</span> <span class="main">@</span> <span class="skolem">fs'</span>"</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> length_as' length_fs'
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">fv_sub</span> <span class="main">+</span> length <span class="free">fv_sub_comp</span> <span class="main">≤</span> length <span class="free">fv_all</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_append distinct_card eq_iff length_append set_append<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nos_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">nos</span> <span class="main">⊆</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>length <span class="free">fv_all</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">@</span> <span class="skolem">fs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nos_def as_def fs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">fs'</span> <span class="main">=</span> length <span class="free">fv_sub_comp</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fs'_def nos_def fo_nmlz_length as_def fs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> norm_nos_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="main">0</span> <span class="main">(</span>id_map <span class="main">0</span><span class="main">)</span> <span class="free">AD</span> <span class="skolem">nos</span> <span class="main">=</span> <span class="skolem">nos</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_idem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="skolem">nos</span></span><span class="main">]</span> fo_nmlz_sound
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nos_def fo_nmlz_def id_map_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fs'_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs'</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="skolem">as'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">fv_sub_comp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> len_fs'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nall_tuples_rec_fo_nmlz_rec_complete<span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> fo_nmlz_rec_shift<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm_nos_idem<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl len_fv_sub_nos<span class="main"><span class="main">,</span></span>
          <span class="operator">folded</span> as'_def fs'_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as'</span> <span class="main">∈</span> nall_tuples <span class="free">AD</span> <span class="main">(</span>length <span class="free">fv_sub</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_as'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nall_tuplesI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> norm_as' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> as'_ass<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as'</span> <span class="main">∈</span> <span class="free">ass</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as'_norm_as σ_def<span class="main">(</span>1<span class="main">)</span> as_def
    <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_vals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vs_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">fv_sub</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">fv_sub_comp</span> <span class="skolem">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> σ_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge_map as_def fs_def fv_all_sort<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_sort'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>sort <span class="main">(</span><span class="free">fv_sub</span> <span class="main">@</span> <span class="free">fv_sub_comp</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">fv_sub</span> <span class="main">@</span> <span class="free">fv_sub_comp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">fv_sub</span> <span class="skolem">as'</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">fv_sub_comp</span> <span class="skolem">fs'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vs_norm as_def fs_def τ_def
      merge_map<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_list_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> equalityD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> set_sort'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_ad_agr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">@</span> <span class="skolem">fs</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> nos_def<span class="main">,</span> <span class="operator">unfolded</span> nos_as'_fs'<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> as_def fs_def τ_def map_append<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> as'_ass fs'_all
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ext_tuple_def length_as'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ext_tuple_set</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">ns'</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ns'</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">else</span> fo_nmlz <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>ext_tuple <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">ns'</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ext_tuple_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_sub</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_sub_comp</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_all</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="free">fv_sub</span> <span class="main">∩</span> set <span class="free">fv_sub_comp</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fv_sub</span> <span class="main">∪</span> set <span class="free">fv_sub_comp</span> <span class="main">=</span> set <span class="free">fv_all</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ass</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">R</span> <span class="free">fv_sub</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> ad_agr_sets <span class="main">(</span>set <span class="free">fv_sub</span><span class="main">)</span> <span class="main">(</span>set <span class="free">fv_sub</span><span class="main">)</span> <span class="free">AD</span> <span class="bound">σ</span> <span class="bound">τ</span> <span class="main">⟹</span> <span class="bound">σ</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟷</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ext_tuple_set <span class="free">AD</span> <span class="free">fv_sub</span> <span class="free">fv_sub_comp</span> <span class="free">ass</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">R</span> <span class="free">fv_all</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> xs_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> ext_tuple_set <span class="free">AD</span> <span class="free">fv_sub</span> <span class="free">fv_sub_comp</span> <span class="free">ass</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">R</span> <span class="free">fv_all</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ext_tuple_sound<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> xs_in
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ext_tuple_set_def ext_tuple_def assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> fo_nmlz_idem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_sound<span class="main"><span class="main">]</span></span> image_iff
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">R</span> <span class="free">fv_all</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="free">fv_all</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_vals_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> ext_tuple_set <span class="free">AD</span> <span class="free">fv_sub</span> <span class="free">fv_sub_comp</span> <span class="free">ass</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ext_tuple_complete<span class="main">[</span><span class="operator">OF</span> assms σ_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ext_tuple_set_def ext_tuple_def assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> fo_nmlz_idem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_sound<span class="main"><span class="main">]</span></span> image_iff
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_tuple_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_sub</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_sub_comp</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_all</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="free">fv_sub</span> <span class="main">∩</span> set <span class="free">fv_sub_comp</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fv_sub</span> <span class="main">∪</span> set <span class="free">fv_sub_comp</span> <span class="main">=</span> set <span class="free">fv_all</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ass</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">R</span> <span class="free">fv_sub</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> ad_agr_sets <span class="main">(</span>set <span class="free">fv_sub</span><span class="main">)</span> <span class="main">(</span>set <span class="free">fv_sub</span><span class="main">)</span> <span class="free">AD</span> <span class="bound">σ</span> <span class="bound">τ</span> <span class="main">⟹</span> <span class="bound">σ</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟷</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">fv_all</span>"</span></span>
    <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">(</span>proj_tuple <span class="free">fv_sub</span> <span class="main">(</span>zip <span class="free">fv_all</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ass</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>ext_tuple <span class="free">AD</span> <span class="free">fv_sub</span> <span class="free">fv_sub_comp</span> <span class="main">`</span> <span class="free">ass</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fv_all_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fv_all</span> <span class="main">=</span> sort <span class="main">(</span><span class="free">fv_sub</span> <span class="main">@</span> <span class="free">fv_sub_comp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_distinct_set_unique<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map <span class="skolem">σ</span> <span class="free">fv_all</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">fv_all</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">,</span>9<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> xs_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="free">fv_all</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> proj<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">fv_sub</span> <span class="main">(</span>zip <span class="free">fv_all</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">σ</span> <span class="free">fv_sub</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> σ_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> proj_tuple_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="free">fv_sub</span><span class="main">)</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">τ</span> <span class="free">fv_sub</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>10<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> proj proj_vals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> σ_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">)</span> fo_nmlz_eqD<span class="main">[</span><span class="operator">OF</span> τ_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> τ_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ad_agr_list_link<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext_tuple_complete<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">,</span></span></span>5<span class="main"><span class="main"><span class="main">,</span></span></span>6<span class="main"><span class="main"><span class="main">,</span></span></span>7<span class="main"><span class="main"><span class="main">)</span></span></span> xs_norm σ_R<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_tuple_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_sub</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_sub_comp</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">fv_all</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="free">fv_sub</span> <span class="main">∩</span> set <span class="free">fv_sub_comp</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">fv_sub</span> <span class="main">∪</span> set <span class="free">fv_sub_comp</span> <span class="main">=</span> set <span class="free">fv_all</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ass</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">R</span> <span class="free">fv_sub</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> ad_agr_sets <span class="main">(</span>set <span class="free">fv_sub</span><span class="main">)</span> <span class="main">(</span>set <span class="free">fv_sub</span><span class="main">)</span> <span class="free">AD</span> <span class="bound">σ</span> <span class="bound">τ</span> <span class="main">⟹</span> <span class="bound">σ</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟷</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">fv_all</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>ext_tuple <span class="free">AD</span> <span class="free">fv_sub</span> <span class="free">fv_sub_comp</span> <span class="main">`</span> <span class="free">ass</span><span class="main">)</span> <span class="main">⟷</span>
    fo_nmlz <span class="free">AD</span> <span class="main">(</span>proj_tuple <span class="free">fv_sub</span> <span class="main">(</span>zip <span class="free">fv_all</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ass</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ext_tuple_sound<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span> proj_tuple_sound<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">unify_vals_terms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> fo_term<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span>nat <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unify_vals_terms</span> <span class="main">[]</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">unify_vals_terms</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Inl <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="keyword1">then</span> <span class="free">unify_vals_terms</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">unify_vals_terms</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">unify_vals_terms</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>
    <span class="main">|</span> None <span class="main">⇒</span> <span class="free">unify_vals_terms</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">:=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">unify_vals_terms</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unify_vals_terms_extends<span class="main">:</span> <span class="quoted"><span class="quoted">"unify_vals_terms <span class="free">vs</span> <span class="free">ts</span> <span class="free">σ</span> <span class="main">=</span> Some <span class="free">σ'</span> <span class="main">⟹</span> extends_subst <span class="free">σ</span> <span class="free">σ'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extends_subst_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unify_vals_terms.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unify_vals_terms_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"unify_vals_terms <span class="free">vs</span> <span class="free">ts</span> <span class="free">σ</span> <span class="main">=</span> Some <span class="free">σ'</span> <span class="main">⟹</span> <span class="main">(</span>the <span class="main">∘</span> <span class="free">σ'</span><span class="main">)</span> <span class="keyword1">⊙e</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unify_vals_terms_extends
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unify_vals_terms.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def extends_subst_def fv_fo_terms_set_def
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unify_vals_terms_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ''</span> <span class="keyword1">⊙e</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">vs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">≠</span> None <span class="main">⟹</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ''</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> unify_vals_terms <span class="free">vs</span> <span class="free">ts</span> <span class="free">σ</span> <span class="main">=</span> Some <span class="bound">σ'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unify_vals_terms.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def extends_subst_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eval_table</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fo_term list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> table <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_table</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">fvs</span> <span class="main">=</span> fv_fo_terms_list <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">in</span>
    <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">vs</span><span class="main">.</span> <span class="keyword1">case</span> unify_vals_terms <span class="bound">vs</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> Map.empty <span class="keyword1">of</span> Some <span class="bound">σ</span> <span class="main">⇒</span>
      <span class="main">{</span>map <span class="main">(</span>the <span class="main">∘</span> <span class="bound">σ</span><span class="main">)</span> <span class="bound">fvs</span><span class="main">}</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> table"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_table <span class="free">ts</span> <span class="free">X</span> <span class="main">=</span> proj_vals <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> eval_table <span class="free">ts</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> as_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"unify_vals_terms <span class="skolem">as</span> <span class="free">ts</span> Map.empty <span class="main">=</span> Some <span class="skolem">σ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> map <span class="main">(</span>the <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_table_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="keyword1">⊙e</span> <span class="free">ts</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unify_vals_terms_sound<span class="main">[</span><span class="operator">OF</span> as_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> as_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> as_def<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> proj_vals <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_vals_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> list"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> proj_vals <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_vals_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"unify_vals_terms <span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span> <span class="free">ts</span> Map.empty <span class="main">=</span> Some <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unify_vals_terms_complete<span class="main">[</span><span class="operator">OF</span> refl<span class="main">,</span> <span class="operator">of</span> <span class="quoted">Map.empty</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">∘</span> <span class="skolem">σ'</span><span class="main">)</span> <span class="keyword1">⊙e</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unify_vals_terms_sound<span class="main">[</span><span class="operator">OF</span> σ'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> map <span class="main">(</span>the <span class="main">∘</span> <span class="skolem">σ'</span><span class="main">)</span> <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fv_fo_terms_set_list eval_eterms_fv_fo_terms_set
    <span class="keyword1"><span class="command">unfolding</span></span> σ_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> eval_table <span class="free">ts</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> σ_def<span class="main">(</span>2<span class="main">)</span> σ'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_table_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ad_agr_close_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇀</span> <span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ad_agr_close_rec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ad_agr_close_rec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">`</span> <span class="free">ad_agr_close_rec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ad_agr_close_rec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> Inl <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">`</span>
    <span class="free">ad_agr_close_rec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">:=</span> Some <span class="main">(</span>Inl <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">)</span> <span class="main">∪</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> Inr <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">`</span> <span class="free">ad_agr_close_rec</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">:=</span> Some <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
  <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">v</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">`</span> <span class="free">ad_agr_close_rec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_close_rec_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> ad_agr_close_rec <span class="free">i</span> <span class="free">m</span> <span class="free">AD</span> <span class="free">xs</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ad_agr_close_rec.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_close_rec_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> ad_agr_close_rec <span class="free">i</span> <span class="free">m</span> <span class="free">AD</span> <span class="free">xs</span> <span class="main">⟹</span>
  fo_nmlz_rec <span class="free">j</span> <span class="main">(</span>id_map <span class="free">j</span><span class="main">)</span> <span class="free">X</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">AD</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">∩</span> <span class="free">AD</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
  inj_on <span class="free">m</span> <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> dom <span class="free">m</span> <span class="main">=</span> <span class="main">{..&lt;</span><span class="free">j</span><span class="main">}</span> <span class="main">⟹</span> ran <span class="free">m</span> <span class="main">⊆</span> Inl <span class="main">`</span> <span class="free">Y</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span>
  fo_nmlz_rec <span class="free">i</span> <span class="main">(</span>id_map <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main">∪</span> <span class="free">AD</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">m'</span><span class="main">.</span> inj_on <span class="bound">m'</span> <span class="main">(</span>dom <span class="bound">m'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">v</span><span class="main">.</span> <span class="free">m</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">m'</span> <span class="main">(</span>Inr <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">x'</span> <span class="main">⇒</span>
      <span class="keyword1">if</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">X</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="bound">m'</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">y</span> <span class="keyword1">of</span> Inl <span class="bound">z</span> <span class="main">⇒</span> <span class="bound">z</span> <span class="main">∉</span> <span class="free">X</span> <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> True<span class="main">)</span>
  <span class="main">|</span> Inr <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">m'</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">y</span> <span class="keyword1">of</span> Inl <span class="bound">z</span> <span class="main">⇒</span> <span class="bound">z</span> <span class="main">∉</span> <span class="free">X</span> <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ad_agr_close_rec.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def sp_equiv_list_def inj_on_def dom_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"case_sum Map.empty <span class="skolem">m</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> Inl <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> ad_agr_close_rec <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">j</span> <span class="main">(</span>id_map <span class="skolem">j</span><span class="main">)</span> <span class="free">X</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ys_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> preds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">,</span></span>9<span class="main"><span class="main">,</span></span>10<span class="main"><span class="main">)</span></span><span class="main">]</span> preds<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span> <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> None<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> n_ge_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>9<span class="main">,</span>10<span class="main">)</span> None
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff leI lessThan_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> zs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> ad_agr_close_rec <span class="skolem">i</span> <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inl <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AD</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">AD</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> None ys_def Inl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>id_map <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">AD</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">AD</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inl <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..&lt;</span>Suc <span class="skolem">j</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"ran <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inl <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> Inl <span class="main">`</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> Suc <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">,</span>8<span class="main">,</span>10<span class="main">,</span>11<span class="main">,</span>12<span class="main">)</span> n_ge_j zs_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_id_map ran_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> id_mapD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inl <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dom <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inl <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>8<span class="main">,</span>9<span class="main">,</span>10<span class="main">,</span>11<span class="main">,</span>12<span class="main">)</span> preds<span class="main">(</span>8<span class="main">)</span> zs_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def dom_def ran_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> sets_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">AD</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">AD</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> zs_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> None zs_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> preds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> inj preds<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> sets_unfold<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> norm_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">i</span> <span class="main">(</span>id_map <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">AD</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> IH<span class="main">]</span> zs_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Inl <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> norm_ys conjunct2<span class="main">[</span><span class="operator">OF</span> IH<span class="main">]</span> None zs_def<span class="main">(</span>2<span class="main">)</span> 3<span class="main">(</span>6<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> ys_def<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> m'
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inl dom_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">m'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits sum.splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> zs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> ad_agr_close_rec <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inr <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">AD</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> None ys_def Inr<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>id_map <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
        <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inr <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..&lt;</span>Suc <span class="skolem">n</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"ran <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inr <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> Inl <span class="main">`</span> <span class="skolem">Y</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> Suc <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>5<span class="main">,</span>10<span class="main">,</span>11<span class="main">,</span>12<span class="main">)</span> n_ge_j
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_id_map ran_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> id_mapD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inr <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dom <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inr <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>9<span class="main">,</span>11<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def dom_def ran_def<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 3<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> None zs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> preds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 3<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">)</span></span> inj preds<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> norm_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">i</span> <span class="main">(</span>id_map <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">AD</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> IH<span class="main">]</span> zs_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inr fun_upd_id_map <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> id_mapD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> norm_ys conjunct2<span class="main">[</span><span class="operator">OF</span> IH<span class="main">]</span> None
        <span class="keyword1"><span class="command">unfolding</span></span> ys_def<span class="main">(</span>1<span class="main">)</span> zs_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> m'
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr dom_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">m'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits sum.splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> ad_agr_close_rec <span class="skolem">i</span> <span class="skolem">m</span> <span class="skolem">AD</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Some<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">j</span> <span class="main">(</span>id_map <span class="skolem">j</span><span class="main">)</span> <span class="free">X</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>5<span class="main">,</span>8<span class="main">,</span>10<span class="main">)</span> Some
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 3<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some ys_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> preds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 3<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">,</span></span>9<span class="main"><span class="main">,</span></span>10<span class="main"><span class="main">,</span></span>11<span class="main"><span class="main">,</span></span>12<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> norm_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">i</span> <span class="main">(</span>id_map <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">AD</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> IH<span class="main">]</span> 3<span class="main">(</span>11<span class="main">)</span> Some
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ran_def id_map_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">v</span> <span class="keyword1">of</span> Inl <span class="bound">z</span> <span class="main">⇒</span> <span class="bound">z</span> <span class="main">∉</span> <span class="free">X</span> <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> True"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>7<span class="main">,</span>11<span class="main">)</span> Some
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> norm_ys conjunct2<span class="main">[</span><span class="operator">OF</span> IH<span class="main">]</span> Some
      <span class="keyword1"><span class="command">unfolding</span></span> ys_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> m'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">m'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_close_rec_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="free">j</span> <span class="main">(</span>id_map <span class="free">j</span><span class="main">)</span> <span class="free">X</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">⟹</span>
  <span class="free">X</span> <span class="main">∩</span> <span class="free">AD</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">∩</span> <span class="free">AD</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
  inj_on <span class="free">m</span> <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> dom <span class="free">m</span> <span class="main">=</span> <span class="main">{..&lt;</span><span class="free">j</span><span class="main">}</span> <span class="main">⟹</span> ran <span class="free">m</span> <span class="main">=</span> Inl <span class="main">`</span> <span class="free">Y</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">n</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span>Inr <span class="bound">n</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">case</span> <span class="free">m</span> <span class="bound">n</span> <span class="keyword1">of</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="bound">b</span> <span class="main">∉</span> ran <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
  fo_nmlz_rec <span class="free">i</span> <span class="main">(</span>id_map <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main">∪</span> <span class="free">AD</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">⟹</span> ad_agr_list <span class="free">X</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span>
  <span class="free">ys</span> <span class="main">∈</span> ad_agr_close_rec <span class="free">i</span> <span class="free">m</span> <span class="free">AD</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="quoted">"id_map <span class="free">j</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">+</span> nat <span class="main">⇒</span> nat option"</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">Y</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fo_nmlz_rec.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">j</span> <span class="skolem">X</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> x_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">j</span> <span class="main">(</span>id_map <span class="skolem">j</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> Inl <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>14<span class="main">)</span> x_X<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def ad_equiv_pair.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> norm_zs<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">i</span> <span class="main">(</span>id_map <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">AD</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>13<span class="main">)</span> ys_def<span class="main">(</span>2<span class="main">)</span> x_X<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="skolem">X</span> <span class="skolem">xs</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>14<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def ad_agr_list_def ad_equiv_list_def sp_equiv_list_def pairwise_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x_X 2<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">,</span></span>9<span class="main"><span class="main">,</span></span>10<span class="main"><span class="main">,</span></span>11<span class="main"><span class="main">)</span></span> _ norm_zs ad_agr<span class="main">]</span> 2<span class="main">(</span>12<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">j</span> <span class="skolem">X</span> <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>13<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> n_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> id_mapD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> id_map<span class="main">:</span> <span class="quoted"><span class="quoted">"id_map <span class="skolem">j</span> <span class="main">(</span>Inr <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"id_map <span class="skolem">j</span><span class="main">(</span>Inr <span class="skolem">n</span> <span class="main">↦</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> id_map <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> n_j fun_upd_id_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> norm_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>id_map <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def fun_upd_id_map id_map<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">n</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>8<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def n_j<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> z_out<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∉</span> Inl <span class="main">`</span> <span class="skolem">Y</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>11<span class="main">)</span> None
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def 3<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> a_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">AD</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>12<span class="main">,</span>13<span class="main">)</span> z_out
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inl ad_agr_list_def ad_equiv_list_def ad_equiv_pair.simps
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> norm_zs<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">i</span> <span class="main">(</span>id_map <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">AD</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>12<span class="main">)</span> a_in
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">AD</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">AD</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span> a_in
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> Some <span class="main">(</span>Inl <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dom <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> Some <span class="main">(</span>Inl <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>6<span class="main">,</span>7<span class="main">,</span>9<span class="main">)</span> None a_in
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def dom_def ran_def<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> preds'<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inl <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..&lt;</span>Suc <span class="skolem">j</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"ran <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inl <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Inl <span class="main">`</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> Suc <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>6<span class="main">,</span>8<span class="main">,</span>9<span class="main">,</span>10<span class="main">)</span> None less_Suc_eq a_in
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_j dom_def ran_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> Un_iff image_eqI mem_Collect_eq option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> 3<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> domIff image_subset_iff lessThan_iff mem_Collect_eq sup_ge2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">have</span></span> a_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">AD</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">AD</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">AD</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">AD</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a_in
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="skolem">X</span> <span class="skolem">xs</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>13<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inl ad_agr_list_def ad_equiv_list_def sp_equiv_list_def pairwise_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> ad_agr_close_rec <span class="skolem">i</span> <span class="main">(</span><span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">↦</span> Inl <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">AD</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> id_map norm_xs preds inj preds' _ _ ad_agr<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>11<span class="main">,</span>13<span class="main">)</span> norm_zs
        <span class="keyword1"><span class="command">unfolding</span></span> 3<span class="main">(</span>9<span class="main">)</span> preds'<span class="main">(</span>2<span class="main">)</span> a_unfold
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> None Inl ys_def ad_agr_list_def sp_equiv_list_def pairwise_def
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff image_eqI option.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> image_subset_iff lessThan_iff option.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> sup_ge2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> a_in
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inl None<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">b</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> i_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>12<span class="main">)</span> z_out
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> id_mapD<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> norm_zs<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>id_map <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">AD</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>12<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inr i_b fun_upd_id_map <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> id_mapD<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="skolem">X</span> <span class="skolem">xs</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>13<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def ad_agr_list_def ad_equiv_list_def sp_equiv_list_def pairwise_def<span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">≡</span> <span class="skolem">m</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> Some <span class="main">(</span>Inr <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">m'</span> <span class="main">(</span>dom <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">m'</span> <span class="main">=</span> <span class="main">{..&lt;</span>Suc <span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> Suc <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>7<span class="main">,</span>8<span class="main">,</span>9<span class="main">,</span>10<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m'_def n_j inj_on_def dom_def ran_def image_iff<span class="main">)</span>
           <span class="main">(</span><span class="operator">metis</span> 3<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> domI lessThan_iff less_SucI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ran<span class="main">:</span> <span class="quoted"><span class="quoted">"ran <span class="skolem">m'</span> <span class="main">=</span> Inl <span class="main">`</span> <span class="skolem">Y</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="skolem">i</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>9<span class="main">)</span> None
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> ad_agr_close_rec <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">m'</span> <span class="skolem">AD</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> id_map norm_xs 3<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">,</span></span></span>5<span class="main"><span class="main"><span class="main">,</span></span></span>6<span class="main"><span class="main"><span class="main">)</span></span></span> preds<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> ran preds<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> _ norm_zs ad_agr<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>11<span class="main">,</span>13<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> 3<span class="main">(</span>9<span class="main">)</span> ys_def Inr i_b m'_def
        <span class="keyword1"><span class="command">unfolding</span></span> ran<span class="main">[</span><span class="operator">unfolded</span> m'_def i_b<span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def sp_equiv_list_def pairwise_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Un_upper1 image_subset_iff option.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> UnI1 image_eqI insert_iff lessThan_Suc lessThan_iff option.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span>
            sp_equiv_pair.simps sum.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sup_commute<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inr None m'_def i_b<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> id_map<span class="main">:</span> <span class="quoted"><span class="quoted">"id_map <span class="skolem">j</span> <span class="main">(</span>Inr <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> norm_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">j</span> <span class="main">(</span>id_map <span class="skolem">j</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_map<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False 3<span class="main">(</span>11<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> ys_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> 3<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> domD insert_iff leI lessThan_iff list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span>
          option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> zip_Cons_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> z_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="skolem">Y</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>9<span class="main">)</span> Some
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="skolem">X</span> <span class="skolem">xs</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>13<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ys_def ad_equiv_list_def sp_equiv_list_def pairwise_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> a_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">AD</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>12<span class="main">,</span>13<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inl ad_agr_list_def ad_equiv_list_def ad_equiv_pair.simps
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> norm_zs<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">i</span> <span class="main">(</span>id_map <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">AD</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>12<span class="main">)</span> a_in
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inl<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> id_map norm_xs 3<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">,</span></span>9<span class="main"><span class="main">,</span></span>10<span class="main"><span class="main">)</span></span> _ norm_zs ad_agr<span class="main">]</span> 3<span class="main">(</span>11<span class="main">)</span> a_in
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inl Some <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">b</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> b_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z_in
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> norm_zs<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz_rec <span class="skolem">i</span> <span class="main">(</span>id_map <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">AD</span><span class="main">)</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>12<span class="main">)</span> b_lt
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> id_map norm_xs 3<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">,</span></span>9<span class="main"><span class="main">,</span></span>10<span class="main"><span class="main">)</span></span> _ norm_zs ad_agr<span class="main">]</span> 3<span class="main">(</span>11<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def Inr Some<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ad_agr_close</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ad_agr_close</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> ad_agr_close_rec <span class="main">0</span> Map.empty <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_close_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> ad_agr_close <span class="free">Y</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">X</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="free">ys</span> <span class="main">∧</span> ad_agr_list <span class="free">X</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ad_agr_close_rec_sound<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ad_agr_close_def<span class="main"><span class="main">]</span></span>
    fo_nmlz_idem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> fo_nmlz_def<span class="main"><span class="main">,</span></span> <span class="operator">folded</span> id_map_empty<span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
    Int_empty_right Int_empty_left<span class="main">]</span>
    ad_agr_map<span class="main">[</span><span class="operator">OF</span> ad_agr_close_rec_length<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ad_agr_close_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
    fo_nmlzd_code<span class="main">[</span><span class="operator">unfolded</span> fo_nmlz_def<span class="main">,</span> <span class="operator">folded</span> id_map_empty<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_close_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">X</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">X</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> ad_agr_close <span class="free">Y</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ad_agr_close_rec_complete<span class="main">[</span><span class="operator">OF</span> fo_nmlz_idem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span>
        <span class="operator">unfolded</span> fo_nmlz_def<span class="main"><span class="main">,</span></span> <span class="operator">folded</span> id_map_empty<span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Int_empty_right Int_empty_left _ _ _
        order.refl _ _ assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">Map.empty</span><span class="main">]</span>
        fo_nmlzd_code<span class="main">[</span><span class="operator">unfolded</span> fo_nmlz_def<span class="main">,</span> <span class="operator">folded</span> id_map_empty<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">]</span>
        assms<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> ad_agr_close_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_close_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">X</span> <span class="free">xs</span> <span class="main">⟹</span> ad_agr_close <span class="main">{}</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">{</span><span class="free">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ad_agr_close_complete<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?X</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">X</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?Y</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?xs</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ys</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
    ad_agr_close_sound<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?X</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">X</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?Y</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?xs</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">xs</span></span><span class="main">]</span> ad_agr_list_refl ad_agr_list_fo_nmlzd
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_close_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">AD'</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> ad_agr_sets <span class="main">(</span>set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">AD'</span> <span class="bound">σ</span> <span class="bound">τ</span> <span class="main">⟹</span>
    <span class="bound">σ</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟷</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>ad_agr_close <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">AD'</span><span class="main">)</span> <span class="main">`</span> fo_nmlz <span class="free">AD'</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>ad_agr_close <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">AD'</span><span class="main">)</span> <span class="main">`</span> fo_nmlz <span class="free">AD'</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> ad_agr_close <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">AD'</span><span class="main">)</span>
    <span class="main">(</span>fo_nmlz <span class="free">AD'</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD</span> <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD'</span> <span class="main">(</span>fo_nmlz <span class="free">AD'</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr_close_sound<span class="main">[</span><span class="operator">OF</span> σ_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fo_nmlz_sound<span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> Diff_partition
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="free">φ</span>"</span></span> <span class="quoted"><span class="skolem">vs</span></span><span class="main">]</span> sorted_distinct_fv_list vs<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def fo_nmlz_length<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fo_nmlz_idem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> σ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">OF</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ad_agr_list_link ad_agr_list_trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span>
          fo_nmlz_ad_agr<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="free">AD'</span></span> <span class="quoted"><span class="quoted">"map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> vs<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">unfolded</span> τ_def<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> τ_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> fo_nmlz <span class="free">AD'</span> <span class="skolem">vs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> preds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AD'</span> <span class="main">∩</span> <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">AD'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">AD'</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="main">(</span><span class="free">AD'</span> <span class="main">∪</span> <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">AD'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> fo_nmlz_sound Diff_partition
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> xs_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="free">φ</span>"</span></span> <span class="quoted"><span class="skolem">vs</span></span><span class="main">]</span> sorted_distinct_fv_list σ_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_length<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> ad_agr_close <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">AD'</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr_close_complete<span class="main">[</span><span class="operator">OF</span> preds<span class="main">]</span> ad_agr_list_comm<span class="main">[</span><span class="operator">OF</span> fo_nmlz_ad_agr<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>ad_agr_close <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">AD'</span><span class="main">)</span> <span class="main">`</span> fo_nmlz <span class="free">AD'</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> xs_def τ_def
    <span class="keyword1"><span class="command">using</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> σ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">OF</span> ad_agr_sets_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> iffD2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> ad_agr_list_link
          fo_nmlz_ad_agr<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="quoted">"map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span> <span class="operator">folded</span> σ_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span> <span class="operator">unfolded</span> τ_def<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ad_agr_close_set</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> Set.is_empty <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">else</span> <span class="main">⋃</span><span class="main">(</span>ad_agr_close <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_close_set_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Ball <span class="free">X</span> <span class="main">(</span>fo_nmlzd <span class="free">AD'</span><span class="main">)</span> <span class="main">⟹</span> ad_agr_close_set <span class="free">AD</span> <span class="free">X</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>ad_agr_close <span class="free">AD</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_close_set_def Set.is_empty_def ad_agr_close_empty<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eval_pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> fo_term<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> fo_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_pred</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">AD</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map set_fo_term <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">AD</span><span class="main">,</span> length <span class="main">(</span>fv_fo_terms_list <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">,</span> eval_table <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">(</span>map Inl <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eval_bool</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> fo_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_bool</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eval_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fo_term <span class="main">⇒</span> <span class="tfree">'a</span> fo_term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_eq</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Var <span class="bound">n</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">of</span> Var <span class="bound">n'</span> <span class="main">⇒</span>
    <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="bound">n'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>Inr <span class="main">0</span><span class="main">]</span><span class="main">}</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>Inr <span class="main">0</span><span class="main">,</span> Inr <span class="main">0</span><span class="main">]</span><span class="main">}</span><span class="main">)</span>
    <span class="main">|</span> Const <span class="bound">c'</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">{</span><span class="bound">c'</span><span class="main">}</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>Inl <span class="bound">c'</span><span class="main">]</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Const <span class="bound">c</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">of</span> Var <span class="bound">n'</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">{</span><span class="bound">c</span><span class="main">}</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>Inl <span class="bound">c</span><span class="main">]</span><span class="main">}</span><span class="main">)</span>
    <span class="main">|</span> Const <span class="bound">c'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">c'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">{</span><span class="bound">c</span><span class="main">}</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">{</span><span class="bound">c</span><span class="main">,</span> <span class="bound">c'</span><span class="main">}</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_neg</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> nall_tuples <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval_conj_tuple</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">cxs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="main">∧</span> isl <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="bound">nxs</span> <span class="main">=</span> map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="main">∧</span> <span class="main">¬</span>isl <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">cys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">∧</span> isl <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="bound">nys</span> <span class="main">=</span> map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">∧</span> <span class="main">¬</span>isl <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
  fo_nmlz <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">`</span> ext_tuple <span class="main">{}</span> <span class="main">(</span>sort <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">@</span> map fst <span class="bound">cys</span><span class="main">)</span><span class="main">)</span> <span class="bound">nys</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="bound">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span>
  fo_nmlz <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">`</span> ext_tuple <span class="main">{}</span> <span class="main">(</span>sort <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="main">@</span> map fst <span class="bound">cxs</span><span class="main">)</span><span class="main">)</span> <span class="bound">nxs</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="bound">cxs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval_conj_set</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="free"><span class="bound"><span class="entity">Xφ</span></span></span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="free"><span class="bound"><span class="entity">Xψ</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span>eval_conj_tuple <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="bound">xs</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">Xψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">Xφ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_conj_table</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_conj_table</span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ADφ</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Xφ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ADψ</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Xψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">AD</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ADφ</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">ADψ</span></span></span><span class="main">;</span> <span class="bound">ADΔφ</span> <span class="main">=</span> <span class="bound">AD</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">ADφ</span></span></span><span class="main">;</span> <span class="bound">ADΔψ</span> <span class="main">=</span> <span class="bound">AD</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">ADψ</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">AD</span><span class="main">,</span> card <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">∪</span> set <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span><span class="main">)</span><span class="main">,</span> eval_conj_set <span class="bound">AD</span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">(</span>ad_agr_close_set <span class="bound">ADΔφ</span> <span class="free"><span class="bound"><span class="entity">Xφ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="main">(</span>ad_agr_close_set <span class="bound">ADΔψ</span> <span class="free"><span class="bound"><span class="entity">Xψ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_conj_idx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_conj_idx</span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ADφ</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Xφ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ADψ</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Xψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">AD</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ADφ</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">ADψ</span></span></span><span class="main">;</span> <span class="bound">AD'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ADφ</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">ADψ</span></span></span><span class="main">;</span>
    <span class="bound">ADΔφ</span> <span class="main">=</span> <span class="bound">AD</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">ADφ</span></span></span><span class="main">;</span> <span class="bound">ADΔψ</span> <span class="main">=</span> <span class="bound">AD</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">ADψ</span></span></span><span class="main">;</span>
    <span class="bound">ns</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span><span class="main">;</span>
    <span class="bound">idxφ</span> <span class="main">=</span> cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> fo_nmlz <span class="bound">AD'</span> <span class="main">(</span>proj_tuple <span class="bound">ns</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Xφ</span></span></span><span class="main">;</span>
    <span class="bound">idxψ</span> <span class="main">=</span> cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> fo_nmlz <span class="bound">AD'</span> <span class="main">(</span>proj_tuple <span class="bound">ns</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Xψ</span></span></span><span class="main">;</span>
    <span class="bound">join</span> <span class="main">=</span> mapping_join <span class="main">(</span><span class="main">λ</span><span class="bound">Xφ'</span> <span class="bound">Xψ'</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">idxφ'</span> <span class="main">=</span> cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> fo_nmlz <span class="bound">AD</span> <span class="main">(</span>proj_tuple <span class="bound">ns</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ad_agr_close_set <span class="bound">ADΔφ</span> <span class="bound">Xφ'</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">idxψ'</span> <span class="main">=</span> cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> fo_nmlz <span class="bound">AD</span> <span class="main">(</span>proj_tuple <span class="bound">ns</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ad_agr_close_set <span class="bound">ADΔψ</span> <span class="bound">Xψ'</span><span class="main">)</span> <span class="keyword1">in</span>
      set_of_idx <span class="main">(</span>mapping_join <span class="main">(</span><span class="main">λ</span><span class="bound">Xφ''</span> <span class="bound">Xψ''</span><span class="main">.</span> eval_conj_set <span class="bound">AD</span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="bound">Xφ''</span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="bound">Xψ''</span><span class="main">)</span> <span class="bound">idxφ'</span> <span class="bound">idxψ'</span><span class="main">)</span><span class="main">)</span> <span class="bound">idxφ</span> <span class="bound">idxψ</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">AD</span><span class="main">,</span> card <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">∪</span> set <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span><span class="main">)</span><span class="main">,</span> set_of_idx <span class="bound">join</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_ajoin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_ajoin</span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ADφ</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Xφ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ADψ</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Xψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">AD</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ADφ</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">ADψ</span></span></span><span class="main">;</span>
    <span class="bound">nsφ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span><span class="main">;</span>
    <span class="bound">ns</span> <span class="main">=</span> remdups_adj <span class="main">(</span>sort <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">ADΔφ</span> <span class="main">=</span> <span class="bound">AD</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">ADφ</span></span></span><span class="main">;</span>
    <span class="bound">Xφ'</span> <span class="main">=</span> ext_tuple_set <span class="bound">AD</span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="bound">nsφ'</span> <span class="main">(</span>ad_agr_close_set <span class="bound">ADΔφ</span> <span class="free"><span class="bound"><span class="entity">Xφ</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">AD</span><span class="main">,</span> card <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">∪</span> set <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">{</span><span class="bound"><span class="bound">xs</span></span> <span class="main">∈</span> <span class="bound">Xφ'</span><span class="main">.</span> <span class="main">¬</span>fo_nmlz <span class="free"><span class="bound"><span class="entity">ADψ</span></span></span> <span class="main">(</span>proj_tuple <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="main">(</span>zip <span class="bound">ns</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Xψ</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_disj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_disj</span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ADφ</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Xφ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ADψ</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Xψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">AD</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ADφ</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">ADψ</span></span></span><span class="main">;</span>
    <span class="bound">nsφ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span><span class="main">;</span>
    <span class="bound">nsψ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span><span class="main">;</span>
    <span class="bound">ADΔφ</span> <span class="main">=</span> <span class="bound">AD</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">ADφ</span></span></span><span class="main">;</span> <span class="bound">ADΔψ</span> <span class="main">=</span> <span class="bound">AD</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">ADψ</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">AD</span><span class="main">,</span> card <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="main">∪</span> set <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span><span class="main">)</span><span class="main">,</span>
      ext_tuple_set <span class="bound">AD</span> <span class="free"><span class="bound"><span class="entity">nsφ</span></span></span> <span class="bound">nsφ'</span> <span class="main">(</span>ad_agr_close_set <span class="bound">ADΔφ</span> <span class="free"><span class="bound"><span class="entity">Xφ</span></span></span><span class="main">)</span> <span class="main">∪</span>
      ext_tuple_set <span class="bound">AD</span> <span class="free"><span class="bound"><span class="entity">nsψ</span></span></span> <span class="bound">nsψ'</span> <span class="main">(</span>ad_agr_close_set <span class="bound">ADΔψ</span> <span class="free"><span class="bound"><span class="entity">Xψ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_exists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_exists</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> pos <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="keyword1">of</span> Some <span class="bound">j</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> fo_nmlz <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">`</span> rem_nth <span class="bound">j</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>
  <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_forall</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_forall</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> pos <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="keyword1">of</span> Some <span class="bound">j</span> <span class="main">⇒</span>
    <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> card <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> Mapping.keys <span class="main">(</span>Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">Z</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="bound">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> card <span class="bound">Z</span><span class="main">)</span>
      <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ts</span><span class="main">.</span> fo_nmlz <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">(</span>rem_nth <span class="bound">j</span> <span class="bound">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_map2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys'</span> <span class="main">=</span> length <span class="free">xs'</span>"</span></span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∩</span> set <span class="free">xs'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> map <span class="bound">f</span> <span class="free">xs</span> <span class="main">∧</span> <span class="free">ys'</span> <span class="main">=</span> map <span class="bound">f</span> <span class="free">xs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> fg_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> map <span class="skolem">f</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys'</span> <span class="main">=</span> map <span class="skolem">g</span> <span class="free">xs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms exists_map
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fg_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="skolem">g</span> <span class="bound">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_map3<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys'</span> <span class="main">=</span> length <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys''</span> <span class="main">=</span> length <span class="free">xs''</span>"</span></span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs''</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∩</span> set <span class="free">xs'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∩</span> set <span class="free">xs''</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs'</span> <span class="main">∩</span> set <span class="free">xs''</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> map <span class="bound">f</span> <span class="free">xs</span> <span class="main">∧</span> <span class="free">ys'</span> <span class="main">=</span> map <span class="bound">f</span> <span class="free">xs'</span> <span class="main">∧</span> <span class="free">ys''</span> <span class="main">=</span> map <span class="bound">f</span> <span class="free">xs''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> fgh_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> map <span class="skolem">f</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys'</span> <span class="main">=</span> map <span class="skolem">g</span> <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys''</span> <span class="main">=</span> map <span class="skolem">h</span> <span class="free">xs''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms exists_map
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fgh_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs'</span> <span class="keyword1">then</span> <span class="skolem">g</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="skolem">h</span> <span class="bound">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_set_zip<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">nsx</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="free">nsx</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">ba</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">=</span> <span class="free">ba</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nsx</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_idem_isl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">z</span> <span class="main">⇒</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">X</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> F1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inl <span class="skolem">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Inl <span class="skolem">x</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> F2<span class="main">:</span> <span class="quoted"><span class="quoted">"List.map_filter <span class="main">(</span>case_sum Map.empty Some<span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.map_filter_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_idem<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_def nats_def F2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> F1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_zip_mapI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">,</span> <span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_fo_nmlzd_isl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">X</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">X</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"isl <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">g</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> AD<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">,</span> <span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> set_zip_mapI<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> AD ad_equiv_pair.simps ad_equiv_pair_mono image_eqI sum.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> vimageI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_conj_tuple_close_empty2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">X</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">Y</span> <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">nsx</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">nsy</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsx</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsy</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ns</span> <span class="main">⊆</span> set <span class="free">nsx</span> <span class="main">∩</span> set <span class="free">nsy</span>"</span></span>
    <span class="quoted"><span class="quoted">"fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≠</span> proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> isl <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> isl <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">∈</span> ad_agr_close <span class="main">(</span><span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys'</span> <span class="main">∈</span> ad_agr_close <span class="main">(</span><span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">-</span> <span class="free">Y</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_conj_tuple <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="free">nsx</span> <span class="free">nsy</span> <span class="free">xs'</span> <span class="free">ys'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cxs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cxs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsy</span> <span class="main">∧</span> isl <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nxs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nxs</span> <span class="main">=</span> map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsy</span> <span class="main">∧</span> <span class="main">¬</span>isl <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsx</span> <span class="main">∧</span> isl <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nys</span> <span class="main">=</span> map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsx</span> <span class="main">∧</span> <span class="main">¬</span>isl <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">both</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">both</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>set <span class="free">nsx</span> <span class="main">∪</span> set <span class="free">nsy</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> close<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">X</span> <span class="free">xs</span> <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="free">ys'</span>"</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">Y</span> <span class="free">ys</span> <span class="free">ys'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr_close_sound<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> ad_agr_close_sound<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_left_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> close'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs'</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys'</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> close
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_length<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>sort <span class="main">(</span><span class="free">nsx</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>sort <span class="main">(</span><span class="free">nsy</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge_length assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> close'<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">zs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fs</span><span class="main">.</span> map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsx</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">nys</span> <span class="bound">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span>
      nall_tuples_rec <span class="main">{}</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">nys</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fs</span><span class="main">.</span> map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsy</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">nxs</span> <span class="bound">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span>
      nall_tuples_rec <span class="main">{}</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">nxs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zxs</span></span> <span class="skolem"><span class="skolem">zys</span></span> <span class="keyword2"><span class="keyword">where</span></span> nall<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zxs</span> <span class="main">∈</span> nall_tuples_rec <span class="main">{}</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">nys</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsx</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">nys</span> <span class="skolem">zxs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">zys</span> <span class="main">∈</span> nall_tuples_rec <span class="main">{}</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">nxs</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsy</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">nxs</span> <span class="skolem">zys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> len_zs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">zxs</span> <span class="main">=</span> length <span class="skolem">nys</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zys</span> <span class="main">=</span> length <span class="skolem">nxs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nall<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nall_tuples_rec_length<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="main">(</span>map fst <span class="skolem">cxs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="skolem">nxs</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsy</span>"</span></span>
      <span class="quoted"><span class="quoted">"sorted_distinct <span class="main">(</span>map fst <span class="skolem">cys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="skolem">nys</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsx</span>"</span></span>
      <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">cxs</span><span class="main">)</span> <span class="main">∩</span> set <span class="free">nsy</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">cxs</span><span class="main">)</span> <span class="main">∩</span> set <span class="skolem">nxs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">nsy</span> <span class="main">∩</span> set <span class="skolem">nxs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">cys</span><span class="main">)</span> <span class="main">∩</span> set <span class="free">nsx</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">cys</span><span class="main">)</span> <span class="main">∩</span> set <span class="skolem">nys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">nsx</span> <span class="main">∩</span> set <span class="skolem">nys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span> close' distinct_set_zip
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cxs_def nxs_def cys_def nys_def sorted_filter distinct_map_fst_filter<span class="main">)</span>
         <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> distinct_set_zip<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xf</span></span> <span class="keyword2"><span class="keyword">where</span></span> xf_def<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="skolem">cxs</span> <span class="main">=</span> map <span class="skolem">xf</span> <span class="main">(</span>map fst <span class="skolem">cxs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys'</span> <span class="main">=</span> map <span class="skolem">xf</span> <span class="free">nsy</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zys</span> <span class="main">=</span> map <span class="skolem">xf</span> <span class="skolem">nxs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_map3<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?ys</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"map snd <span class="skolem">cxs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?xs</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"map fst <span class="skolem">cxs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ys'</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ys'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?xs'</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">nsy</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ys''</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">zys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?xs''</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">nxs</span></span><span class="main">]</span> assms<span class="main">(</span>4<span class="main">)</span> aux close'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_zs<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ysf</span></span> <span class="keyword2"><span class="keyword">where</span></span> ysf_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> map <span class="skolem">ysf</span> <span class="free">nsy</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">,</span>6<span class="main">)</span> exists_map
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xg</span></span> <span class="keyword2"><span class="keyword">where</span></span> xg_def<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="skolem">cys</span> <span class="main">=</span> map <span class="skolem">xg</span> <span class="main">(</span>map fst <span class="skolem">cys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> map <span class="skolem">xg</span> <span class="free">nsx</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zxs</span> <span class="main">=</span> map <span class="skolem">xg</span> <span class="skolem">nys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_map3<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?ys</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"map snd <span class="skolem">cys</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?xs</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"map fst <span class="skolem">cys</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ys'</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">xs'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?xs'</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">nsx</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ys''</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">zxs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?xs''</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">nys</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> aux close'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_zs<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xsf</span></span> <span class="keyword2"><span class="keyword">where</span></span> xsf_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map <span class="skolem">xsf</span> <span class="free">nsx</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> exists_map
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> set_cxs_nxs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">cxs</span> <span class="main">@</span> <span class="skolem">nxs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">nsx</span> <span class="main">-</span> set <span class="free">nsy</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> cxs_def nxs_def close'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nsx</span></span> <span class="quoted"><span class="free">xs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> set_cys_nys<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">cys</span> <span class="main">@</span> <span class="skolem">nys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">nsy</span> <span class="main">-</span> set <span class="free">nsx</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> cys_def nys_def close'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nsy</span></span> <span class="quoted"><span class="free">ys'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> sort_sort_both_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"sort <span class="main">(</span>sort <span class="main">(</span><span class="free">nsy</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">nxs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">both</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_distinct_set_unique<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span> close' set_cxs_nxs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> both_def nxs_def cxs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> distinct_map_fst_filter<span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> distinct_set_zip<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> sort_sort_both_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"sort <span class="main">(</span>sort <span class="main">(</span><span class="free">nsx</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">nys</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">both</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_distinct_set_unique<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span> close' set_cys_nys
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> both_def nys_def cys_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> distinct_map_fst_filter<span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> distinct_set_zip<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">xf</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsy</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> merge_map<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?σ</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xf</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ns</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">nsy</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ms</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"map fst <span class="skolem">cxs</span>"</span></span><span class="main">]</span> assms<span class="main">(</span>6<span class="main">)</span> aux
      <span class="keyword1"><span class="command">unfolding</span></span> xf_def<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> xf_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zip_map_fst_snd<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> zs_xf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">xf</span> <span class="skolem">both</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> merge_map<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> σ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xf</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ns</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"sort <span class="main">(</span><span class="free">nsy</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ms</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">nxs</span></span><span class="main">]</span> aux
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nall<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> xf_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sort_sort_both_xs<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">xg</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsx</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> merge_map<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?σ</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xg</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ns</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">nsx</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ms</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"map fst <span class="skolem">cys</span>"</span></span><span class="main">]</span> assms<span class="main">(</span>5<span class="main">)</span> aux
      <span class="keyword1"><span class="command">unfolding</span></span> xg_def<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> xg_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zip_map_fst_snd<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> zs_xg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">xg</span> <span class="skolem">both</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> merge_map<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> σ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xg</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ns</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"sort <span class="main">(</span><span class="free">nsx</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?ms</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">nys</span></span><span class="main">]</span> aux
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nall<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> xg_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sort_sort_both_ys<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> proj_map<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">xg</span> <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">xf</span> <span class="free">ns</span>"</span></span>
      <span class="quoted"><span class="quoted">"proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">xsf</span> <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">ysf</span> <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> xf_def<span class="main">(</span>2<span class="main">)</span> xg_def<span class="main">(</span>2<span class="main">)</span> xsf_def ysf_def
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">,</span>8<span class="main">)</span> proj_tuple_map
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">xg</span> <span class="skolem">both</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">xf</span> <span class="skolem">both</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> zs_xg zs_xf
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fo_nmlz_eqD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> proj_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> both_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ad_agr_list_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fo_nmlz_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fo_nmlz_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>9<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> fo_nmlz_Int<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fo_nmlz_Un
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_eqI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ad_agr_list_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> fo_nmlz_eqD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> proj_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> proj_map
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_list_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Int_lower1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_list_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ close<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> xsf_def xg_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">have</span></span> proj_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> proj_map
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_list_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Int_lower2<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_list_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ close<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ysf_def xf_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c fo_nmlz_Int proj_xs proj_ys
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≠</span> proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> isl <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> isl <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> Inl <span class="bound">z</span> <span class="main">⇒</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main">|</span> Inr <span class="bound">b</span> <span class="main">⇒</span> False"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">using</span></span> close<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>1<span class="main">,</span>8<span class="main">)</span> c that ad_agr_list_fo_nmlzd_isl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?X</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">X</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?f</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xsf</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?g</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xg</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?xs</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">nsx</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> proj_map
        <span class="keyword1"><span class="command">unfolding</span></span> xsf_def xg_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI subsetD vimageI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> subsetD sum.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> E1<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_idem_isl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">y</span> <span class="keyword1">of</span> Inl <span class="bound">z</span> <span class="main">⇒</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main">|</span> Inr <span class="bound">b</span> <span class="main">⇒</span> False"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
        <span class="keyword1"><span class="command">using</span></span> close<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>2<span class="main">,</span>8<span class="main">)</span> c that ad_agr_list_fo_nmlzd_isl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?X</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?f</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ysf</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?g</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xf</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?xs</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">nsy</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> proj_map
        <span class="keyword1"><span class="command">unfolding</span></span> ysf_def xf_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI subsetD vimageI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> subsetD sum.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> E2<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_idem_isl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ad<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">X</span> <span class="main">(</span>map <span class="skolem">xsf</span> <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">xg</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span> close<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> xsf_def xg_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> ad_agr_list_subset
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> isl <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> E3<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> proj_map
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> ad_agr_list_fo_nmlzd_isl<span class="main">[</span><span class="operator">OF</span> close<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> xsf_def xg_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> xsf_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> isl <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> E4<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> proj_map
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> ad_agr_list_fo_nmlzd_isl<span class="main">[</span><span class="operator">OF</span> close<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ysf_def xf_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ysf_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c fo_nmlz_Un
        <span class="keyword1"><span class="command">unfolding</span></span> E1 E2 E3 E4
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_conj_tuple_def Let_def cxs_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nxs_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cys_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nys_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        ext_tuple_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> len_sort<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> ext_tuple_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> len_sort<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_conj_tuple_close_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">X</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">Y</span> <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">nsx</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">nsy</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsx</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsy</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free">nsy</span><span class="main">)</span> <span class="free">nsx</span>"</span></span>
    <span class="quoted"><span class="quoted">"fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> fo_nmlz <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">∈</span> ad_agr_close <span class="main">(</span><span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys'</span> <span class="main">∈</span> ad_agr_close <span class="main">(</span><span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">-</span> <span class="free">Y</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_conj_tuple <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="free">nsx</span> <span class="free">nsy</span> <span class="free">xs'</span> <span class="free">ys'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ns</span> <span class="main">⊆</span> set <span class="free">nsx</span> <span class="main">∩</span> set <span class="free">nsy</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> sorted_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_conj_tuple_close_empty2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-6<span class="main"><span class="main">)</span></span> aux<span class="main">]</span> assms<span class="main">(</span>8-<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_conj_tuple_empty2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">Z</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">Z</span> <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">nsx</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">nsy</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsx</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsy</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ns</span> <span class="main">⊆</span> set <span class="free">nsx</span> <span class="main">∩</span> set <span class="free">nsy</span>"</span></span>
    <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">Z</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> fo_nmlz <span class="free">Z</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≠</span> proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> isl <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> isl <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_conj_tuple <span class="free">Z</span> <span class="free">nsx</span> <span class="free">nsy</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eval_conj_tuple_close_empty2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-8<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>9<span class="main">)</span> ad_agr_close_empty assms<span class="main">(</span>1-2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_conj_tuple_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">Z</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="free">Z</span> <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">nsx</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">nsy</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsx</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsy</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free">nsy</span><span class="main">)</span> <span class="free">nsx</span>"</span></span>
    <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">Z</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsx</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> fo_nmlz <span class="free">Z</span> <span class="main">(</span>proj_tuple <span class="free">ns</span> <span class="main">(</span>zip <span class="free">nsy</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_conj_tuple <span class="free">Z</span> <span class="free">nsx</span> <span class="free">nsy</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ns</span> <span class="main">⊆</span> set <span class="free">nsx</span> <span class="main">∩</span> set <span class="free">nsy</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> sorted_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_conj_tuple_empty2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-6<span class="main"><span class="main">)</span></span> aux<span class="main">]</span> assms<span class="main">(</span>8-<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nall_tuples_rec_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="free">n</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>isl <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> nall_tuples_rec <span class="main">{}</span> <span class="free">n</span> <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> b_le_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> Inr <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> isl <span class="bound">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ ys_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> Cons<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr ys_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ ys_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span> Cons<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr ys_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nall_tuples_rec_filter_rev<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> nall_tuples_rec <span class="main">{}</span> <span class="free">n</span> <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>isl <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="free">n</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> a_AD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">AD</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inl<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> Cons<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> a_AD
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> Inr <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> isl <span class="bound">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Inr<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ ys_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> Cons<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Inr<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_conj_set_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nsφ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nsφ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsφ</span><span class="main">)</span> <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nsψ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nsψ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsψ</span><span class="main">)</span> <span class="free">nsφ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Xφ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Xφ</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">Rφ</span> <span class="free">nsφ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Xψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Xψ</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">Rψ</span> <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsφ</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cxs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cxs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsψ</span> <span class="main">∧</span> isl <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nxs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nxs</span> <span class="main">=</span> map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsψ</span> <span class="main">∧</span> <span class="main">¬</span>isl <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsφ</span> <span class="main">∧</span> isl <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsψ</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nys</span> <span class="main">=</span> map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsφ</span> <span class="main">∧</span> <span class="main">¬</span>isl <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsψ</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs_ys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> <span class="free">Xφ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> <span class="free">Xψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> σxs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="free">nsφ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">fsφ</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="free">nsφ'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> σys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> map <span class="free">σys</span> <span class="free">nsψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">fsψ</span> <span class="main">=</span> map <span class="free">σys</span> <span class="free">nsψ'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fsφ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fsφ</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">nsφ'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fsψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fsψ</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">nsψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>map <span class="free">σys</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> <span class="free">nsψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> <span class="free">nsφ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ'</span> <span class="free">fsφ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>zip <span class="free">nys</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="free">nys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span> <span class="free">cys</span><span class="main">)</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"map <span class="free">σxs</span> <span class="free">nys</span> <span class="main">∈</span>
      nall_tuples_rec <span class="main">{}</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">nys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> len_xs_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">nsφ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">nsψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_ys_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Xφ_def Xψ_def proj_vals_def fo_nmlz_length<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_fsφ<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fsφ</span> <span class="main">=</span> length <span class="free">nsφ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> σxs_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> set_nsφ'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">nsφ'</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">cys</span><span class="main">)</span> <span class="main">∪</span> set <span class="free">nys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_xs_ys<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def cys_def nys_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_eqI in_set_impl_in_set_zip1 mem_Collect_eq
        prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> Inl <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">fsφ</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">AD</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> Inl <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">∪</span> set <span class="free">fsψ</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">AD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_ys_def fo_nmlz_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span><span class="main">]</span> nall_tuples_rec_Inl<span class="main">[</span><span class="operator">OF</span> fsφ_def<span class="main">]</span>
      nall_tuples_rec_Inl<span class="main">[</span><span class="operator">OF</span> fsψ_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Xφ_def Xψ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Inl_xs_ys<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free">nsφ</span> <span class="main">∪</span> set <span class="free">nsψ</span> <span class="main">⟹</span> isl <span class="main">(</span><span class="free">σxs</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">σxs</span> <span class="bound">n</span> <span class="main">=</span> Inl <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">AD</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free">nsφ</span> <span class="main">∪</span> set <span class="free">nsψ</span> <span class="main">⟹</span> isl <span class="main">(</span><span class="free">σys</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">σys</span> <span class="bound">n</span> <span class="main">=</span> Inl <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">AD</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> σxs_def σys_def nsφ'_def nsψ'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isl_def<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> imageI mem_Collect_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> sort_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> <span class="free">nsφ'</span><span class="main">)</span> <span class="main">=</span> sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> <span class="free">nsψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_distinct_set_unique<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> distinct
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def nsψ'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> isl_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free">nsφ'</span> <span class="main">∪</span> set <span class="free">nsψ'</span> <span class="main">⟹</span> isl <span class="main">(</span><span class="free">σxs</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∨</span> isl <span class="main">(</span><span class="free">σys</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">σxs</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">σys</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr Inl_xs_ys
    <span class="keyword1"><span class="command">unfolding</span></span> sort_sort<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> ad_agr_list_link<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> nsφ'_def nsψ'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnI2 image_eqI mem_Collect_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnI2 image_eqI mem_Collect_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnI1 image_eqI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">cys</span><span class="main">)</span> <span class="main">⟹</span> isl <span class="main">(</span><span class="free">σxs</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">cxs</span><span class="main">)</span> <span class="main">⟹</span> isl <span class="main">(</span><span class="free">σys</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> isl_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def nsφ'_def σys_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cxs_def nsψ'_def σxs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_zip<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> nth_mem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Inr_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"Inr <span class="main">-`</span> set <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Inr <span class="main">-`</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> σxs_def<span class="main">(</span>1<span class="main">)</span> σys_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zip_map_fst_snd <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> fst_conv image_iff sum.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> map_nys<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">σxs</span> <span class="free">nys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>isl <span class="bound">x</span><span class="main">)</span> <span class="free">fsφ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> isl_iff<span class="main">[</span><span class="operator">unfolded</span> nsφ'_def<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> nys_def σys_def<span class="main">(</span>1<span class="main">)</span> σxs_def<span class="main">(</span>2<span class="main">)</span> nsφ'_def filter_map
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nsψ</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> map_nys_in_nall<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">σxs</span> <span class="free">nys</span> <span class="main">∈</span> nall_tuples_rec <span class="main">{}</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">nys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nall_tuples_rec_filter<span class="main">[</span><span class="operator">OF</span> fsφ_def<span class="main"><span class="main">[</span></span><span class="operator">folded</span> len_fsφ<span class="main"><span class="main">]</span></span> map_nys<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> map_cys<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cys</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="main">(</span>map fst <span class="free">cys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> isl_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def set_zip nsφ'_def σys_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> nth_mem<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> merge_xs_cys<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span> <span class="free">cys</span><span class="main">)</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zip_map_fst_snd<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">cys</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> σxs_def<span class="main">(</span>1<span class="main">)</span> map_cys
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_map<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> distinct
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def σys_def sorted_filter distinct_map_filter map_fst_zip_take<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> merge_nys_prems<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nys</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="free">nys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct len_xs_ys<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def nys_def distinct_map_filter sorted_filter<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> eq_key_imp_eq_value map_fst_zip<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> map_snd_merge_nys<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span> <span class="main">@</span> <span class="free">nys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>zip <span class="free">nys</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="free">nys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> merge_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> merge_nys_prems<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sort_sort_nys<span class="main">:</span> <span class="quoted"><span class="quoted">"sort <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span> <span class="main">@</span> <span class="free">nys</span><span class="main">)</span> <span class="main">=</span> sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> <span class="free">nsφ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_distinct_set_unique<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> distinct merge_nys_prems set_nsφ'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def nys_def nsφ'_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> map_merge_fsφ<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ'</span> <span class="free">fsφ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> <span class="free">nsφ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> σxs_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_map<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> distinct sorted_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ'</span> <span class="free">fsφ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>zip <span class="free">nys</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="free">nys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_merge_fsφ map_snd_merge_nys<span class="main">[</span><span class="operator">unfolded</span> sort_sort_nys<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map <span class="free">σxs</span> <span class="free">nys</span> <span class="main">∈</span> nall_tuples_rec <span class="main">{}</span>
    <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">nys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_nys_in_nall
    <span class="keyword1"><span class="command">unfolding</span></span> Inr_sort<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_conj_set_aux'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nsφ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nsφ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsφ</span><span class="main">)</span> <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nsψ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nsψ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsψ</span><span class="main">)</span> <span class="free">nsφ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Xφ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Xφ</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">Rφ</span> <span class="free">nsφ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Xψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Xψ</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">Rψ</span> <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsφ</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cxs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cxs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsψ</span> <span class="main">∧</span> isl <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nxs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nxs</span> <span class="main">=</span> map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsψ</span> <span class="main">∧</span> <span class="main">¬</span>isl <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsφ</span> <span class="main">∧</span> isl <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsψ</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nys</span> <span class="main">=</span> map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsφ</span> <span class="main">∧</span> <span class="main">¬</span>isl <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsψ</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs_ys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> <span class="free">Xφ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> <span class="free">Xψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> σxs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="free">nsφ</span>"</span></span> <span class="quoted"><span class="quoted">"map snd <span class="free">cys</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="main">(</span>map fst <span class="free">cys</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">ysψ</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="free">nys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> σys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> map <span class="free">σys</span> <span class="free">nsψ</span>"</span></span> <span class="quoted"><span class="quoted">"map snd <span class="free">cxs</span> <span class="main">=</span> map <span class="free">σys</span> <span class="main">(</span>map fst <span class="free">cxs</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">xsφ</span> <span class="main">=</span> map <span class="free">σys</span> <span class="free">nxs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fsφ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fsφ</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="free">nsφ'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fsψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fsψ</span> <span class="main">=</span> map <span class="free">σys</span> <span class="free">nsψ'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ysψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">σxs</span> <span class="free">nys</span> <span class="main">∈</span> nall_tuples_rec <span class="main">{}</span>
      <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">nys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Inl_set_AD<span class="main">:</span> <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> <span class="main">(</span>set <span class="main">(</span>map snd <span class="free">cxs</span><span class="main">)</span> <span class="main">∪</span> set <span class="free">xsφ</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
      <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> <span class="main">(</span>set <span class="main">(</span>map snd <span class="free">cys</span><span class="main">)</span> <span class="main">∪</span> set <span class="free">ysψ</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>map <span class="free">σys</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> <span class="free">nsψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> <span class="free">nsφ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ'</span> <span class="free">fsφ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>zip <span class="free">nys</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="free">nys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span> <span class="free">cys</span><span class="main">)</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fsφ</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">nsφ'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> len_xs_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">nsφ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">nsψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_ys_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Xφ_def Xψ_def proj_vals_def fo_nmlz_length<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_fsφ<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">fsφ</span> <span class="main">=</span> length <span class="free">nsφ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fsφ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">nsφ'</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">cys</span><span class="main">)</span> <span class="main">∪</span> set <span class="free">nys</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="free">nsψ'</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">cxs</span><span class="main">)</span> <span class="main">∪</span> set <span class="free">nxs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_xs_ys
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def cys_def nys_def nsψ'_def cxs_def nxs_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_eqI in_set_impl_in_set_zip1 mem_Collect_eq
        prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> set_σ_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σxs</span> <span class="main">`</span> set <span class="free">nsψ'</span> <span class="main">∪</span> <span class="free">σxs</span> <span class="main">`</span> set <span class="free">nsφ'</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="main">(</span>map snd <span class="free">cys</span><span class="main">)</span> <span class="main">∪</span> set <span class="free">ysψ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">σys</span> <span class="main">`</span> set <span class="free">nsφ'</span> <span class="main">∪</span> <span class="free">σys</span> <span class="main">`</span> set <span class="free">nsψ'</span> <span class="main">⊆</span> set <span class="free">ys</span> <span class="main">∪</span> set <span class="main">(</span>map snd <span class="free">cxs</span><span class="main">)</span> <span class="main">∪</span> set <span class="free">xsφ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σxs_def σys_def nsφ'_def nsψ'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Inl_sub_AD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> Inl <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="main">(</span>map snd <span class="free">cys</span><span class="main">)</span> <span class="main">∪</span> set <span class="free">ysψ</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">AD</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> Inl <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">∪</span> set <span class="main">(</span>map snd <span class="free">cxs</span><span class="main">)</span> <span class="main">∪</span> set <span class="free">xsφ</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">AD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_ys_def fo_nmlz_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span><span class="main">]</span> Inl_set_AD
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Xφ_def Xψ_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> in_set_zipE set_map subset_eq vimageI zip_map_fst_snd<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Inl_xs_ys<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free">nsφ'</span> <span class="main">∪</span> set <span class="free">nsψ'</span> <span class="main">⟹</span> isl <span class="main">(</span><span class="free">σxs</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">σxs</span> <span class="bound">n</span> <span class="main">=</span> Inl <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">AD</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free">nsφ'</span> <span class="main">∪</span> set <span class="free">nsψ'</span> <span class="main">⟹</span> isl <span class="main">(</span><span class="free">σys</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">σys</span> <span class="bound">n</span> <span class="main">=</span> Inl <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">AD</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_σ_ns
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isl_def rev_image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sort_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> <span class="free">nsφ'</span><span class="main">)</span> <span class="main">=</span> sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> <span class="free">nsψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_distinct_set_unique<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> distinct
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def nsψ'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> isl_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free">nsφ'</span> <span class="main">∪</span> set <span class="free">nsψ'</span> <span class="main">⟹</span> isl <span class="main">(</span><span class="free">σxs</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∨</span> isl <span class="main">(</span><span class="free">σys</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">σxs</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">σys</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr Inl_xs_ys
    <span class="keyword1"><span class="command">unfolding</span></span> sort_sort<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> ad_agr_list_link<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> nsφ'_def nsψ'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_sets_def<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnI2 image_eqI mem_Collect_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnI2 image_eqI mem_Collect_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnI1 image_eqI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">cys</span><span class="main">)</span> <span class="main">⟹</span> isl <span class="main">(</span><span class="free">σxs</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">cxs</span><span class="main">)</span> <span class="main">⟹</span> isl <span class="main">(</span><span class="free">σys</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> isl_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def nsφ'_def σys_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cxs_def nsψ'_def σxs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_zip<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> nth_mem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Inr_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"Inr <span class="main">-`</span> set <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Inr <span class="main">-`</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> σxs_def<span class="main">(</span>1<span class="main">)</span> σys_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zip_map_fst_snd <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> fst_conv image_iff sum.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> map_nys<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">σxs</span> <span class="free">nys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>isl <span class="bound">x</span><span class="main">)</span> <span class="free">fsφ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> isl_iff<span class="main">[</span><span class="operator">unfolded</span> nsφ'_def<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> nys_def σys_def<span class="main">(</span>1<span class="main">)</span> fsφ_def nsφ'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">nsψ</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> map_cys<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cys</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="main">(</span>map fst <span class="free">cys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> isl_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def set_zip nsφ'_def σys_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> nth_mem<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> merge_xs_cys<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span> <span class="free">cys</span><span class="main">)</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zip_map_fst_snd<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">cys</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> σxs_def<span class="main">(</span>1<span class="main">)</span> map_cys
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_map<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> distinct
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def σys_def sorted_filter distinct_map_filter map_fst_zip_take<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> merge_nys_prems<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nys</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="free">nys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct len_xs_ys<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def nys_def distinct_map_filter sorted_filter<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> eq_key_imp_eq_value map_fst_zip<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> map_snd_merge_nys<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span> <span class="main">@</span> <span class="free">nys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>zip <span class="free">nys</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="free">nys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> merge_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> merge_nys_prems<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sort_sort_nys<span class="main">:</span> <span class="quoted"><span class="quoted">"sort <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span> <span class="main">@</span> <span class="free">nys</span><span class="main">)</span> <span class="main">=</span> sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> <span class="free">nsφ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_distinct_set_unique<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> distinct merge_nys_prems set_ns
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def nys_def nsφ'_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> map_merge_fsφ<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ'</span> <span class="free">fsφ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> <span class="free">nsφ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> σxs_def fsφ_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_map<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> distinct sorted_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ'</span> <span class="free">fsφ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="free">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>zip <span class="free">nys</span> <span class="main">(</span>map <span class="free">σxs</span> <span class="free">nys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_merge_fsφ map_snd_merge_nys<span class="main">[</span><span class="operator">unfolded</span> sort_sort_nys<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> set <span class="free">fsφ</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Inl_sub_AD<span class="main">(</span>1<span class="main">)</span> set_σ_ns
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fsφ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">fsφ</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">nsφ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> len_fsφ<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> nall_tuples_rec_filter_rev<span class="main">[</span><span class="operator">OF</span> _ map_nys<span class="main">]</span> ysψ_def<span class="main">[</span><span class="operator">unfolded</span> Inr_sort<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_conj_set_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nsφ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nsφ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsφ</span><span class="main">)</span> <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nsψ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nsψ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsψ</span><span class="main">)</span> <span class="free">nsφ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Xφ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Xφ</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">Rφ</span> <span class="free">nsφ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Xψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Xψ</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">Rψ</span> <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsφ</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_conj_set <span class="free">AD</span> <span class="free">nsφ</span> <span class="free">Xφ</span> <span class="free">nsψ</span> <span class="free">Xψ</span> <span class="main">=</span> ext_tuple_set <span class="free">AD</span> <span class="free">nsφ</span> <span class="free">nsφ'</span> <span class="free">Xφ</span> <span class="main">∩</span> ext_tuple_set <span class="free">AD</span> <span class="free">nsψ</span> <span class="free">nsψ'</span> <span class="free">Xψ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_tuple_set <span class="free">AD</span> <span class="free">nsφ</span> <span class="free">nsφ'</span> <span class="free">Xφ</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>ext_tuple <span class="free">AD</span> <span class="free">nsφ</span> <span class="free">nsφ'</span> <span class="main">`</span> <span class="free">Xφ</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"ext_tuple_set <span class="free">AD</span> <span class="free">nsψ</span> <span class="free">nsψ'</span> <span class="free">Xψ</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>ext_tuple <span class="free">AD</span> <span class="free">nsψ</span> <span class="free">nsψ'</span> <span class="main">`</span> <span class="free">Xψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ext_tuple_set_def ext_tuple_def Xφ_def Xψ_def image_iff fo_nmlz_idem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_sound<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>ext_tuple <span class="free">AD</span> <span class="free">nsφ</span> <span class="free">nsφ'</span> <span class="main">`</span> <span class="free">Xφ</span><span class="main">)</span> <span class="main">∩</span>
    fo_nmlz <span class="free">AD</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>ext_tuple <span class="free">AD</span> <span class="free">nsψ</span> <span class="free">nsψ'</span> <span class="main">`</span> <span class="free">Xψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs_ys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">Xφ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> ext_tuple <span class="free">AD</span> <span class="free">nsφ</span> <span class="free">nsφ'</span> <span class="skolem">xs</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> <span class="free">Xψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> ext_tuple <span class="free">AD</span> <span class="free">nsψ</span> <span class="free">nsψ'</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> len_xs_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="free">nsφ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> length <span class="free">nsψ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs_ys_def<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Xφ_def Xψ_def proj_vals_def fo_nmlz_length<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fsφ</span></span> <span class="keyword2"><span class="keyword">where</span></span> fsφ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ'</span> <span class="skolem">fsφ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">fsφ</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">nsφ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs_ys_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Xφ_def proj_vals_def ext_tuple_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> fo_nmlz_map length_map map_snd_zip<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fsψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> fsψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsψ'</span> <span class="skolem">fsψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">fsψ</span> <span class="main">∈</span> nall_tuples_rec <span class="free">AD</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="free">nsψ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs_ys_def<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Xψ_def proj_vals_def ext_tuple_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> fo_nmlz_map length_map map_snd_zip<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> len_fsφ <span class="main">=</span> nall_tuples_rec_length<span class="main">[</span><span class="operator">OF</span> fsφ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> len_fsψ <span class="main">=</span> nall_tuples_rec_length<span class="main">[</span><span class="operator">OF</span> fsψ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σxs</span></span> <span class="keyword2"><span class="keyword">where</span></span> σxs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> map <span class="skolem">σxs</span> <span class="free">nsφ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fsφ</span> <span class="main">=</span> map <span class="skolem">σxs</span> <span class="free">nsφ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exists_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">nsφ</span> <span class="main">@</span> <span class="free">nsφ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">fsφ</span>"</span></span><span class="main">]</span> len_xs_ys<span class="main">(</span>1<span class="main">)</span> len_fsφ distinct
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σys</span></span> <span class="keyword2"><span class="keyword">where</span></span> σys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> map <span class="skolem">σys</span> <span class="free">nsψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fsψ</span> <span class="main">=</span> map <span class="skolem">σys</span> <span class="free">nsψ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exists_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">nsψ</span> <span class="main">@</span> <span class="free">nsψ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">fsψ</span>"</span></span><span class="main">]</span> len_xs_ys<span class="main">(</span>2<span class="main">)</span> len_fsψ distinct
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsψ'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> map_merge_fsφ<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ'</span> <span class="skolem">fsφ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> <span class="free">nsφ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> σxs_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_map<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> distinct sorted_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> map_merge_fsψ<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsψ'</span> <span class="skolem">fsψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">σys</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> <span class="free">nsψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> σys_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_map<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> distinct sorted_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsψ'_def<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cxs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cxs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsψ</span> <span class="main">∧</span> isl <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nxs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nxs</span> <span class="main">=</span> map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsψ</span> <span class="main">∧</span> <span class="main">¬</span>isl <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsφ</span> <span class="main">∧</span> isl <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nys</span> <span class="main">=</span> map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsφ</span> <span class="main">∧</span> <span class="main">¬</span>isl <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> ad_agr1 <span class="main">=</span> fo_nmlz_eqD<span class="main">[</span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fsφ_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fsψ_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span>
        <span class="operator">unfolded</span> map_merge_fsφ map_merge_fsψ<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> ad_agr2 <span class="main">=</span> ad_agr_list_comm<span class="main">[</span><span class="operator">OF</span> ad_agr1<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σxs</span></span> <span class="keyword2"><span class="keyword">where</span></span> aux1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ'</span> <span class="skolem">fsφ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>zip <span class="skolem">nys</span> <span class="main">(</span>map <span class="skolem">σxs</span> <span class="skolem">nys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"map <span class="skolem">σxs</span> <span class="skolem">nys</span> <span class="main">∈</span> nall_tuples_rec <span class="main">{}</span>
      <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="main">(</span>map <span class="skolem">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">nys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_conj_set_aux<span class="main">[</span><span class="operator">OF</span> nsφ'_def nsψ'_def Xφ_def Xψ_def distinct cxs_def nxs_def
          cys_def nys_def xs_ys_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> σxs_def σys_def fsφ_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> fsψ_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> ad_agr2<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σys</span></span> <span class="keyword2"><span class="keyword">where</span></span> aux2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsψ'</span> <span class="skolem">fsψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">σys</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>zip <span class="skolem">nxs</span> <span class="main">(</span>map <span class="skolem">σys</span> <span class="skolem">nxs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">σys</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"map <span class="skolem">σys</span> <span class="skolem">nxs</span> <span class="main">∈</span> nall_tuples_rec <span class="main">{}</span>
      <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="main">(</span>map <span class="skolem">σys</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">nxs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_conj_set_aux<span class="main">[</span><span class="operator">OF</span> nsψ'_def nsφ'_def Xψ_def Xφ_def distinct<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> cys_def nys_def
          cxs_def nxs_def xs_ys_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> σys_def σxs_def fsψ_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> fsφ_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> ad_agr1<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> vs_ext_nys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> ext_tuple <span class="main">{}</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nys</span>
    <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> aux1<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> fsφ_def<span class="main">(</span>1<span class="main">)</span> aux1<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ext_tuple_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> length_map<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> aux1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> vs_ext_nxs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> ext_tuple <span class="main">{}</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nxs</span>
    <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> aux2<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> fsψ_def<span class="main">(</span>1<span class="main">)</span> aux2<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ext_tuple_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> length_map<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> aux2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> eval_conj_set <span class="free">AD</span> <span class="free">nsφ</span> <span class="free">Xφ</span> <span class="free">nsψ</span> <span class="free">Xψ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vs_ext_nys vs_ext_nxs xs_ys_def<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_conj_set_def eval_conj_tuple_def nys_def cys_def nxs_def cxs_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> eval_conj_set <span class="free">AD</span> <span class="free">nsφ</span> <span class="free">Xφ</span> <span class="free">nsψ</span> <span class="free">Xψ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">cxs</span></span> <span class="skolem"><span class="skolem">nxs</span></span> <span class="skolem"><span class="skolem">cys</span></span> <span class="skolem"><span class="skolem">nys</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      cxs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cxs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsψ</span> <span class="main">∧</span> isl <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      nxs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nxs</span> <span class="main">=</span> map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsψ</span> <span class="main">∧</span> <span class="main">¬</span>isl <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsφ</span> <span class="main">∧</span> isl <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      nys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nys</span> <span class="main">=</span> map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> set <span class="free">nsφ</span> <span class="main">∧</span> <span class="main">¬</span>isl <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      xs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">Xφ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> ext_tuple <span class="main">{}</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nys</span>
      <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> <span class="free">Xψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> ext_tuple <span class="main">{}</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nxs</span>
      <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_conj_set_def eval_conj_tuple_def Let_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> len_xs_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="free">nsφ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> length <span class="free">nsψ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs_def<span class="main">(</span>1<span class="main">)</span> ys_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Xφ_def Xψ_def proj_vals_def fo_nmlz_length<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> len_merge_cys<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    length <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> merge_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"zip <span class="free">nsφ</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="skolem">cys</span></span><span class="main">]</span> len_xs_ys
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ysψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> ysψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">nys</span> <span class="skolem">ysψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ysψ</span> <span class="main">∈</span> nall_tuples_rec <span class="main">{}</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>length <span class="skolem">nys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ext_tuple_eq<span class="main">[</span><span class="operator">OF</span> len_merge_cys<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> distinct_nys<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span> <span class="main">@</span> <span class="skolem">nys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct len_xs_ys
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def nys_def sorted_filter distinct_map_filter<span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> eq_key_imp_eq_value map_fst_zip<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σxs</span></span> <span class="keyword2"><span class="keyword">where</span></span> σxs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> map <span class="skolem">σxs</span> <span class="free">nsφ</span>"</span></span> <span class="quoted"><span class="quoted">"map snd <span class="skolem">cys</span> <span class="main">=</span> map <span class="skolem">σxs</span> <span class="main">(</span>map fst <span class="skolem">cys</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ysψ</span> <span class="main">=</span> map <span class="skolem">σxs</span> <span class="skolem">nys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exists_map<span class="main">[</span><span class="operator">OF</span> _ distinct_nys<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> map snd <span class="skolem">cys</span> <span class="main">@</span> <span class="skolem">ysψ</span>"</span></span><span class="main">]</span> len_xs_ys<span class="main">(</span>1<span class="main">)</span>
        nall_tuples_rec_length<span class="main">[</span><span class="operator">OF</span> ysψ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> len_merge_cxs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    length <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> merge_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"zip <span class="free">nsψ</span> <span class="skolem">ys</span>"</span></span><span class="main">]</span> len_xs_ys
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xsφ</span></span> <span class="keyword2"><span class="keyword">where</span></span> xsφ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">nxs</span> <span class="skolem">xsφ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">xsφ</span> <span class="main">∈</span> nall_tuples_rec <span class="main">{}</span> <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="main">(</span>map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>length <span class="skolem">nxs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ys_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ext_tuple_eq<span class="main">[</span><span class="operator">OF</span> len_merge_cxs<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> distinct_nxs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span> <span class="main">@</span> <span class="skolem">nxs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct len_xs_ys<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cxs_def nxs_def sorted_filter distinct_map_filter<span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> eq_key_imp_eq_value map_fst_zip<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σys</span></span> <span class="keyword2"><span class="keyword">where</span></span> σys_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> map <span class="skolem">σys</span> <span class="free">nsψ</span>"</span></span> <span class="quoted"><span class="quoted">"map snd <span class="skolem">cxs</span> <span class="main">=</span> map <span class="skolem">σys</span> <span class="main">(</span>map fst <span class="skolem">cxs</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">xsφ</span> <span class="main">=</span> map <span class="skolem">σys</span> <span class="skolem">nxs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exists_map<span class="main">[</span><span class="operator">OF</span> _ distinct_nxs<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">@</span> map snd <span class="skolem">cxs</span> <span class="main">@</span> <span class="skolem">xsφ</span>"</span></span><span class="main">]</span> len_xs_ys<span class="main">(</span>2<span class="main">)</span>
        nall_tuples_rec_length<span class="main">[</span><span class="operator">OF</span> xsφ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsψ'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> sd_cs_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="main">(</span>map fst <span class="skolem">cxs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="skolem">nxs</span>"</span></span>
      <span class="quoted"><span class="quoted">"sorted_distinct <span class="main">(</span>map fst <span class="skolem">cys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="skolem">nys</span>"</span></span>
      <span class="quoted"><span class="quoted">"sorted_distinct <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"sorted_distinct <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct len_xs_ys
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cxs_def nxs_def cys_def nys_def sorted_filter distinct_map_filter<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> set_cs_ns_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">cxs</span><span class="main">)</span> <span class="main">∩</span> set <span class="skolem">nxs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">cys</span><span class="main">)</span> <span class="main">∩</span> set <span class="skolem">nys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="quoted"><span class="quoted">"set <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="skolem">nys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="quoted"><span class="quoted">"set <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="skolem">nxs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct nth_eq_iff_index_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cxs_def nxs_def cys_def nys_def set_zip<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> merge_sort_cxs<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsψ</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">cxs</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">σys</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> σys_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zip_map_fst_snd<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">cxs</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> σys_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_map<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> distinct<span class="main">(</span>2<span class="main">)</span> sd_cs_ns
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cxs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> merge_sort_cys<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>merge <span class="main">(</span>zip <span class="free">nsφ</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">cys</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> σxs_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zip_map_fst_snd<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">cys</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> σxs_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> merge_map<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> distinct<span class="main">(</span>1<span class="main">)</span> sd_cs_ns
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> set_nsφ'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">nsφ'</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="skolem">cys</span><span class="main">)</span> <span class="main">∪</span> set <span class="skolem">nys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> len_xs_ys<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def cys_def nys_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_eqI in_set_impl_in_set_zip1 mem_Collect_eq
          prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> sort_sort_nys<span class="main">:</span> <span class="quoted"><span class="quoted">"sort <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> map fst <span class="skolem">cys</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">nys</span><span class="main">)</span> <span class="main">=</span> sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> <span class="free">nsφ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_distinct_set_unique<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> distinct sd_cs_ns set_cs_ns_disj set_nsφ'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cys_def nys_def nsφ'_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> set_nsψ'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">nsψ'</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="skolem">cxs</span><span class="main">)</span> <span class="main">∪</span> set <span class="skolem">nxs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> len_xs_ys<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsψ'_def cxs_def nxs_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_eqI in_set_impl_in_set_zip1 mem_Collect_eq
          prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> sort_sort_nxs<span class="main">:</span> <span class="quoted"><span class="quoted">"sort <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> map fst <span class="skolem">cxs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">nxs</span><span class="main">)</span> <span class="main">=</span> sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> <span class="free">nsψ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_distinct_set_unique<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> distinct sd_cs_ns set_cs_ns_disj set_nsψ'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cxs_def nxs_def nsψ'_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ad_agr1<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">σys</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsψ</span> <span class="main">@</span> <span class="free">nsψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">σxs</span> <span class="main">(</span>sort <span class="main">(</span><span class="free">nsφ</span> <span class="main">@</span> <span class="free">nsφ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fo_nmlz_eqD<span class="main">[</span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xsφ_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ysψ_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> σxs_def<span class="main">(</span>3<span class="main">)</span> σys_def<span class="main">(</span>3<span class="main">)</span> merge_sort_cxs merge_sort_cys
      <span class="keyword1"><span class="command">unfolding</span></span> merge_map<span class="main">[</span><span class="operator">OF</span> sd_cs_ns<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> sd_cs_ns<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> set_cs_ns_disj<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> merge_map<span class="main">[</span><span class="operator">OF</span> sd_cs_ns<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> sd_cs_ns<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> set_cs_ns_disj<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> sort_sort_nxs sort_sort_nys <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">note</span></span> ad_agr2 <span class="main">=</span> ad_agr_list_comm<span class="main">[</span><span class="operator">OF</span> ad_agr1<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> Inl_set_AD<span class="main">:</span> <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> <span class="main">(</span>set <span class="main">(</span>map snd <span class="skolem">cxs</span><span class="main">)</span> <span class="main">∪</span> set <span class="skolem">xsφ</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
      <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> <span class="main">(</span>set <span class="main">(</span>map snd <span class="skolem">cys</span><span class="main">)</span> <span class="main">∪</span> set <span class="skolem">ysψ</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs_def<span class="main">(</span>1<span class="main">)</span> nall_tuples_rec_Inl<span class="main">[</span><span class="operator">OF</span> xsφ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> ys_def<span class="main">(</span>1<span class="main">)</span>
        nall_tuples_rec_Inl<span class="main">[</span><span class="operator">OF</span> ysψ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> fo_nmlz_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cxs_def Xφ_def cys_def Xψ_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_zip_rightD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">note</span></span> aux1 <span class="main">=</span> eval_conj_set_aux'<span class="main">[</span><span class="operator">OF</span> nsφ'_def nsψ'_def Xφ_def Xψ_def distinct cxs_def nxs_def
        cys_def nys_def xs_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> ys_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> σxs_def σys_def refl refl
        ysψ_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span> σxs_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> merge_sort_cys<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span> Inl_set_AD ad_agr1<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> aux2 <span class="main">=</span> eval_conj_set_aux'<span class="main">[</span><span class="operator">OF</span> nsψ'_def nsφ'_def Xψ_def Xφ_def distinct<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> cys_def nys_def
        cxs_def nxs_def ys_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> xs_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> σys_def σxs_def refl refl
        xsφ_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span> σys_def<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> merge_sort_cxs<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span> Inl_set_AD<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> ad_agr2<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>ext_tuple <span class="free">AD</span> <span class="free">nsφ</span> <span class="free">nsφ'</span> <span class="main">`</span> <span class="free">Xφ</span><span class="main">)</span> <span class="main">∩</span>
    fo_nmlz <span class="free">AD</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>ext_tuple <span class="free">AD</span> <span class="free">nsψ</span> <span class="free">nsψ'</span> <span class="main">`</span> <span class="free">Xψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs_def<span class="main">(</span>1<span class="main">)</span> ys_def<span class="main">(</span>1<span class="main">)</span> ysψ_def<span class="main">(</span>1<span class="main">)</span> xsφ_def<span class="main">(</span>1<span class="main">)</span> aux1<span class="main">(</span>3<span class="main">)</span> aux2<span class="main">(</span>3<span class="main">)</span>
        ext_tuple_eq<span class="main">[</span><span class="operator">OF</span> len_xs_ys<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">nsφ'</span></span><span class="main">]</span>
        ext_tuple_eq<span class="main">[</span><span class="operator">OF</span> len_xs_ys<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">nsψ'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> aux1<span class="main">(</span>2<span class="main">)</span> aux2<span class="main">(</span>2<span class="main">)</span> σys_def<span class="main">(</span>3<span class="main">)</span> σxs_def<span class="main">(</span>3<span class="main">)</span> aux1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> aux2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> esat_exists_not_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> fv_fo_fmla <span class="free">φ</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span>
  esat <span class="main">(</span>Exists <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="free">σ</span> <span class="free">X</span> <span class="main">⟷</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> fv_fo_fmla <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="free">σ</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> esat_fv_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> fv_fo_fmla <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> esat_fv_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> x_def <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="free">σ</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> esat_forall_not_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> fv_fo_fmla <span class="free">φ</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span>
  esat <span class="main">(</span>Forall <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="free">σ</span> <span class="free">X</span> <span class="main">⟷</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> esat_exists_not_fv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"Neg <span class="free">φ</span>"</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> proj_sat_vals<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_sat <span class="free">φ</span> <span class="free">I</span> <span class="main">=</span>
  proj_vals <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> sat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span><span class="main">}</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_sat_def proj_vals_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_fo_fmla_list_Pred<span class="main">:</span> <span class="quoted"><span class="quoted">"remdups_adj <span class="main">(</span>sort <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fv_fo_terms_list <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_fo_terms_list_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_remdups_adj_sort remdups_adj_distinct sorted_sort_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_fv_list'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map set_fo_term <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span>
  ad_agr_list <span class="free">X</span> <span class="main">(</span>map <span class="free">σ</span> <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">τ</span> <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  ad_agr_list <span class="free">X</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span> <span class="main">(</span><span class="free">τ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">X</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊙e</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span><span class="free">τ</span> <span class="keyword1">⊙e</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_link<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fv_fo_terms_set_list
        fv_fo_terms_set_def sp_equiv_list_link sp_equiv_def pairwise_def<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> ad_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> fv_fo_term_set <span class="skolem">t</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>fv_fo_term_set <span class="main">`</span> set <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span>
    ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">,</span> <span class="free">τ</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_link<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fv_fo_terms_set_list
        fv_fo_terms_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sp_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> fv_fo_term_set <span class="skolem">t</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>fv_fo_term_set <span class="main">`</span> set <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="bound">j</span> <span class="main">∈</span> fv_fo_term_set <span class="skolem">t</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>fv_fo_term_set <span class="main">`</span> set <span class="skolem">ts</span><span class="main">)</span> <span class="main">⟹</span> sp_equiv_pair <span class="main">(</span><span class="free">σ</span> <span class="bound">i</span><span class="main">,</span> <span class="free">τ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span> <span class="bound">j</span><span class="main">,</span> <span class="free">τ</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def sp_equiv_list_link fv_fo_terms_set_list
        fv_fo_terms_set_def sp_equiv_def pairwise_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Const <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH Cons<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def eval_eterms_def ad_equiv_list_def Const
          sp_equiv_list_def pairwise_def set_zip<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> nth_map rev_image_eqI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> t_def <span class="main">=</span> Var
    <span class="keyword1"><span class="command">have</span></span> ad<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_equiv_pair <span class="free">X</span> <span class="main">(</span><span class="free">σ</span> <span class="skolem">n</span><span class="main">,</span> <span class="free">τ</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ad_equiv
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Var<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(⋅e)</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(⋅e)</span> <span class="free">τ</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">(</span><span class="free">σ</span> <span class="skolem">n</span><span class="main">,</span> <span class="free">τ</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⟹</span>
      sp_equiv_pair <span class="main">(</span><span class="free">σ</span> <span class="skolem">n</span><span class="main">,</span> <span class="free">τ</span> <span class="skolem">n</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∧</span> sp_equiv_pair <span class="bound">y</span> <span class="main">(</span><span class="free">σ</span> <span class="skolem">n</span><span class="main">,</span> <span class="free">τ</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(⋅e)</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">(⋅e)</span> <span class="free">τ</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⋅e</span> <span class="skolem">t'</span><span class="main">,</span> <span class="free">τ</span> <span class="keyword1">⋅e</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nth_mem
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip<span class="main">)</span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sp_equiv_pair <span class="main">(</span><span class="free">σ</span> <span class="skolem">n</span><span class="main">,</span> <span class="free">τ</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">∧</span> sp_equiv_pair <span class="skolem">y</span> <span class="main">(</span><span class="free">σ</span> <span class="skolem">n</span><span class="main">,</span> <span class="free">τ</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Const <span class="skolem">c'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> c'_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> y_def<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Const<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> SUP_le_iff fo_term.set_intros subsetD<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> ad_equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> y_def<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> y_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Const t_def<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> rev_image_eqI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">n'</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> sp_equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span> y_def<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> y_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def Var<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IH Cons<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def eval_eterms_def ad_equiv_list_def Var ad sp_equiv_list_def
          pairwise_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def ad_agr_list_def ad_equiv_list_def sp_equiv_list_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ext_tuple_ad_agr_close<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Sφ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Sφ</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> AD_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"act_edom <span class="free">φ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">ADφ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ADφ</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Xφ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Xφ</span> <span class="main">=</span> fo_nmlz <span class="free">ADφ</span> <span class="main">`</span> proj_vals <span class="free">Sφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nsφ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nsφ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> fv_fo_fmla <span class="free">φ</span><span class="main">)</span> <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sd_nsψ<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fv_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_fmla <span class="free">ψ</span> <span class="main">=</span> fv_fo_fmla <span class="free">φ</span> <span class="main">∪</span> set <span class="free">nsψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ext_tuple_set <span class="free">AD</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">nsφ'</span> <span class="main">(</span>ad_agr_close_set <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">ADφ</span><span class="main">)</span> <span class="free">Xφ</span><span class="main">)</span> <span class="main">=</span>
    fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">Sφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"ad_agr_close_set <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">ADφ</span><span class="main">)</span> <span class="free">Xφ</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">Sφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ad_agr_φ<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> ad_agr_sets <span class="main">(</span>set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">ADφ</span> <span class="bound">σ</span> <span class="bound">τ</span> <span class="main">⟹</span>
      <span class="bound">σ</span> <span class="main">∈</span> <span class="free">Sφ</span> <span class="main">⟷</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">Sφ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> esat_UNIV_cong<span class="main">[</span><span class="operator">OF</span> ad_agr_sets_restrict<span class="main">,</span> <span class="operator">OF</span> _ subset_refl<span class="main">]</span> ad_agr_sets_mono AD_sub
    <span class="keyword1"><span class="command">unfolding</span></span> Sφ_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> ad_close_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_close_set <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">ADφ</span><span class="main">)</span> <span class="free">Xφ</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">Sφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr_close_correct<span class="main">[</span><span class="operator">OF</span> AD_sub<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ad_agr_φ<span class="main">]</span> AD_sub<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Xφ_def Sφ_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> proj_fmla_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_close_set_def Set.is_empty_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fv_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fv_Un
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_set<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sd_nsφ'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsφ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sd_nsψ sorted_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ext_tuple_set <span class="free">AD</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">nsφ'</span> <span class="main">(</span>ad_agr_close_set <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">ADφ</span><span class="main">)</span> <span class="free">Xφ</span><span class="main">)</span> <span class="main">=</span>
    fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">Sφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext_tuple_correct<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> sorted_distinct_fv_list ad_close_alt ad_agr_φ ad_agr_sets_mono<span class="main">[</span><span class="operator">OF</span> AD_sub<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      fv_Un sd_nsφ'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def fv_fo_fmla_list_set<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_ext_tuple<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Sφ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Sφ</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> AD_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"act_edom <span class="free">φ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Xφ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Xφ</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_vals <span class="free">Sφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nsφ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nsφ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> fv_fo_fmla <span class="free">φ</span><span class="main">)</span> <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sd_nsψ<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fv_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_fmla <span class="free">ψ</span> <span class="main">=</span> fv_fo_fmla <span class="free">φ</span> <span class="main">∪</span> set <span class="free">nsψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Z_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">Z</span> <span class="main">⟹</span> fo_nmlz <span class="free">AD</span> <span class="bound">xs</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> length <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">∩</span> ext_tuple_set <span class="free">AD</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">nsφ'</span> <span class="free">Xφ</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">xs</span></span> <span class="main">∈</span> <span class="free">Z</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>proj_tuple <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Xφ</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">-</span> ext_tuple_set <span class="free">AD</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">nsφ'</span> <span class="free">Xφ</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">xs</span></span> <span class="main">∈</span> <span class="free">Z</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>proj_tuple <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">Xφ</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ad_agr_φ<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> ad_agr_sets <span class="main">(</span>set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">AD</span> <span class="bound">σ</span> <span class="bound">τ</span> <span class="main">⟹</span>
      <span class="bound">σ</span> <span class="main">∈</span> <span class="free">Sφ</span> <span class="main">⟷</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="free">Sφ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> esat_UNIV_cong<span class="main">[</span><span class="operator">OF</span> ad_agr_sets_restrict<span class="main">,</span> <span class="operator">OF</span> _ subset_refl<span class="main">]</span> ad_agr_sets_mono AD_sub
    <span class="keyword1"><span class="command">unfolding</span></span> Sφ_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> sd_nsφ'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="free">nsφ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sd_nsψ sorted_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="main">∩</span> set <span class="free">nsφ'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def fv_fo_fmla_list_set<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Un<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="main">∪</span> set <span class="free">nsφ'</span> <span class="main">=</span> set <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fv_Un
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ'_def fv_fo_fmla_list_set<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> proj <span class="main">=</span> proj_tuple_correct<span class="main">[</span><span class="operator">OF</span> sorted_distinct_fv_list sd_nsφ' sorted_distinct_fv_list
      disj Un Xφ_def ad_agr_φ<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">`</span> <span class="free">Xφ</span> <span class="main">=</span> <span class="free">Xφ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_idem<span class="main">[</span><span class="operator">OF</span> fo_nmlz_sound<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Xφ_def image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_tuple_set <span class="free">AD</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">nsφ'</span> <span class="free">Xφ</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>ext_tuple <span class="free">AD</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">nsφ'</span> <span class="main">`</span> <span class="free">Xφ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ext_tuple_set_def ext_tuple_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">∩</span> ext_tuple_set <span class="free">AD</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">nsφ'</span> <span class="free">Xφ</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">xs</span></span> <span class="main">∈</span> <span class="free">Z</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>proj_tuple <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Xφ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Z_props proj
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aux<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">-</span> ext_tuple_set <span class="free">AD</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">nsφ'</span> <span class="free">Xφ</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">xs</span></span> <span class="main">∈</span> <span class="free">Z</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>proj_tuple <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">Xφ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Z_props proj
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aux<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_proj_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="free">R</span> <span class="main">⊆</span> nall_tuples <span class="free">AD</span> <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map fo_nmlz_length fo_nmlz_sound nfv_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nall_tuplesI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fin_ad_agr_list_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">AD</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">vs</span><span class="main">.</span> <span class="bound">vs</span> <span class="main">∈</span> <span class="free">Z</span> <span class="main">⟹</span> length <span class="bound">vs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ts'</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> ad_agr_list <span class="free">AD</span> <span class="main">(</span>map Inl <span class="bound">ts</span><span class="main">)</span> <span class="bound">ts'</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Z</span> <span class="main">⟷</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free">Z</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Z</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free">Z</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="skolem">σ</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span> <span class="main">∈</span> <span class="free">Z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">i</span> <span class="main">∉</span> <span class="free">AD</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>map <span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> in_set_conv_nth<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> map_map map_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">≡</span> <span class="free">AD</span> <span class="main">∪</span> <span class="skolem">σ</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> inf_UNIV_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">-</span> <span class="skolem">Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Y_def infinite_UNIV<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∉</span> <span class="skolem">Y</span> <span class="main">⟹</span> map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">i</span> <span class="keyword1">then</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span> <span class="main">∈</span> <span class="free">Z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> σ_def<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ σ_def<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> ad_agr_list_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ σ_def<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def set_zip Y_def ad_equiv_pair.simps
        sp_equiv_list_def pairwise_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">i</span> <span class="keyword1">then</span> <span class="bound">x'</span> <span class="keyword1">else</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span>
    <span class="main">(</span>UNIV <span class="main">-</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">i</span> <span class="keyword1">then</span> <span class="bound">x'</span> <span class="keyword1">else</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> σ_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf_UNIV_Y fin
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> inj_on_diff inj_on_finite<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free">Z</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">⊆</span> all_tuples <span class="free">AD</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> all_tuplesI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_tuples_finite<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> finite_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_out_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">+</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">AD</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> ad_agr_list <span class="free">AD</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>Inl <span class="main">∘</span> <span class="bound">τ</span><span class="main">)</span> <span class="free">ns</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">j</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="free">ns</span> <span class="main">⟶</span> <span class="free">σ</span> <span class="bound">j</span> <span class="main">=</span> Inl <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">τ</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">AD</span> <span class="main">∪</span> Inl <span class="main">-`</span> set <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> finite_Inl<span class="main">[</span><span class="operator">OF</span> finite_set<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="skolem">f</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"range <span class="skolem">f</span> <span class="main">⊆</span> UNIV <span class="main">-</span> <span class="main">(</span><span class="free">AD</span> <span class="main">∪</span> Inl <span class="main">-`</span> set <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> arb_countable_map<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> case_sum id <span class="skolem">f</span> <span class="main">∘</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f_out<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Inl <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> DiffE UNIV_I UnCI imageI image_subset_iff mem_Collect_eq nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>map <span class="free">σ</span> <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">τ</span><span class="main">)</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
      <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip τ_def ad_equiv_pair.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>1<span class="main">)</span> f_out
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_list_def pairwise_def set_zip τ_def inj_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> τ_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">τ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_out<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">J</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_intp"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="free">φ</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Inl <span class="main">∘</span> <span class="bound">τ</span><span class="main">)</span> UNIV <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> fv_fo_fmla <span class="free">φ</span> <span class="main">∧</span> <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> Inl <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">τ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
    ad_agr_list <span class="main">(</span>act_edom <span class="free">φ</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>Inl <span class="main">∘</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proj_out_list<span class="main">[</span><span class="operator">OF</span> finite_act_edom<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="free">φ</span>"</span></span><span class="main">]</span>
    esat_UNIV_ad_agr_list<span class="main">[</span><span class="operator">OF</span> _ subset_refl<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_fo_fmla_list_set
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> proj_fmla_esat_sat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">J</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_intp"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="free">φ</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span> <span class="main">∩</span> map Inl <span class="main">`</span> UNIV <span class="main">=</span>
    map Inl <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> sat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sat_esat_conv<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span> <span class="main">∩</span> map Inl <span class="main">`</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="skolem">σ</span> UNIV"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="skolem">vs</span> <span class="main">⊆</span> range Inl"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> image_subset_iff list.set_map range_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">τ</span><span class="main">)</span> UNIV"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> fv_fo_fmla <span class="free">φ</span> <span class="main">⟹</span> <span class="skolem">σ</span> <span class="bound">i</span> <span class="main">=</span> Inl <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">τ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proj_out<span class="main">[</span><span class="operator">OF</span> assms σ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> map <span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> σ_def<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> τ_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_set<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> map Inl <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Inl <span class="main">∘</span> <span class="bound">σ</span><span class="main">)</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> τ_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_proj_fmla_esat_sat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="free">φ</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="main">(</span>act_edom <span class="free">φ</span> <span class="free">I</span><span class="main">)</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span> <span class="main">=</span>
    fo_nmlz <span class="main">(</span>act_edom <span class="free">φ</span> <span class="free">I</span><span class="main">)</span> <span class="main">`</span> map Inl <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> sat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> proj_fmla_esat_sat<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff proj_fmla_map<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> σ
    <span class="keyword1"><span class="command">using</span></span> proj_out<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> τ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> fo_nmlz_eqI<span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> map_map range_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_sat_fmla<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_sat <span class="free">φ</span> <span class="free">I</span> <span class="main">=</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> sat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_sat_def proj_fmla_map<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fo_wf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fo_wf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">⟷</span> finite <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">∧</span> finite <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span>
    wf_fo_intp <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">=</span> act_edom <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> fo_rep <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> proj_sat <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span>
    Inl <span class="main">-`</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">vs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> fo_nmlzd <span class="free"><span class="bound"><span class="entity">AD</span></span></span> <span class="bound">vs</span> <span class="main">∧</span> length <span class="bound">vs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fo_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fo_fin</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">.</span> isl <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_rep_fin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fo_fin <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_rep <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> map projl <span class="main">`</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_rep <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>map Inl <span class="skolem">vs</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> map Inl <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_def<span class="main">(</span>1<span class="main">)</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">meson</span> ex_map_conv isl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> xs_def<span class="main">(</span>1<span class="main">)</span> zs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vs_zs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> zs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def set_zip ad_equiv_pair.simps
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> map projl <span class="main">`</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_def<span class="main">(</span>1<span class="main">)</span> zs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff comp_def vs_zs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"map Inl <span class="skolem">zs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> map projl <span class="main">`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> map projl <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> xs_map_Inl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> map Inl <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms xs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_idI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_rep <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xs_map_Inl <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="main">]</span></span> ad_agr_list_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eval_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> table<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_intp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_abs</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="main">(</span>act_edom <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span> nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">,</span> fo_nmlz <span class="main">(</span>act_edom <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">`</span> proj_fmla <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">σ</span> UNIV<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_projl_Inl<span class="main">:</span> <span class="quoted"><span class="quoted">"map projl <span class="main">(</span>map Inl <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> length_map nth_equalityI nth_map sum.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_rep_eval_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="free">φ</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_rep <span class="main">(</span>eval_abs <span class="free">φ</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> proj_sat <span class="free">φ</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> AD_X_def<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_abs <span class="free">φ</span> <span class="free">I</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> act_edom <span class="free">φ</span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> nfv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> fo_nmlz <span class="main">(</span>act_edom <span class="free">φ</span> <span class="free">I</span><span class="main">)</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eval_abs <span class="free">φ</span> <span class="free">I</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_abs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> AD_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"act_edom <span class="free">φ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AD_X_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> X_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> map Inl <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> sat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_X_def norm_proj_fmla_esat_sat<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ts'</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> ad_agr_list <span class="skolem">AD</span> <span class="main">(</span>map Inl <span class="bound">ts</span><span class="main">)</span> <span class="bound">ts'</span><span class="main">}</span> <span class="main">=</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> sat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ts'</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> ad_agr_list <span class="skolem">AD</span> <span class="main">(</span>map Inl <span class="bound">ts</span><span class="main">)</span> <span class="bound">ts'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> vs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs'</span> <span class="main">∈</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> sat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"ad_agr_list <span class="skolem">AD</span> <span class="main">(</span>map Inl <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span>fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map Inl <span class="skolem">vs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> X_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">vs</span> <span class="main">=</span> length <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vs'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map ad_agr_list_def fo_nmlz_length<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exists_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="free">φ</span>"</span></span> <span class="quoted"><span class="skolem">vs</span></span><span class="main">]</span> sorted_distinct_fv_list
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map Inl <span class="skolem">vs'</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vs'_def fo_nmlz_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="skolem">AD</span> <span class="main">(</span>map <span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> σ_def τ_def map_map vs'_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"map Inl <span class="skolem">vs'</span> <span class="main">=</span> map <span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">τ'</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"sat <span class="free">φ</span> <span class="free">I</span> <span class="skolem">τ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vs'_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ad_agr'<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="skolem">AD</span> <span class="main">(</span>map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>map <span class="main">(</span>Inl <span class="main">∘</span> <span class="skolem">τ'</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_list_comm<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> fo_nmlz_ad_agr τ'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> τ_def map_map map_projl_Inl<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> esat<span class="main">:</span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="skolem">τ</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">using</span></span> esat_UNIV_ad_agr_list<span class="main">[</span><span class="operator">OF</span> ad_agr' AD_sub<span class="main">,</span> <span class="operator">folded</span> sat_esat_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> τ'_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> sat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> esat_UNIV_ad_agr_list<span class="main">[</span><span class="operator">OF</span> ad_agr AD_sub<span class="main">,</span> <span class="operator">folded</span> sat_esat_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> esat
      <span class="keyword1"><span class="command">unfolding</span></span> σ_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> sat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vs_X<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map Inl <span class="skolem">vs</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> X_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ts'</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> ad_agr_list <span class="skolem">AD</span> <span class="main">(</span>map Inl <span class="bound">ts</span><span class="main">)</span> <span class="bound">ts'</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fo_nmlz_ad_agr
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AD_X_def proj_sat_fmla<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_wf_eval_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="free">φ</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>eval_abs <span class="free">φ</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlz_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"act_edom <span class="free">φ</span> <span class="free">I</span>"</span></span><span class="main">]</span> finite_act_edom<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    finite_subset<span class="main">[</span><span class="operator">OF</span> fo_nmlz_proj_sub<span class="main">,</span> <span class="operator">OF</span> nall_tuples_finite<span class="main">]</span>
    fo_rep_eval_abs<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_abs_def fo_nmlz_sound fo_nmlz_length nfv_def proj_sat_def proj_fmla_map<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_fin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> nat<span class="main">)</span> fo_t"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_fin <span class="free">t</span> <span class="main">=</span> finite <span class="main">(</span>fo_rep <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">AD</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_in_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">vs</span><span class="main">.</span> <span class="bound">vs</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> length <span class="bound">vs</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Inl_X_AD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> Inl <span class="bound">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">AD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ts'</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> ad_agr_list <span class="skolem">AD</span> <span class="main">(</span>map Inl <span class="bound">ts</span><span class="main">)</span> <span class="bound">ts'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> fin_Z_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">Z</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">AD</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms fin_ad_agr_list_iff<span class="main">[</span><span class="operator">OF</span> fin<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ Z_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Z_def t_def ad_agr_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">AD</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span><span class="main">.</span> isl <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> Z_sub_AD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span><span class="main">.</span> isl <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> vs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Inr <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> len_in_X
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> sum.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> map <span class="skolem">σ</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exists_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">vs</span></span><span class="main">]</span> len_in_X<span class="main">[</span><span class="operator">OF</span> vs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="skolem">AD</span> <span class="skolem">vs</span> <span class="main">(</span>map Inl <span class="main">(</span>map <span class="skolem">τ</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> proj_out_list<span class="main">[</span><span class="operator">OF</span> fin<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> map_τ_in_Z<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="skolem">τ</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span> <span class="main">∈</span> <span class="skolem">Z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vs_def<span class="main">(</span>1<span class="main">)</span> ad_agr_list_comm<span class="main">[</span><span class="operator">OF</span> τ_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Z_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="skolem">i</span> <span class="main">∉</span> <span class="skolem">AD</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> τ_def vs_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def set_zip comp_def σ_def<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Inl_Inr_False diff_zero image_iff length_upt nth_map nth_upt
          plus_nat.add_0<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vs_def<span class="main">(</span>2<span class="main">)</span> Z_sub_AD
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span><span class="main">.</span> isl <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Inl_X_AD
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Z_def ad_agr_list_def ad_equiv_list_def set_zip in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI isl_def nth_map nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def Z_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_pred<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> infinite list set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="main">(</span>Pred <span class="free">r</span> <span class="free">ts</span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>eval_pred <span class="free">ts</span> <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> Pred <span class="free">r</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> nfv_len<span class="main">:</span> <span class="quoted"><span class="quoted">"nfv <span class="skolem">φ</span> <span class="main">=</span> length <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def nfv_def fv_fo_fmla_list_def fv_fo_fmla_list_Pred<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vimage_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">I</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span><span class="main">.</span> Inl <span class="main">`</span> set <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free">I</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_table <span class="free">ts</span> <span class="main">(</span>map Inl <span class="main">`</span> <span class="free">I</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> nall_tuples <span class="main">(</span>act_edom <span class="skolem">φ</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>nfv <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def proj_vals_def eval_table nfv_len<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> φ_def<span class="main"><span class="main">]</span></span>
        fo_nmlz_length fo_nmlz_sound eval_eterms_def fv_fo_terms_set_list fv_fo_terms_set_def
        vimage_unfold <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nall_tuplesI fo_nmlzd_all_AD <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fv_fo_term_setD<span class="main">)</span>
       <span class="main">(</span><span class="operator">smt</span> UN_I Un_iff eval_eterm.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> imageE image_eqI list.set_map<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_pred <span class="free">ts</span> <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> eval_abs <span class="skolem">φ</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_abs_def φ_def proj_fmla_def eval_pred_def eval_table fv_fo_fmla_list_def
        fv_fo_fmla_list_Pred nall_tuples_set fo_nmlz_idem nfv_len<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> φ_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="main">(</span>Pred <span class="free">r</span> <span class="free">ts</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_wf_eval_abs<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval φ_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map set_fo_term <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AD</span> <span class="main">⟹</span> ad_agr_list <span class="free">AD</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span> <span class="free">zs</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> <span class="free">zs</span> <span class="main">=</span> <span class="bound">τ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">#</span> <span class="skolem">ws</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">zs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def eval_eterms_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> <span class="skolem">τ</span> <span class="keyword1">⊙e</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zs_split ad_agr_list_def ad_equiv_list_def sp_equiv_list_def pairwise_def
        eval_eterms_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Const <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> zs_split<span class="main">]</span> Cons<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> Const
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zs_split eval_eterms_def τ_def ad_agr_list_def ad_equiv_list_def<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ad_equiv_pair.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> fv_fo_terms_set <span class="skolem">ts</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Var <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_terms_set_def in_set_conv_nth <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fv_fo_term_setD<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">τ</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> zs_split τ_def<span class="main">]</span> i_def
        <span class="keyword1"><span class="command">using</span></span> pairwiseD<span class="main">[</span><span class="operator">of</span> <span class="quoted">sp_equiv_pair</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">⋅e</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="skolem">τ</span> <span class="keyword1">⋅e</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Var eval_eterms_def ad_agr_list_def sp_equiv_list_def set_zip<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Var zs_split eval_eterms_def τ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊙e</span> <span class="skolem">ts</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eval_eterms_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">τ</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">w</span><span class="main">)</span>"</span></span><span class="main">]</span> τ_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zs_split eval_eterms_def Var fun_upd_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">w</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def eval_eterms_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sp_equiv_list_fv_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span> <span class="main">(</span><span class="free">τ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="main">(</span>map <span class="free">σ</span> <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">τ</span> <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊙e</span> <span class="main">(</span>map Var <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">τ</span> <span class="keyword1">⊙e</span> <span class="main">(</span>map Var <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eval_eterms_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sp_equiv_list_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> eval_eterms_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_terms_set_list <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fv_fo_terms_setD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def comp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_fv_list<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">X</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span> <span class="main">(</span><span class="free">τ</span> <span class="keyword1">⊙e</span> <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span>
  ad_agr_list <span class="free">X</span> <span class="main">(</span>map <span class="free">σ</span> <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">τ</span> <span class="main">(</span>fv_fo_terms_list <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sp_equiv_list_fv_list
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def ad_agr_list_def ad_equiv_list_def sp_equiv_list_def set_zip<span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> opaque_lifting<span class="main"><span class="main">)</span></span> eval_eterm.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fv_fo_terms_setD fv_fo_terms_set_list
      in_set_conv_nth nth_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_bool<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_wf <span class="main">(</span>Bool <span class="free">b</span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>eval_bool <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_bool_def fo_nmlzd_def nats_def Let_def List.map_filter_simps
      proj_sat_def fv_fo_fmla_list_def ad_agr_list_def ad_equiv_list_def sp_equiv_list_def nfv_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_eq<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> infinite list set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="main">(</span>Eqa <span class="free">t</span> <span class="free">t'</span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>eval_eq <span class="free">t</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> Eqa <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> AD_X_def<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_eq <span class="free">t</span> <span class="free">t'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eval_eq <span class="free">t</span> <span class="free">t'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> AD_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> act_edom <span class="skolem">φ</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_X_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eq_def φ_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> fo_term.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> n_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> nfv <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_X_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def fv_fo_fmla_list_def eval_eq_def nfv_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> X_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="skolem">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="skolem">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pes</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pes</span> <span class="main">=</span> proj_fmla <span class="skolem">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="skolem">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span> <span class="bound">c'</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> Const <span class="bound">c</span> <span class="main">∧</span> <span class="free">t'</span> <span class="main">=</span> Const <span class="bound">c'</span> <span class="main">⟹</span>
      fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> <span class="skolem">pes</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">c'</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def pes_def proj_fmla_map fo_nmlz_def fv_fo_fmla_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">t</span> <span class="main">=</span> Const <span class="bound">c</span> <span class="main">∧</span> <span class="free">t'</span> <span class="main">=</span> Var <span class="bound">n</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">t'</span> <span class="main">=</span> Const <span class="bound">c</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> Var <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span>
      fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> <span class="skolem">pes</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span>Inl <span class="bound">c</span><span class="main">]</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def AD_def pes_def proj_fmla_map fo_nmlz_Cons fv_fo_fmla_list_def image_def
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> Var <span class="bound">n</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="main">=</span> Var <span class="bound">n</span> <span class="main">⟹</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> <span class="skolem">pes</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span>Inr <span class="main">0</span><span class="main">]</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def AD_def pes_def proj_fmla_map fo_nmlz_Cons fv_fo_fmla_list_def image_def
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">n'</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> Var <span class="bound">n</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="main">=</span> Var <span class="bound">n'</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">≠</span> <span class="bound">n'</span> <span class="main">⟹</span>
      fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> <span class="skolem">pes</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span>Inr <span class="main">0</span><span class="main">,</span> Inr <span class="main">0</span><span class="main">]</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def AD_def pes_def proj_fmla_map fo_nmlz_Cons fv_fo_fmla_list_def
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i i' σ
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i i'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def fo_nmlz_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Inr <span class="main">0</span><span class="main">,</span> Inr <span class="main">0</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> <span class="skolem">pes</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm AD_X_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eq_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="skolem">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="skolem">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Eqa <span class="free">t</span> <span class="free">t'</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">σ</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def fv_fo_fmla_list_def proj_fmla_map<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> σ_def AD_X_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def eval_eq_def fv_fo_fmla_list_def fo_nmlz_Cons fo_nmlz_Cons_Cons
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_eq <span class="free">t</span> <span class="free">t'</span> <span class="main">=</span> eval_abs <span class="skolem">φ</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X_def<span class="main">[</span><span class="operator">unfolded</span> AD_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_abs_def AD_X_def AD_def n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="skolem">φ</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_wf_eval_abs<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval φ_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_fo_terms_list_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_terms_list_rec <span class="main">(</span>map Var <span class="free">ns</span><span class="main">)</span> <span class="main">=</span> <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_eterms_map_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">⊙e</span> map Var <span class="free">ns</span> <span class="main">=</span> map <span class="free">σ</span> <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_wf_eval_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> eval_table <span class="main">(</span>map Var <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> AD_sup<span class="main">:</span> <span class="quoted"><span class="quoted">"Inl <span class="main">-`</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">`</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> fvs<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_terms_list <span class="main">(</span>map Var <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_terms_list_def fv_fo_terms_list_Var remdups_adj_distinct<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">vs</span><span class="main">.</span> <span class="bound">vs</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> length <span class="bound">vs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> X_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">vs</span><span class="main">.</span> <span class="bound">vs</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">vs</span> <span class="main">=</span> map <span class="bound">σ</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> proj_vals_X<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_vals <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="keyword1">⊙e</span> map Var <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_eterms_map_Var proj_vals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> eval_table <span class="main">(</span>map Var <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eval_table fvs proj_vals_X
    <span class="keyword1"><span class="command">using</span></span> assms fo_nmlz_idem image_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_rep_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">AD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> map Inl <span class="main">`</span> fo_rep <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
  <span class="keyword3"><span class="command">assume</span></span> vs_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> fin_AD<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">AD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len_vs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">vs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vs_in assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="skolem">vs</span> <span class="main">(</span>map Inl <span class="main">(</span>map <span class="skolem">τ</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proj_out_list<span class="main">[</span><span class="operator">OF</span> fin_AD<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(!)</span> <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">vs</span><span class="main">]</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> map_nth<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_vs<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> map_τ_in<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="skolem">τ</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span> <span class="main">∈</span> fo_rep <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vs_in ad_agr_list_comm<span class="main">[</span><span class="operator">OF</span> τ_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map Inl <span class="main">(</span>map <span class="skolem">τ</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_eqI<span class="main">[</span><span class="operator">OF</span> τ_def<span class="main">]</span> fo_nmlz_idem vs_in assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> map Inl <span class="main">`</span> fo_rep <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_τ_in
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> map Inl <span class="main">`</span> fo_rep <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> vs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>map Inl <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">xs'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map Inl <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="skolem">xs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_eqI<span class="main">[</span><span class="operator">OF</span> vs_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">xs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vs_def<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> fo_nmlz_idem
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vs_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_wf_X<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="free">φ</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> AD_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">AD</span> <span class="main">=</span> act_edom <span class="free">φ</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fo_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fo_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_rep <span class="main">(</span><span class="free">AD</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> sat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_sat_def proj_fmla_map<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_rep_norm<span class="main">[</span><span class="operator">OF</span> fo_wf<span class="main">]</span> norm_proj_fmla_esat_sat<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fo_rep AD_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_neg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>eval_neg <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eval_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_neg <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> nfv <span class="free">φ</span><span class="main">,</span> nall_tuples <span class="skolem">AD</span> <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def nfv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fv_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fv_fo_fmla_list <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nfv_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> nfv <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nfv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> AD_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> act_edom <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> X_def <span class="main">=</span> fo_wf_X<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> t_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> esat_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">vs</span><span class="main">.</span> <span class="bound">vs</span> <span class="main">∈</span> nall_tuples <span class="skolem">AD</span> <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="bound">vs</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span> <span class="main">⟷</span>
    <span class="bound">vs</span> <span class="main">∉</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="skolem">σ</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">vs</span> <span class="main">∉</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map <span class="skolem">σ'</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">σ'</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="skolem">σ</span> UNIV <span class="main">=</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="skolem">σ'</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">using</span></span> esat_UNIV_cong<span class="main">[</span><span class="operator">OF</span> ad_agr_sets_restrict<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ad_agr_list_link<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span>
            <span class="operator">OF</span> fo_nmlz_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> σ_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> σ'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AD_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> σ_def<span class="main">(</span>2<span class="main">)</span> σ'_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∉</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∉</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> nall_tuples <span class="skolem">AD</span> <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_vs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">vs</span> <span class="main">=</span> length <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="skolem">AD</span> <span class="skolem">vs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nfv_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nall_tuplesD<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_vs sorted_distinct_fv_list exists_fo_nmlzd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="bound">R</span> <span class="main">⊆</span> nall_tuples <span class="skolem">AD</span> <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map nfv_def nall_tuplesI fo_nmlz_length fo_nmlz_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_neg <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> eval_abs <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eval_neg eval_abs_def AD_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def proj_fmla_def fv_unfold nfv_unfold image_subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wf_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_wf_eval_abs<span class="main">[</span><span class="operator">OF</span> wf_neg<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cross_with</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">xs</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mapping_join_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span> <span class="bound">X'</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> set_of_idx <span class="free">t</span> <span class="main">⟹</span> <span class="bound">X'</span> <span class="main">⊆</span> set_of_idx <span class="free">t'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">X</span> <span class="bound">X'</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">X</span> <span class="bound">X'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mapping_join <span class="free">f</span> <span class="free">t</span> <span class="free">t'</span> <span class="main">=</span> mapping_join <span class="free">f'</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mapping_join_cross_with<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">t</span> <span class="main">⟹</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">h'</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_of_idx <span class="main">(</span>mapping_join <span class="main">(</span>cross_with <span class="free">f</span><span class="main">)</span> <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="free">h'</span><span class="main">)</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> cross_with <span class="free">f</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"cross_with <span class="free">f</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="skolem">t</span><span class="main">.</span> <span class="free">h</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">x</span><span class="main">}</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="skolem">t'</span><span class="main">.</span> <span class="free">h'</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">x</span><span class="main">}</span> <span class="main">⊆</span> cross_with <span class="free">f</span> <span class="skolem">t</span> <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cross_with_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">h</span> <span class="main">`</span> <span class="free">t</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">h'</span> <span class="main">`</span> <span class="free">t'</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="main">∈</span> cross_with <span class="free">f</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">t</span><span class="main">.</span> <span class="free">h</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">a</span><span class="main">}</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">t'</span><span class="main">.</span> <span class="free">h'</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">a</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> cross_with <span class="free">f</span> <span class="free">t</span> <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> wit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">f</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> z
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cross_with_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="free">h'</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wit<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span> wit<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> hys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h'</span> <span class="skolem">ys</span> <span class="main">∈</span> <span class="free">h</span> <span class="main">`</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wit<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">h</span></span> <span class="skolem"><span class="skolem">xs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> wit hys h
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cross_with_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sub
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">h'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlzd_mono_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">X'</span> <span class="main">⟹</span> fo_nmlzd <span class="free">X</span> <span class="free">xs</span> <span class="main">⟹</span> fo_nmlzd <span class="free">X'</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fo_nmlzd_def order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_idx_cluster<span class="main">:</span> <span class="quoted"><span class="quoted">"set_of_idx <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_conj_idx<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="free">tφ</span>"</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">ψ</span> <span class="free">I</span> <span class="free">tψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval_conj_table <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="free">tψ</span> <span class="main">=</span>
    eval_conj_idx <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="free">tψ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ADφ</span></span> <span class="skolem"><span class="skolem">nφ</span></span> <span class="skolem"><span class="skolem">Xφ</span></span> <span class="keyword2"><span class="keyword">where</span></span> tφ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tφ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ADφ</span><span class="main">,</span> <span class="skolem">nφ</span><span class="main">,</span> <span class="skolem">Xφ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tφ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ADψ</span></span> <span class="skolem"><span class="skolem">nψ</span></span> <span class="skolem"><span class="skolem">Xψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> tψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tψ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ADψ</span><span class="main">,</span> <span class="skolem">nψ</span><span class="main">,</span> <span class="skolem">Xψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> <span class="skolem">ADφ</span> <span class="main">∪</span> <span class="skolem">ADψ</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ADΔφ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ADΔφ</span> <span class="main">=</span> <span class="skolem">AD</span> <span class="main">-</span> <span class="skolem">ADφ</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ADΔψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ADΔψ</span> <span class="main">=</span> <span class="skolem">AD</span> <span class="main">-</span> <span class="skolem">ADψ</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nsφ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nsφ</span> <span class="main">=</span> fv_fo_fmla_list <span class="free">φ</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nsψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nsψ</span> <span class="main">=</span> fv_fo_fmla_list <span class="free">ψ</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="skolem">nsψ</span><span class="main">)</span> <span class="skolem">nsφ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> AD_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ADφ</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ADψ</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AD_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> AD_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ADφ</span> <span class="main">∩</span> <span class="skolem">ADΔφ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ADψ</span> <span class="main">∩</span> <span class="skolem">ADΔψ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ADΔφ_def ADΔψ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> AD_delta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> <span class="skolem">ADφ</span> <span class="main">∪</span> <span class="skolem">ADΔφ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> <span class="skolem">ADψ</span> <span class="main">∪</span> <span class="skolem">ADΔψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ADΔφ_def ADΔψ_def AD_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sd_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="skolem">nsφ</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_distinct <span class="skolem">nsψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsφ_def nsψ_def sorted_distinct_fv_list<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Xφ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="skolem">ADφ</span> <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">vs</span> <span class="main">=</span> length <span class="skolem">nsφ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="skolem">Xφ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">vs</span>
    <span class="keyword1"><span class="command">using</span></span> wf<span class="main">(</span>1<span class="main">)</span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tφ_def nfv_def nsφ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Xψ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="skolem">ADψ</span> <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">vs</span> <span class="main">=</span> length <span class="skolem">nsψ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> <span class="skolem">Xψ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">vs</span>
    <span class="keyword1"><span class="command">using</span></span> wf<span class="main">(</span>2<span class="main">)</span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tψ_def nfv_def nsψ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fo_nmlzd_X<span class="main">:</span> <span class="quoted"><span class="quoted">"Ball <span class="skolem">Xφ</span> <span class="main">(</span>fo_nmlzd <span class="skolem">ADφ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Ball <span class="skolem">Xψ</span> <span class="main">(</span>fo_nmlzd <span class="skolem">ADψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tφ_def tψ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cross_eval_conj_tuple<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">Xφ''</span> <span class="bound">Xψ''</span><span class="main">.</span> eval_conj_set <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="bound">Xφ''</span> <span class="skolem">nsψ</span> <span class="bound">Xψ''</span><span class="main">)</span> <span class="main">=</span> cross_with <span class="main">(</span>eval_conj_tuple <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="skolem">nsψ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">AD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">nsφ</span> <span class="skolem">nsψ</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_conj_set_def cross_with_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> empty_delta<span class="main">:</span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="skolem">ADΔφ</span> <span class="main">⟹</span> <span class="skolem">AD</span> <span class="main">=</span> <span class="skolem">ADφ</span>"</span></span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="skolem">ADΔψ</span> <span class="main">⟹</span> <span class="skolem">AD</span> <span class="main">=</span> <span class="skolem">ADψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AD_def ADΔφ_def ADΔψ_def Set.is_empty_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ect_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ad_agr_close_set <span class="skolem">ADΔφ</span> <span class="skolem">Xφ'</span> <span class="main">⟹</span> <span class="skolem">x'</span> <span class="main">∈</span> ad_agr_close_set <span class="skolem">ADΔψ</span> <span class="skolem">Xψ'</span> <span class="main">⟹</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsφ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsψ</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    eval_conj_tuple <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="skolem">nsψ</span> <span class="skolem">x</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Xφ'</span> <span class="main">⊆</span> <span class="skolem">Xφ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Xψ'</span> <span class="main">⊆</span> <span class="skolem">Xψ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Xφ'</span> <span class="skolem">Xψ'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="skolem">x'</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_conj_tuple_empty<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?ns</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"filter <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">∈</span></span> set <span class="skolem"><span class="skolem">nsψ</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">nsφ</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Xφ_props Xψ_props that fo_nmlzd_mono_sub<span class="main">[</span><span class="operator">OF</span> AD_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> sd_ns
      fo_nmlzd_mono_sub<span class="main">[</span><span class="operator">OF</span> AD_sub<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> fo_nmlzd_mono_sub<span class="main">[</span><span class="operator">OF</span> AD_sub<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      ad_agr_close_sound<span class="main">[</span><span class="operator">OF</span> _ _ AD_disj<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">folded</span> AD_delta<span class="main">]</span>
      ad_agr_close_sound<span class="main">[</span><span class="operator">OF</span> _ _ AD_disj<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">folded</span> AD_delta<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_def ad_agr_close_set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> ad_agr_list_length subsetD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> inner_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">Xφ''</span><span class="main">.</span> eval_conj_set <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="bound">Xφ''</span> <span class="skolem">nsψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>cross_with <span class="main">(</span>eval_conj_tuple <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="skolem">nsψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_conj_set_def cross_with_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inner_cross<span class="main">:</span> <span class="quoted"><span class="quoted">"set_of_idx <span class="main">(</span>mapping_join <span class="main">(</span><span class="main">λ</span><span class="bound">Xφ''</span><span class="main">.</span> eval_conj_set <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="bound">Xφ''</span> <span class="skolem">nsψ</span><span class="main">)</span>
      <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsφ</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔφ</span> <span class="skolem">Xφ'</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsψ</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔψ</span> <span class="skolem">Xψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    cross_with <span class="main">(</span>eval_conj_tuple <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="skolem">nsψ</span><span class="main">)</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔφ</span> <span class="skolem">Xφ'</span><span class="main">)</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔψ</span> <span class="skolem">Xψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Xφ'</span> <span class="main">⊆</span> <span class="skolem">Xφ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Xψ'</span> <span class="main">⊆</span> <span class="skolem">Xψ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Xφ'</span> <span class="skolem">Xψ'</span>
    <span class="keyword1"><span class="command">using</span></span> mapping_join_cross_with<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?f</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"eval_conj_tuple <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="skolem">nsψ</span>"</span></span>
        <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?h</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsφ</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?h'</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsψ</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?t</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ad_agr_close_set <span class="skolem">ADΔφ</span> <span class="skolem">Xφ'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?t'</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ad_agr_close_set <span class="skolem">ADΔψ</span> <span class="skolem">Xψ'</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> ect_empty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sub<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"cross_with <span class="main">(</span>eval_conj_tuple <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="skolem">nsψ</span><span class="main">)</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔφ</span> <span class="skolem">Xφ'</span><span class="main">)</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔψ</span> <span class="skolem">Xψ'</span><span class="main">)</span> <span class="main">=</span>
    cross_with <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> eval_conj_set <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔφ</span> <span class="main">{</span><span class="bound">xs</span><span class="main">}</span><span class="main">)</span> <span class="skolem">nsψ</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔψ</span> <span class="main">{</span><span class="bound">ys</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Xφ'</span> <span class="skolem">Xψ'</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Xφ'</span> <span class="skolem">Xψ'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cross_with_def eval_conj_set_def ad_agr_close_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> outer_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"mapping_join <span class="main">(</span><span class="main">λ</span><span class="bound">Xφ'</span> <span class="bound">Xψ'</span><span class="main">.</span> set_of_idx <span class="main">(</span>mapping_join <span class="main">(</span><span class="main">λ</span><span class="bound">Xφ''</span><span class="main">.</span> eval_conj_set <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="bound">Xφ''</span> <span class="skolem">nsψ</span><span class="main">)</span>
      <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsφ</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔφ</span> <span class="bound">Xφ'</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsψ</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔψ</span> <span class="bound">Xψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> fo_nmlz <span class="main">(</span><span class="skolem">ADφ</span> <span class="main">∩</span> <span class="skolem">ADψ</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsφ</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Xφ</span><span class="main">)</span>
    <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> fo_nmlz <span class="main">(</span><span class="skolem">ADφ</span> <span class="main">∩</span> <span class="skolem">ADψ</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsψ</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Xψ</span><span class="main">)</span> <span class="main">=</span>
    mapping_join <span class="main">(</span>cross_with <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> eval_conj_set <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔφ</span> <span class="main">{</span><span class="bound">xs</span><span class="main">}</span><span class="main">)</span> <span class="skolem">nsψ</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔψ</span> <span class="main">{</span><span class="bound">ys</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> fo_nmlz <span class="main">(</span><span class="skolem">ADφ</span> <span class="main">∩</span> <span class="skolem">ADψ</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsφ</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Xφ</span><span class="main">)</span>
    <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> fo_nmlz <span class="main">(</span><span class="skolem">ADφ</span> <span class="main">∩</span> <span class="skolem">ADψ</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsψ</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Xψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mapping_join_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_idx_cluster inner_cross aux<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fo_nmlzd_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Xφ</span> <span class="main">⟹</span> Ball <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span>fo_nmlzd <span class="skolem">ADφ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Xψ</span> <span class="main">⟹</span> Ball <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span>fo_nmlzd <span class="skolem">ADψ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlzd_X
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ect_empty_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_conj_set <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔφ</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="skolem">nsψ</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔψ</span> <span class="main">{</span><span class="skolem">x'</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Xφ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="skolem">Xψ</span>"</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="main">(</span><span class="skolem">ADφ</span> <span class="main">∩</span> <span class="skolem">ADψ</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsφ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> fo_nmlz <span class="main">(</span><span class="skolem">ADφ</span> <span class="main">∩</span> <span class="skolem">ADψ</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsψ</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">x'</span>
    <span class="keyword1"><span class="command">using</span></span> that fo_nmlzd_x eval_conj_tuple_close_empty<span class="main">[</span><span class="operator">OF</span> _ _ _ _ sd_ns ns_def that<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> Xφ_props Xψ_props
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_conj_set_def AD_def ADΔφ_def ADΔψ_def ad_agr_close_set_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?AD'</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">ADφ</span></span><span class="main"><span class="main">]</span></span> ad_agr_close_set_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?AD'</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">ADψ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> outer_cross <span class="main">=</span> mapping_join_cross_with<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?f</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> eval_conj_set <span class="skolem">AD</span> <span class="skolem">nsφ</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔφ</span> <span class="main">{</span><span class="bound">xs</span><span class="main">}</span><span class="main">)</span> <span class="skolem">nsψ</span> <span class="main">(</span>ad_agr_close_set <span class="skolem">ADΔψ</span> <span class="main">{</span><span class="bound">ys</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?h</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> fo_nmlz <span class="main">(</span><span class="skolem">ADφ</span> <span class="main">∩</span> <span class="skolem">ADψ</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsφ</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?h'</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> fo_nmlz <span class="main">(</span><span class="skolem">ADφ</span> <span class="main">∩</span> <span class="skolem">ADψ</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="skolem">ns</span> <span class="main">(</span>zip <span class="skolem">nsψ</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?t</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Xφ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?t'</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Xψ</span></span><span class="main">,</span> <span class="operator">OF</span> ect_empty_closed<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tφ_def tψ_def Let_def AD_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ADΔφ_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ADΔψ_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        nsφ_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nsψ_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ns_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> outer_cong outer_cross<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_conj_set_def cross_with_def ad_agr_close_set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_fmla_conj_sub<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AD_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"act_edom <span class="free">ψ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span> <span class="main">∩</span>
    fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">ψ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span> <span class="main">⊆</span>
    fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span>  proj_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span> <span class="main">∩</span>
      fo_nmlz <span class="free">AD</span> <span class="main">`</span>  proj_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">ψ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">ψ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">σ'</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> proj_fmla_map
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ad_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"act_edom <span class="free">ψ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">σ'</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_list_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fo_nmlz_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> σ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> σ_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_set<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">ψ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> esat_UNIV_cong<span class="main">[</span><span class="operator">OF</span> ad_agr_sets_restrict<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ad_agr_list_link<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span>
          <span class="operator">OF</span> ad_agr ad_sub<span class="main">]</span> σ_def<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="free">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> σ_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_conj_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="free">tφ</span>"</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">ψ</span> <span class="free">I</span> <span class="free">tψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>eval_conj_table <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="free">tψ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ADφ</span></span> <span class="skolem"><span class="skolem">nφ</span></span> <span class="skolem"><span class="skolem">Xφ</span></span> <span class="skolem"><span class="skolem">ADψ</span></span> <span class="skolem"><span class="skolem">nψ</span></span> <span class="skolem"><span class="skolem">Xψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">tφ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ADφ</span><span class="main">,</span> <span class="skolem">nφ</span><span class="main">,</span> <span class="skolem">Xφ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">tψ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ADψ</span><span class="main">,</span> <span class="skolem">nψ</span><span class="main">,</span> <span class="skolem">Xψ</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ADφ</span> <span class="main">=</span> act_edom <span class="free">φ</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ADψ</span> <span class="main">=</span> act_edom <span class="free">ψ</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tφ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">tψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> AD_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"act_edom <span class="free">φ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">ADφ</span>"</span></span> <span class="quoted"><span class="quoted">"act_edom <span class="free">ψ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">ADψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> AD_X_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"eval_conj_table <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="free">tψ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eval_conj_table <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="free">tψ</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> AD_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> act_edom <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"act_edom <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ADφ</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ADψ</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> <span class="skolem">ADφ</span> <span class="main">∪</span> <span class="skolem">ADψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_X_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> n_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> nfv <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_X_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def Let_def nfv_card fv_fo_fmla_list_set<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Sφ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Sφ</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Sψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Sψ</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">ψ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nsφ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nsφ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> fv_fo_fmla <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nsψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nsψ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> fv_fo_fmla <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> Xφ_def <span class="main">=</span> fo_wf_X<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ts_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> proj_fmla_def<span class="main">,</span> <span class="operator">folded</span> Sφ_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> Xψ_def <span class="main">=</span> fo_wf_X<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ts_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> proj_fmla_def<span class="main">,</span> <span class="operator">folded</span> Sψ_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> fv_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> fv_fo_fmla <span class="free">φ</span> <span class="main">∪</span> set <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"fv_fo_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> fv_fo_fmla <span class="free">ψ</span> <span class="main">∪</span> set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_set<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> res_left_alt <span class="main">=</span> ext_tuple_ad_agr_close<span class="main">[</span><span class="operator">OF</span> Sφ_def AD_sub<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> AD_def<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span>
       Xφ_def<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">folded</span></span> Sφ_def<span class="main"><span class="main"><span class="main">]</span></span></span> nsφ'_def sorted_distinct_fv_list fv_sub<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> res_right_alt <span class="main">=</span> ext_tuple_ad_agr_close<span class="main">[</span><span class="operator">OF</span> Sψ_def AD_sub<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> AD_def<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span>
       Xψ_def<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">folded</span></span> Sψ_def<span class="main"><span class="main"><span class="main">]</span></span></span> nsψ'_def sorted_distinct_fv_list fv_sub<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">note</span></span> eval_conj_set <span class="main">=</span> eval_conj_set_correct<span class="main">[</span><span class="operator">OF</span> nsφ'_def<span class="main"><span class="main">[</span></span><span class="operator">folded</span> fv_fo_fmla_list_set<span class="main"><span class="main">]</span></span>
       nsψ'_def<span class="main"><span class="main">[</span></span><span class="operator">folded</span> fv_fo_fmla_list_set<span class="main"><span class="main">]</span></span> res_left_alt<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> res_right_alt<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
       sorted_distinct_fv_list sorted_distinct_fv_list<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span> <span class="main">∩</span>
     fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">ψ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_X_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> Let_def ts_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> AD_def<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> eval_conj_set proj_fmla_def
    <span class="keyword1"><span class="command">unfolding</span></span> res_left_alt<span class="main">(</span>1<span class="main">)</span> res_right_alt<span class="main">(</span>1<span class="main">)</span> Sφ_def Sψ_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_conj_table <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="free">tψ</span> <span class="main">=</span>
    eval_abs <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proj_fmla_conj_sub<span class="main">[</span><span class="operator">OF</span> AD_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ts_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> AD_X_def AD_def<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> n_def eval_abs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wf_conj<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_wf_eval_abs<span class="main">[</span><span class="operator">OF</span> wf_conj<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_conj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="free">tφ</span>"</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">ψ</span> <span class="free">I</span> <span class="free">tψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="main">(</span>Conj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>eval_conj_idx <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="free">tψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eval_conj_table eval_conj_idx assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_ad_agr_close<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AD_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"act_edom <span class="free">ψ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">ADψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ADψ</span> <span class="main">⊆</span> <span class="free">AD</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Sψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Sψ</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">ψ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Xψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Xψ</span> <span class="main">=</span> fo_nmlz <span class="free">ADψ</span> <span class="main">`</span> proj_vals <span class="free">Sψ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">xs</span> <span class="main">∈</span> ad_agr_close_set <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">ADψ</span><span class="main">)</span> <span class="free">Xψ</span> <span class="main">⟷</span> fo_nmlz <span class="free">ADψ</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">Xψ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">xs</span> <span class="main">∈</span> ad_agr_close_set <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">ADψ</span><span class="main">)</span> <span class="free">Xψ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> proj_vals <span class="free">Sψ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">xs</span> <span class="main">∈</span> ad_agr_close <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">ADψ</span><span class="main">)</span> <span class="main">(</span>fo_nmlz <span class="free">ADψ</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_sub<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_close_set_def Xψ_def Set.is_empty_def ad_agr_close_empty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_sound<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">ADψ</span> <span class="free">xs</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_list_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> AD_sub<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fo_nmlz_ad_agr<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">ADψ</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>fo_nmlz <span class="free">ADψ</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr_list_comm ad_agr_close_sound<span class="main">[</span><span class="operator">OF</span> ys_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fo_nmlz_sound<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">ADψ</span> <span class="free">xs</span> <span class="main">(</span>fo_nmlz <span class="free">ADψ</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr_list_trans
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">ADψ</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">Xψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Xψ_def fo_nmlz_idem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_sound<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fo_nmlz_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">ADψ</span> <span class="free">xs</span> <span class="main">∈</span> <span class="free">Xψ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> proj_vals <span class="free">Sψ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">ADψ</span> <span class="free">xs</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Xψ_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fo_nmlz_eqD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">ADψ</span> <span class="skolem">ys</span> <span class="main">(</span>fo_nmlz <span class="free">ADψ</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_ad_agr<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ad_agr_xs_ys <span class="main">=</span> ad_agr_list_comm<span class="main">[</span><span class="operator">OF</span> ad_agr_list_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ad_agr_list_comm<span class="main"><span class="main">[</span></span><span class="operator">OF</span>
          ad_agr_list_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> AD_sub<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fo_nmlz_ad_agr<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
        ad_agr_list_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ys_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fo_nmlz_ad_agr<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">xs</span> <span class="main">∈</span> ad_agr_close <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">ADψ</span><span class="main">)</span> <span class="main">(</span>fo_nmlz <span class="free">ADψ</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_sub ad_agr_close_complete<span class="main">[</span><span class="operator">OF</span> _ _ _ ad_agr_xs_ys<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_sound sup.absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">xs</span> <span class="main">∈</span> ad_agr_close_set <span class="main">(</span><span class="free">AD</span> <span class="main">-</span> <span class="free">ADψ</span><span class="main">)</span> <span class="free">Xψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_def<span class="main">(</span>1<span class="main">)</span> AD_sub<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_close_set_def Xψ_def Set.is_empty_def ad_agr_close_empty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_sound<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_ajoin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="free">tφ</span>"</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">ψ'</span> <span class="free">I</span> <span class="free">tψ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span>
    <span class="main">(</span>eval_ajoin <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ'</span><span class="main">)</span> <span class="free">tψ'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ADφ</span></span> <span class="skolem"><span class="skolem">nφ</span></span> <span class="skolem"><span class="skolem">Xφ</span></span> <span class="skolem"><span class="skolem">ADψ'</span></span> <span class="skolem"><span class="skolem">nψ'</span></span> <span class="skolem"><span class="skolem">Xψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">tφ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ADφ</span><span class="main">,</span> <span class="skolem">nφ</span><span class="main">,</span> <span class="skolem">Xφ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">tψ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ADψ'</span><span class="main">,</span> <span class="skolem">nψ'</span><span class="main">,</span> <span class="skolem">Xψ'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ADφ</span> <span class="main">=</span> act_edom <span class="free">φ</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ADψ'</span> <span class="main">=</span> act_edom <span class="free">ψ'</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tφ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">tψ'</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> AD_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"act_edom <span class="free">φ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">ADφ</span>"</span></span> <span class="quoted"><span class="quoted">"act_edom <span class="free">ψ'</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">ADψ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> AD_X_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"eval_ajoin <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ'</span><span class="main">)</span> <span class="free">tψ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eval_ajoin <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ'</span><span class="main">)</span> <span class="free">tψ'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> AD_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> act_edom <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"act_edom <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ADφ</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ADψ'</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> <span class="skolem">ADφ</span> <span class="main">∪</span> <span class="skolem">ADψ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_X_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> n_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> nfv <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_X_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def Let_def nfv_card fv_fo_fmla_list_set<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Sφ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Sφ</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Sψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Sψ'</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">ψ'</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nsφ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nsφ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> fv_fo_fmla <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nsψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nsψ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> fv_fo_fmla <span class="free">ψ'</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">=</span> sort <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span> <span class="main">@</span> fv_fo_fmla_list <span class="free">ψ'</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> Xφ_def <span class="main">=</span> fo_wf_X<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ts_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> proj_fmla_def<span class="main">,</span> <span class="operator">folded</span> Sφ_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> Xψ'_def <span class="main">=</span> fo_wf_X<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ts_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> proj_fmla_def<span class="main">,</span> <span class="operator">folded</span> Sψ'_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> fv_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fv_fo_fmla <span class="free">φ</span> <span class="main">∪</span> set <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"fv_fo_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fv_fo_fmla <span class="free">ψ'</span> <span class="main">∪</span> set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_set<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> res_left_alt <span class="main">=</span> ext_tuple_ad_agr_close<span class="main">[</span><span class="operator">OF</span> Sφ_def AD_sub<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> AD_def<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span>
       Xφ_def<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">folded</span></span> Sφ_def<span class="main"><span class="main"><span class="main">]</span></span></span> nsφ'_def sorted_distinct_fv_list fv_sub<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> res_right_alt <span class="main">=</span> ext_tuple_ad_agr_close<span class="main">[</span><span class="operator">OF</span> Sψ'_def AD_sub<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> AD_def<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span>
       Xψ'_def<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">folded</span></span> Sψ'_def<span class="main"><span class="main"><span class="main">]</span></span></span> nsψ'_def sorted_distinct_fv_list fv_sub<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> Z_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_vals <span class="skolem">Sφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    fo_nmlz <span class="skolem">AD</span> <span class="bound">xs</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> length <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_idem<span class="main">[</span><span class="operator">OF</span> fo_nmlz_sound<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_length proj_vals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Z_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_vals <span class="skolem">Sφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
    ext_tuple_set <span class="skolem">AD</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ'</span><span class="main">)</span> <span class="skolem">nsψ'</span> <span class="main">(</span>ad_agr_close_set <span class="main">(</span><span class="skolem">AD</span> <span class="main">-</span> <span class="skolem">ADψ'</span><span class="main">)</span> <span class="skolem">Xψ'</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">xs</span></span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_vals <span class="skolem">Sφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      fo_nmlz <span class="skolem">ADψ'</span> <span class="main">(</span>proj_tuple <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ'</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∉</span> <span class="skolem">Xψ'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proj_ext_tuple<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Sψ'_def AD_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ts_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> res_right_alt<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
      nsψ'_def sorted_distinct_fv_list fv_sub<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Z_props<span class="main">]</span>
      fo_nmlz_ad_agr_close<span class="main">[</span><span class="operator">OF</span> AD_sub<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> AD_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Sψ'_def Xψ'_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> fv_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    remdups_adj <span class="main">(</span>sort <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span> <span class="main">@</span> fv_fo_fmla_list <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sorted_distinct_set_unique<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> sorted_distinct_fv_list
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_def distinct_remdups_adj_sort<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> X_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span> <span class="main">-</span>
     fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">ψ'</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_X_def
    <span class="keyword1"><span class="command">unfolding</span></span> eval_ajoin.simps ts_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> Let_def AD_def<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> fv_fo_fmla_list_set
      nsφ'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> res_left_alt<span class="main">(</span>1<span class="main">)</span> fv_sort<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Z_diff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      res_right_alt<span class="main">(</span>1<span class="main">)</span> proj_fmla_def Sφ_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Sψ'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> AD_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"act_edom <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AD_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span> <span class="main">∩</span>
     fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> X_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fo_nmlz_eqD<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> AD_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> ad_agr_list_subset esat_UNIV_ad_agr_list fv_fo_fmla_list_set fv_sub<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
        sup_ge1 ts_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_ajoin <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ'</span><span class="main">)</span> <span class="free">tψ'</span> <span class="main">=</span>
    eval_abs <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proj_fmla_conj_sub<span class="main">[</span><span class="operator">OF</span> AD_sub<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> AD_X_def AD_def<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> n_def eval_abs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wf_conj_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="main">(</span>Conj <span class="free">φ</span> <span class="main">(</span>Neg <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_wf_eval_abs<span class="main">[</span><span class="operator">OF</span> wf_conj_neg<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_disj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="free">tφ</span>"</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">ψ</span> <span class="free">I</span> <span class="free">tψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="main">(</span>Disj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span>
    <span class="main">(</span>eval_disj <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="free">tψ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ADφ</span></span> <span class="skolem"><span class="skolem">nφ</span></span> <span class="skolem"><span class="skolem">Xφ</span></span> <span class="skolem"><span class="skolem">ADψ</span></span> <span class="skolem"><span class="skolem">nψ</span></span> <span class="skolem"><span class="skolem">Xψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">tφ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ADφ</span><span class="main">,</span> <span class="skolem">nφ</span><span class="main">,</span> <span class="skolem">Xφ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">tψ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ADψ</span><span class="main">,</span> <span class="skolem">nψ</span><span class="main">,</span> <span class="skolem">Xψ</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ADφ</span> <span class="main">=</span> act_edom <span class="free">φ</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ADψ</span> <span class="main">=</span> act_edom <span class="free">ψ</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tφ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">tψ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> AD_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"act_edom <span class="free">φ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">ADφ</span>"</span></span> <span class="quoted"><span class="quoted">"act_edom <span class="free">ψ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">ADψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> AD_X_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"eval_disj <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="free">tψ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eval_disj <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="free">tψ</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> AD_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> act_edom <span class="main">(</span>Disj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"act_edom <span class="main">(</span>Disj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ADφ</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ADψ</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> <span class="skolem">ADφ</span> <span class="main">∪</span> <span class="skolem">ADψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_X_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> n_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> nfv <span class="main">(</span>Disj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_X_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def Let_def nfv_card fv_fo_fmla_list_set<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Sφ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Sφ</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Sψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Sψ</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">ψ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nsφ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nsφ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> fv_fo_fmla <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nsψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nsψ'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> fv_fo_fmla <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> Xφ_def <span class="main">=</span> fo_wf_X<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ts_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> proj_fmla_def<span class="main">,</span> <span class="operator">folded</span> Sφ_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> Xψ_def <span class="main">=</span> fo_wf_X<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ts_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> proj_fmla_def<span class="main">,</span> <span class="operator">folded</span> Sψ_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> fv_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_fmla <span class="main">(</span>Disj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> fv_fo_fmla <span class="free">φ</span> <span class="main">∪</span> set <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"fv_fo_fmla <span class="main">(</span>Disj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> fv_fo_fmla <span class="free">ψ</span> <span class="main">∪</span> set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_set<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> res_left_alt <span class="main">=</span> ext_tuple_ad_agr_close<span class="main">[</span><span class="operator">OF</span> Sφ_def AD_sub<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> AD_def<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span>
       Xφ_def<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">folded</span></span> Sφ_def<span class="main"><span class="main"><span class="main">]</span></span></span> nsφ'_def sorted_distinct_fv_list fv_sub<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> res_right_alt <span class="main">=</span> ext_tuple_ad_agr_close<span class="main">[</span><span class="operator">OF</span> Sψ_def AD_sub<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> AD_def<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span>
       Xψ_def<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">folded</span></span> Sψ_def<span class="main"><span class="main"><span class="main">]</span></span></span> nsψ'_def sorted_distinct_fv_list fv_sub<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Disj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span> <span class="main">∪</span>
     fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Disj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">ψ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AD_X_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> Let_def AD_def<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fv_fo_fmla_list_set proj_fmla_def nsφ'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> nsψ'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      Sφ_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Sψ_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> res_left_alt<span class="main">(</span>1<span class="main">)</span> res_right_alt<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_disj <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">tφ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">ψ</span><span class="main">)</span> <span class="free">tψ</span> <span class="main">=</span>
    eval_abs <span class="main">(</span>Disj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> AD_X_def AD_def<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> n_def eval_abs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wf_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="main">(</span>Disj <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_wf_eval_abs<span class="main">[</span><span class="operator">OF</span> wf_disj<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_ex_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pos <span class="free">i</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fv_fo_fmla_list <span class="free">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fv_fo_fmla_list <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pos_complete<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="free">φ</span>"</span></span><span class="main">]</span> fv_fo_fmla_list_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Exists <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span>
    fv_fo_fmla_list_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Forall <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_set<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nfv_ex_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"pos <span class="free">i</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfv <span class="free">φ</span> <span class="main">=</span> Suc <span class="main">(</span>nfv <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"nfv <span class="free">φ</span> <span class="main">=</span> Suc <span class="main">(</span>nfv <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> fv_fo_fmla <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> nfv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fv_fo_fmla_list_set pos_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="free">φ</span>"</span></span><span class="main">]</span>
      pos_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="free">φ</span>"</span></span><span class="main">]</span> Some
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nfv_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nfv <span class="free">φ</span> <span class="main">=</span> Suc <span class="main">(</span>nfv <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"nfv <span class="free">φ</span> <span class="main">=</span> Suc <span class="main">(</span>nfv <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nfv_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span> nfv_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Exists <span class="free">i</span> <span class="free">φ</span>"</span></span><span class="main">]</span> nfv_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Forall <span class="free">i</span> <span class="free">φ</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_fv_fo_fmla<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_fo_fmla_list_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="main">(</span>Exists <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_def<span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> distinct_filter distinct_remdups_adj_sort
      distinct_remdups_id filter_set filter_sort remdups_adj_set sorted_list_of_set_sort_remdups
      sorted_remdups_adj sorted_sort sorted_sort_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>eval_exists <span class="free">i</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> act_edom <span class="free">φ</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> act_edom <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> X_def <span class="main">=</span> fo_wf_X<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> t_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> t_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_exists <span class="free">i</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> eval_abs <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pos <span class="free">i</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">note</span></span> fv_eq <span class="main">=</span> fv_ex_all<span class="main">[</span><span class="operator">OF</span> None<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> X_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_def fv_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> esat_exists_not_fv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted">UNIV</span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> pos_complete<span class="main">[</span><span class="operator">OF</span> None<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_set<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def None eval_abs_def fv_eq nfv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> rem_nth <span class="skolem">j</span> <span class="main">`</span> <span class="skolem">X</span> <span class="main">=</span>
      fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> rem_nth <span class="skolem">j</span> <span class="main">`</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> X_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="skolem">σ</span> UNIV"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fo_nmlz_map σ_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> esat_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">τ</span> UNIV"</span></span>
        <span class="keyword1"><span class="command">using</span></span> esat_UNIV_ad_agr_list<span class="main">[</span><span class="operator">OF</span> fo_nmlz_ad_agr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">AD</span></span> <span class="quoted"><span class="quoted">"map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span>
              <span class="operator">folded</span> σ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> τ_def<span class="main"><span class="main">]</span></span><span class="main">]</span> σ_def<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="free">i</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> rem_nth_ws<span class="main">:</span> <span class="quoted"><span class="quoted">"rem_nth <span class="skolem">j</span> <span class="skolem">ws</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rem_nth_sound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="free">φ</span>"</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">τ</span></span><span class="main">]</span> sorted_distinct_fv_list Some
        <span class="keyword1"><span class="command">unfolding</span></span> fv_fo_fmla_list_exists τ_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ws_def<span class="main">(</span>2<span class="main">)</span> esat_τ
        <span class="keyword1"><span class="command">unfolding</span></span> rem_nth_ws
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> assm <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">σ</span> UNIV"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">≡</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">=</span> nfv <span class="free">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nfv_def fo_nmlz_length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ws_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> x_def ws_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_sound proj_fmla_map<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fo_nmlz_map ws_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> rem_nth_ws<span class="main">:</span> <span class="quoted"><span class="quoted">"rem_nth <span class="skolem">j</span> <span class="skolem">ws</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rem_nth_sound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="free">φ</span>"</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> sorted_distinct_fv_list Some
        <span class="keyword1"><span class="command">unfolding</span></span> fv_fo_fmla_list_exists τ_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_exists<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="skolem">AD</span> <span class="main">(</span>map <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_list_subset<span class="main">)</span>
          <span class="main">(</span><span class="operator">rule</span> fo_nmlz_ad_agr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">AD</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"map <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">σ</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">i</span></span></span> <span class="main"><span class="main"><span class="main">:=</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>fv_fo_fmla_list <span class="free"><span class="free"><span class="free">φ</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> ws_def<span class="main"><span class="main">,</span></span>
              <span class="operator">unfolded</span> τ_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> map_fv_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_exists<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> vs_rem_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> σ_def<span class="main">(</span>1<span class="main">)</span> rem_nth_ws
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> ad_agr<span class="main">[</span><span class="operator">unfolded</span> map_fv_cong<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> rem_nth <span class="skolem">j</span> <span class="main">`</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Some ws_in
        <span class="keyword1"><span class="command">unfolding</span></span> vs_rem_nth X_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> nfv_ex_all<span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def Some eval_abs_def nfv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> wf_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="main">(</span>Exists <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_wf_eval_abs<span class="main">[</span><span class="operator">OF</span> wf_ex<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_fo_fmla_list_forall<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="main">(</span>Forall <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_def<span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> distinct_filter distinct_remdups_adj_sort
      distinct_remdups_id filter_set filter_sort remdups_adj_set sorted_list_of_set_sort_remdups
      sorted_remdups_adj sorted_sort sorted_sort_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pairwise_take_drop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="main">(</span>set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="main">(</span>set <span class="main">(</span>zip <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">ys</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pairwise_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_set_card<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∩</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fo_nmlz_sound fo_nmlzd_set card_Inr_vimage_le_length min.absorb2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_take_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span>
  ad_agr_list <span class="free">AD</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">ys</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def sp_equiv_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> take_zip in_set_takeD<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> drop_zip in_set_dropD<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> pairwise_take_drop
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_rem_nth_add_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">zs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">(</span>rem_nth <span class="free">i</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">z</span> <span class="free">zs</span><span class="main">)</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_ad_agr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i_lt_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">z</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_nth_length assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_length<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr_list_take_drop<span class="main">[</span><span class="operator">OF</span> ad_agr<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">,</span> <span class="operator">folded</span> rem_nth_take_drop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i_lt_add<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>
        rem_nth_take_drop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i_lt_add<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> rem_nth_add_nth<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fo_nmlz_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z'</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">ys</span><span class="main">.</span>
    ad_agr_list <span class="free">AD</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">z</span> <span class="main">#</span> drop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">ys</span> <span class="main">@</span> <span class="bound">z'</span> <span class="main">#</span> drop <span class="free">i</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> len_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def n_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map <span class="skolem">σ</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> n_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> len_ys
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> i_le_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_n<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span> <span class="main">=</span> <span class="main">{..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">n</span> <span class="main">#</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_le_n
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_sets <span class="main">(</span><span class="main">{..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">{..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span> <span class="free">AD</span> <span class="skolem">σ</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> iffD2<span class="main">[</span><span class="operator">OF</span> ad_agr_list_link<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> σ_def τ_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_n <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> set_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> τ_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> z'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"ad_agr_sets <span class="main">{..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">{..</span><span class="skolem">n</span><span class="main">}</span> <span class="free">AD</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">z'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> extend_τ<span class="main">[</span><span class="operator">OF</span> ad_agr subset_refl<span class="main">,</span>
        <span class="operator">of</span> <span class="quoted"><span class="quoted">"Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_ys<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> map_take<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">n</span> <span class="main">#</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">z</span> <span class="main">#</span> drop <span class="free">i</span> <span class="free">xs</span>"</span></span>
    <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">z'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">n</span> <span class="main">#</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">ys</span> <span class="main">@</span> <span class="skolem">z'</span> <span class="main">#</span> drop <span class="free">i</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_le_n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> σ_def τ_def take_map drop_map<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> ad_agr_list_link<span class="main">,</span> <span class="operator">OF</span> z'_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> set_n<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> z'_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_take
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_nth_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">zs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z'</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
    fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">z</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z'</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">zs</span> <span class="main">⊆</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_set_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> z'_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">zs</span> <span class="main">@</span> <span class="free">z</span> <span class="main">#</span> drop <span class="free">i</span> <span class="free">zs</span><span class="main">)</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">zs</span> <span class="main">@</span> <span class="skolem">z'</span> <span class="main">#</span> drop <span class="free">i</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr_list_add<span class="main">[</span><span class="operator">OF</span> ad_agr_list_refl assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> add_nth_take_drop<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fo_nmlz_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_add_rem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z'</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">z</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z'</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="free">zs</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_ad_agr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i_le_fo_nmlz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_length<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">z</span> <span class="free">zs</span><span class="main">)</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="skolem">x</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr_list_add<span class="main">[</span><span class="operator">OF</span> ad_agr assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_nth_take_drop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> add_nth_take_drop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i_le_fo_nmlz<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_eqI
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_add_rem'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z'</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">z</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z'</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">zs</span><span class="main">)</span> <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr_list_comm<span class="main">[</span><span class="operator">OF</span> fo_nmlz_ad_agr<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i_le_fo_nmlz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_length<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">z</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="skolem">x</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr_list_add<span class="main">[</span><span class="operator">OF</span> ad_agr i_le_fo_nmlz<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_nth_take_drop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> add_nth_take_drop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i_le_fo_nmlz<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_nmlz_eqI
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_nmlz_add_nth_rem_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="main">(</span>rem_nth <span class="free">i</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rem_nth_length<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> fo_nmlz_add_rem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"rem_nth <span class="free">i</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="free">AD</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span><span class="main">,</span>
      <span class="operator">unfolded</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add_nth_rem_nth_self<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq_commute<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sp_equiv_list_almost_same<span class="main">:</span> <span class="quoted"><span class="quoted">"sp_equiv_list <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">v</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">w</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">v</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span> <span class="main">∨</span> <span class="free">w</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_equiv_list_def pairwise_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> UnCI sp_equiv_pair.simps zip_same<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ad_agr_list_add_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">v</span> <span class="free">zs</span><span class="main">)</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="free">w</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">v</span><span class="main">,</span> <span class="free">w</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> set <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> add_nth_take_drop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> sp_equiv_list_almost_same
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ad_agr_list_def ad_equiv_list_def ad_equiv_pair.simps<span class="main">)</span>
     <span class="main">(</span><span class="operator">smt</span> append_take_drop_id set_append sp_equiv_list_almost_same<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Inr_in_tuple<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">zs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inr <span class="free">n</span> <span class="main">∈</span> set <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fo_nmlz_set_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlzd_code<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> card_wit_sub<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Z</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">Z</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound"><span class="bound">ts</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">Z</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">Z</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> set_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">ts</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">Z</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">z</span><span class="main">}</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">Z</span> <span class="main">∩</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> set_unfold
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_lower1 card_image_le card_seteq finite_imageI inf.absorb_iff1 le_antisym
        surj_card_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_nth_iff_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> fo_nmlz <span class="free">AD</span> <span class="bound">xs</span> <span class="main">=</span> <span class="bound">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="free">zs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">AD</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="main">⟷</span>
    Suc <span class="main">(</span>card <span class="free">AD</span> <span class="main">+</span> card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound"><span class="bound">ts</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ad_agr_list_add_nth<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> Inr_in_tuple<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> less_Suc_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fo_nmlz_eqD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> card_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
      Suc <span class="main">(</span>card <span class="free">AD</span> <span class="main">+</span> card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Inl <span class="main">`</span> <span class="free">AD</span>"</span></span> <span class="quoted"><span class="quoted">"Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_image disjoint_iff_not_equal<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> restrict_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_nth_restrict<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> restrict_z'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">ts</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">ts</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
      <span class="bound">ts</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_nth_restrict<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> image_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span>
      <span class="main">(</span>Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span>
      <span class="main">{</span><span class="bound"><span class="bound">ts</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>card <span class="free">AD</span> <span class="main">+</span> card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
      card <span class="main">{</span><span class="bound"><span class="bound">ts</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> card_Un<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> card_inj_on_le<span class="main">[</span><span class="operator">OF</span> inj image_sub<span class="main">]</span> assms<span class="main">(</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>card <span class="free">AD</span> <span class="main">+</span> card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
      card <span class="main">{</span><span class="bound"><span class="bound">ts</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span>
      card <span class="main">{</span><span class="bound"><span class="bound">ts</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
        <span class="bound">ts</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free">AD</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="main">{..&lt;</span>Suc <span class="main">(</span>card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">i</span> <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_wit_sub<span class="main">[</span><span class="operator">OF</span> _ assm<span class="main">]</span> assms<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> restrict_z<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> restrict_z'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> card_Un
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_fo_nmlz_add_nth_rem_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> fo_nmlz <span class="free">AD</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">ts</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>add_nth <span class="free">j</span> <span class="bound">z</span> <span class="main">(</span>fo_nmlz <span class="free">AD</span> <span class="main">(</span>rem_nth <span class="free">j</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
  <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>rem_nth <span class="free">j</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> fo_nmlz <span class="free">AD</span> <span class="main">(</span>rem_nth <span class="free">j</span> <span class="free">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fo_nmlz_rem_nth_add_nth<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?zs</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fo_nmlz <span class="free">AD</span> <span class="main">(</span>rem_nth <span class="free">j</span> <span class="free">xs</span><span class="main">)</span>"</span></span><span class="main">]</span> rem_nth_length<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> fo_nmlz_add_nth_rem_nth assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_idem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_sound<span class="main"><span class="main">]</span></span> fo_nmlz_length<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_forall<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>eval_forall <span class="free">i</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> act_edom <span class="free">φ</span> <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> act_edom <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> AD_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"act_edom <span class="free">φ</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">AD</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fin_AD<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">AD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_act_edom wf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fin_X<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> X_def <span class="main">=</span> fo_wf_X<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> t_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> t_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_forall <span class="free">i</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> eval_abs <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pos <span class="free">i</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">note</span></span> fv_eq <span class="main">=</span> fv_ex_all<span class="main">[</span><span class="operator">OF</span> None<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> X_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_def fv_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> esat_forall_not_fv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted">UNIV</span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> pos_complete<span class="main">[</span><span class="operator">OF</span> None<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_set<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def None eval_abs_def fv_eq nfv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> i_in_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> fv_fo_fmla <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pos_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Some<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> fv_fo_fmla_list_set<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> fo_nmlz_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> fo_nmlz <span class="skolem">AD</span> <span class="bound">xs</span> <span class="main">=</span> <span class="bound">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def proj_fmla_map fo_nmlz_idem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_sound<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> j_lt_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="bound">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pos_sound<span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def proj_fmla_map fo_nmlz_length<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> rem_nth_j_le_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">≤</span> length <span class="main">(</span>fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rem_nth_length j_lt_len
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_length<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> img_proj_fmla<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="main">(</span>Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">Z</span><span class="main">.</span> Suc <span class="main">(</span>card <span class="skolem">AD</span> <span class="main">+</span> card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="bound">Z</span><span class="main">)</span>
      <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ts</span><span class="main">.</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="bound">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> Mapping.keys <span class="main">(</span>Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">Z</span><span class="main">.</span> Suc <span class="main">(</span>card <span class="skolem">AD</span> <span class="main">+</span> card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="bound">Z</span><span class="main">)</span>
        <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ts</span><span class="main">.</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="bound">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>add_nth <span class="skolem">j</span> <span class="bound">a</span> <span class="main">(</span>fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> add_nth_iff_card<span class="main">[</span><span class="operator">OF</span> fo_nmlz_X j_lt_len fo_nmlz_idem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_sound<span class="main"><span class="main">]</span></span>
            rem_nth_j_le_len fin_AD fin_X<span class="main">]</span> set_fo_nmlz_add_nth_rem_nth<span class="main">[</span><span class="operator">OF</span> j_lt_len fo_nmlz_X j_lt_len<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span>
        <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="skolem">σ</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> X_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fo_nmlz_map σ_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> fo_nmlzd_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlzd <span class="skolem">AD</span> <span class="main">(</span>map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> τ_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> σ_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_sound<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> rem_nth_j_ws<span class="main">:</span> <span class="quoted"><span class="quoted">"rem_nth <span class="skolem">j</span> <span class="skolem">ws</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rem_nth_sound<span class="main">[</span><span class="operator">OF</span> _ Some<span class="main">]</span> sorted_distinct_fv_list
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> τ_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> esat_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">τ</span> UNIV"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> esat.simps
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>add_nth <span class="skolem">j</span> <span class="skolem">x</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fo_nmlz_add_rem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"rem_nth <span class="skolem">j</span> <span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="skolem">AD</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> rem_nth_length
            j_lt_len<span class="main">[</span><span class="operator">OF</span> ws_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> ws_def<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> add_nth_rem_nth_map<span class="main">[</span><span class="operator">OF</span> _ Some<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> sorted_distinct_fv_list
          <span class="keyword1"><span class="command">unfolding</span></span> τ_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def proj_fmla_map esat_UNIV_ad_agr_list<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ AD_sub<span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fo_nmlz_eqD<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> rem_nth_ws<span class="main">:</span> <span class="quoted"><span class="quoted">"rem_nth <span class="skolem">j</span> <span class="skolem">ws</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rem_nth_sound<span class="main">[</span><span class="operator">OF</span> _ Some<span class="main">]</span> sorted_distinct_fv_list
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_forall τ_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ws_def<span class="main">(</span>2<span class="main">)</span> esat_τ
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map rem_nth_ws<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> assm <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">σ</span> UNIV"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_fmla_map<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all_esat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">≡</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">=</span> nfv <span class="free">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nfv_def fo_nmlz_length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ws_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">∈</span> fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> all_esat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="free">i</span>"</span></span><span class="main">]</span> ws_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fo_nmlz_sound proj_fmla_map<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ws_in_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> τ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fo_nmlz_map ws_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> rem_nth_ws<span class="main">:</span> <span class="quoted"><span class="quoted">"rem_nth <span class="skolem">j</span> <span class="skolem">ws</span> <span class="main">=</span> map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rem_nth_sound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fv_fo_fmla_list <span class="free">φ</span>"</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> sorted_distinct_fv_list Some
        <span class="keyword1"><span class="command">unfolding</span></span> fv_fo_fmla_list_forall τ_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_forall<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ad_agr<span class="main">:</span> <span class="quoted"><span class="quoted">"ad_agr_list <span class="skolem">AD</span> <span class="main">(</span>map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>map <span class="skolem">τ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ad_agr_list_subset<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> fo_nmlz_ad_agr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">AD</span></span><span class="main">]</span> ws_def τ_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> map_fv_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> map <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_forall<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> vs_rem_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> σ_def<span class="main">(</span>1<span class="main">)</span> rem_nth_ws
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fo_nmlz_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> ad_agr<span class="main">[</span><span class="operator">unfolded</span> map_fv_cong<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>add_nth <span class="skolem">j</span> <span class="bound">a</span> <span class="main">(</span>fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
        fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> add_rem<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>add_nth <span class="skolem">j</span> <span class="skolem">a</span> <span class="main">(</span>fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>map <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> add_nth_rem_nth_map<span class="main">[</span><span class="operator">OF</span> _ Some<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">τ</span></span><span class="main">]</span> sorted_distinct_fv_list
            fo_nmlz_add_rem'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"rem_nth <span class="skolem">j</span> <span class="skolem">ws</span>"</span></span><span class="main">]</span> rem_nth_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">ws</span></span><span class="main">]</span>
            j_lt_len<span class="main">[</span><span class="operator">OF</span> ws_in_X<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> τ_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"esat <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="skolem">τ</span> UNIV"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> esat_UNIV_ad_agr_list σ_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ subset_refl<span class="main"><span class="main">,</span></span> <span class="operator">folded</span> t_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> fo_nmlz_ad_agr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">AD</span></span> <span class="quoted"><span class="quoted">"map <span class="skolem">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> ws_def<span class="main">,</span> <span class="operator">unfolded</span> τ_def<span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> ad_agr_list_link<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_fo_fmla_list_set ad_agr_sets_def sp_equiv_def pairwise_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"esat <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>add_nth <span class="skolem">j</span> <span class="skolem">a</span> <span class="main">(</span>fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
          fo_nmlz <span class="skolem">AD</span> <span class="main">`</span> proj_fmla <span class="free">φ</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> esat <span class="free">φ</span> <span class="free">I</span> <span class="bound">σ</span> UNIV<span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_rem proj_fmla_map<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∈</span> Mapping.keys <span class="main">(</span>Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">Z</span><span class="main">.</span> Suc <span class="main">(</span>card <span class="skolem">AD</span> <span class="main">+</span> card <span class="main">(</span>Inr <span class="main">-`</span> set <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="bound">Z</span><span class="main">)</span>
        <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ts</span><span class="main">.</span> fo_nmlz <span class="skolem">AD</span> <span class="main">(</span>rem_nth <span class="skolem">j</span> <span class="bound">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> vs_rem_nth X_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> add_nth_iff_card<span class="main">[</span><span class="operator">OF</span> fo_nmlz_X j_lt_len fo_nmlz_idem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fo_nmlz_sound<span class="main"><span class="main">]</span></span>
            rem_nth_j_le_len fin_AD fin_X<span class="main">]</span> set_fo_nmlz_add_nth_rem_nth<span class="main">[</span><span class="operator">OF</span> j_lt_len fo_nmlz_X j_lt_len<span class="main">]</span> ws_in_X
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> nfv_ex_all<span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def Some eval_abs_def nfv_def img_proj_fmla<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> t_def<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> wf_all<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="main">(</span>Forall <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_wf_eval_abs<span class="main">[</span><span class="operator">OF</span> wf_all<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fo_res</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> fo_t <span class="main">⇒</span> <span class="tfree">'a</span> eval_res"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fo_res</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> fo_fin <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AD</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="keyword1">then</span> Fin <span class="main">(</span>map projl <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Infin<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_res_fin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> nat<span class="main">)</span> fo_t"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fo_rep <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_res <span class="free">t</span> <span class="main">=</span> Fin <span class="main">(</span>fo_rep <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_fin assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> t_def fo_res.simps fo_rep_fin <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_res_infin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> nat<span class="main">)</span> fo_t"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>finite <span class="main">(</span>fo_rep <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fo_res <span class="free">t</span> <span class="main">=</span> Infin"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fo_fin assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> t_def fo_res.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fo_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"fo_wf <span class="free">φ</span> <span class="free">I</span> <span class="free">t</span> <span class="main">⟹</span> fo_rep <span class="free">t</span> <span class="main">=</span> proj_sat <span class="free">φ</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Ailamazyan<span class="main">:</span> eval_fo <span class="quoted">fo_wf</span> <span class="quoted">eval_pred</span> <span class="quoted">fo_rep</span> <span class="quoted">fo_res</span>
  <span class="quoted">eval_bool</span> <span class="quoted">eval_eq</span> <span class="quoted">eval_neg</span> <span class="quoted">eval_conj_idx</span> <span class="quoted">eval_ajoin</span> <span class="quoted">eval_disj</span>
  <span class="quoted">eval_exists</span> <span class="quoted">eval_forall</span>
  <span class="keyword2"><span class="keyword">defines</span></span> eval_fmla <span class="main">=</span> <span class="quoted">Ailamazyan.eval_fmla</span>
      <span class="keyword2"><span class="keyword">and</span></span> eval <span class="main">=</span> <span class="quoted">Ailamazyan.eval</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fo_rep<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fo_res_fin<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fo_res_infin<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_pred<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_bool<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_eq<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_neg<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_conj<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_ajoin<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_disj<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_exists<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_forall<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">esat_UNIV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> table<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_intp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> nat<span class="main">)</span> val <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">esat_UNIV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> esat <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> UNIV"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> esat_UNIV_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esat_UNIV <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> wf_fo_intp <span class="free">φ</span> <span class="free">I</span> <span class="keyword1">then</span>
  <span class="main">(</span><span class="keyword1">case</span> eval_fmla <span class="free">φ</span> <span class="free">I</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">AD</span><span class="main">,</span> <span class="bound">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⇒</span>
    fo_nmlz <span class="main">(</span>act_edom <span class="free">φ</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>
  <span class="keyword1">else</span> esat_UNIV <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AD</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Ailamazyan.eval_fmla <span class="free">φ</span> <span class="free">I</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">AD</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Ailamazyan.eval_fmla <span class="free">φ</span> <span class="free">I</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> wf_fo_intp<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_fo_intp <span class="free">φ</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> fo_wf <span class="main">=</span> Ailamazyan.eval_fmla_correct<span class="main">[</span><span class="operator">OF</span> wf_fo_intp<span class="main">,</span> <span class="operator">unfolded</span> t_def<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> T_def <span class="main">=</span> fo_wf_X<span class="main">[</span><span class="operator">OF</span> fo_wf<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> AD_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">AD</span> <span class="main">=</span> act_edom <span class="free">φ</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fo_wf
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"esat_UNIV <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> <span class="main">⟷</span>
      fo_nmlz <span class="main">(</span>act_edom <span class="free">φ</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>map <span class="free">σ</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> esat_UNIV_ad_agr_list<span class="main">[</span><span class="operator">OF</span> _ subset_refl<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> esat_UNIV_def T_def AD_def proj_fmla_map
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fo_nmlz_eqD<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> infinite<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fo_fmla"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> wf_fo_intp <span class="free">φ</span> <span class="free">I</span> <span class="keyword1">then</span>
  <span class="main">(</span><span class="keyword1">case</span> eval_fmla <span class="free">φ</span> <span class="free">I</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">AD</span><span class="main">,</span> <span class="bound">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⇒</span>
    fo_nmlz <span class="main">(</span>act_edom <span class="free">φ</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>Inl <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>fv_fo_fmla_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>
  <span class="keyword1">else</span> sat <span class="free">φ</span> <span class="free">I</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> esat_UNIV_code sat_esat_conv<span class="main">[</span><span class="operator">folded</span> esat_UNIV_def<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</body>

</html>