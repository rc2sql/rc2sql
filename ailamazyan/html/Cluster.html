<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Cluster</title>
</head>


<body>
<div class="head">
<h1>Theory Cluster</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Cluster
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Mapping_Code.html">Mapping_Code</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> these_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Option.these <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Option.these <span class="free">A</span> <span class="main">∪</span> Option.these <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> these_insert<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Option.these <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> Some <span class="bound">a</span> <span class="main">⇒</span> insert <span class="bound">a</span> <span class="main">|</span> None <span class="main">⇒</span> id<span class="main">)</span> <span class="main">(</span>Option.these <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> these_image_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">∪</span> Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> these_imageI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> cluster <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> mapping"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">Y</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> Some <span class="bound">x</span> <span class="main">∈</span> <span class="bound">f</span> <span class="main">`</span> <span class="bound">Y</span> <span class="keyword1">then</span> Some <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">y</span> <span class="main">=</span> Some <span class="bound">x</span><span class="main">}</span> <span class="keyword1">else</span> None"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_idx_cluster<span class="main">:</span> <span class="quoted"><span class="quoted">"set_of_idx <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_cluster'<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>cluster <span class="main">(</span>Some <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">y</span> <span class="main">∉</span> <span class="free">h</span> <span class="main">`</span> <span class="free">X</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> ord
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_to_rbt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_to_rbt</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> rbt_lookup <span class="bound">t</span> <span class="bound">a</span> <span class="keyword1">of</span> Some <span class="bound">X</span> <span class="main">⇒</span> rbt_insert <span class="bound">a</span> <span class="main">(</span>insert <span class="bound">b</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">t</span> <span class="main">|</span> None <span class="main">⇒</span> rbt_insert <span class="bound">a</span> <span class="main">{</span><span class="bound">b</span><span class="main">}</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_option_to_rbt</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">b</span> <span class="keyword1">of</span> Some <span class="bound">a</span> <span class="main">⇒</span> add_to_rbt <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">t</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cluster_rbt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> unit<span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cluster_rbt</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> RBT_Impl.fold <span class="main">(</span>add_option_to_rbt <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> RBT_Impl.Empty"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> linorder
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_add_to_rbt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> is_rbt <span class="main">(</span>add_to_rbt <span class="free">ab</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_rbt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_fold_add_to_rbt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t'</span> <span class="main">⟹</span>
  is_rbt <span class="main">(</span>RBT_Impl.fold <span class="main">(</span>add_option_to_rbt <span class="free">f</span><span class="main">)</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_rbt_add_to_rbt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_cluster_rbt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="main">(</span>cluster_rbt <span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_rbt_fold_add_to_rbt Empty_is_rbt
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cluster_rbt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_insert_entries_None<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> rbt_lookup <span class="free">t</span> <span class="free">k</span> <span class="main">=</span> None <span class="main">⟹</span>
  set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>rbt_insert <span class="free">k</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>RBT_Impl.entries <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_lookup_in_tree<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rbt_lookup_rbt_insert <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_insert_entries_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> rbt_lookup <span class="free">t</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v'</span> <span class="main">⟹</span>
  set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>rbt_insert <span class="free">k</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>RBT_Impl.entries <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_lookup_in_tree<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rbt_lookup_rbt_insert <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_add_to_rbt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>add_to_rbt <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">a</span> <span class="main">(</span>set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_rbt_def RBT_Impl.keys_def rbt_insert_entries_None rbt_insert_entries_Some <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_fold_add_to_rbt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t'</span> <span class="main">⟹</span> set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>RBT_Impl.fold <span class="main">(</span>add_option_to_rbt <span class="free">f</span><span class="main">)</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Branch <span class="skolem">col</span> <span class="skolem">t1</span> <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="main">(</span>RBT_Impl.fold <span class="main">(</span>add_option_to_rbt <span class="free">f</span><span class="main">)</span> <span class="skolem">t1</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Branch<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_rbt_fold_add_to_rbt<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> None Branch<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> valid<span class="main"><span class="main">]</span></span> Branch<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> Branch<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> valid'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="main">(</span>add_to_rbt <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>RBT_Impl.fold <span class="main">(</span>add_option_to_rbt <span class="free">f</span><span class="main">)</span> <span class="skolem">t1</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_rbt_add_to_rbt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> valid<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Some Branch<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> valid'<span class="main"><span class="main">]</span></span> keys_add_to_rbt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> valid<span class="main"><span class="main">]</span></span> Branch<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> Branch<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_lookup_add_to_rbt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> rbt_lookup <span class="main">(</span>add_to_rbt <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">case</span> rbt_lookup <span class="free">t</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span> <span class="main">|</span> Some <span class="bound">Y</span> <span class="main">⇒</span> insert <span class="free">b</span> <span class="bound">Y</span><span class="main">)</span> <span class="keyword1">else</span> rbt_lookup <span class="free">t</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_rbt_def rbt_lookup_rbt_insert <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_lookup_fold_add_to_rbt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t'</span> <span class="main">⟹</span> rbt_lookup <span class="main">(</span>RBT_Impl.fold <span class="main">(</span>add_option_to_rbt <span class="free">f</span><span class="main">)</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t'</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> Some <span class="free">x</span><span class="main">}</span>
    <span class="main">∪</span> <span class="main">(</span><span class="keyword1">case</span> rbt_lookup <span class="free">t'</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Some <span class="bound">Y</span> <span class="main">⇒</span> <span class="bound">Y</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> rbt_lookup_iff_keys<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> is_rbt_rbt_sorted<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Branch <span class="skolem">col</span> <span class="skolem">t1</span> <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="main">(</span>RBT_Impl.fold <span class="main">(</span>add_option_to_rbt <span class="free">f</span><span class="main">)</span> <span class="skolem">t1</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Branch<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_rbt_fold_add_to_rbt<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">have</span></span> fold_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span>Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
      <span class="free">x</span> <span class="main">∈</span> Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>Branch <span class="skolem">col</span> <span class="skolem">t1</span> <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> None<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fold_simps comp_def None option.case<span class="main">(</span>1<span class="main">)</span> Branch<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> valid<span class="main">]</span> keys_add_to_rbt<span class="main">[</span><span class="operator">OF</span> valid<span class="main">]</span> keys_fold_add_to_rbt<span class="main">[</span><span class="operator">OF</span> Branch<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
        rbt_lookup_add_to_rbt<span class="main">[</span><span class="operator">OF</span> valid<span class="main">]</span> Branch<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Branch<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> fold_set
      <span class="keyword1"><span class="command">using</span></span> rbt_lookup_iff_keys<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> is_rbt_rbt_sorted<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> Branch<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> None <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> these_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> valid'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="main">(</span>add_to_rbt <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>RBT_Impl.fold <span class="main">(</span>add_option_to_rbt <span class="free">f</span><span class="main">)</span> <span class="skolem">t1</span> <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_rbt_add_to_rbt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> valid<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> fold_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="main">(</span>Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
    <span class="free">x</span> <span class="main">∈</span> Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>Branch <span class="skolem">col</span> <span class="skolem">t1</span> <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Some<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> F1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="keyword1">if</span> <span class="skolem">P</span> <span class="keyword1">then</span> Some <span class="skolem">X</span> <span class="keyword1">else</span> None <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span> <span class="main">|</span> Some <span class="bound">Y</span> <span class="main">⇒</span> insert <span class="skolem">k</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">P</span> <span class="keyword1">then</span> <span class="main">(</span>insert <span class="skolem">k</span> <span class="skolem">X</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span> <span class="skolem">X</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> F2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="keyword1">if</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> Some <span class="skolem">X</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="skolem">P</span> <span class="keyword1">then</span> Some <span class="skolem">Y</span> <span class="keyword1">else</span> None <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Some <span class="bound">Y</span> <span class="main">⇒</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="skolem">X</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="skolem">P</span> <span class="keyword1">then</span> <span class="skolem">Y</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span> <span class="skolem">X</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fold_simps comp_def Some option.case<span class="main">(</span>2<span class="main">)</span> Branch<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> valid'<span class="main">]</span> keys_add_to_rbt<span class="main">[</span><span class="operator">OF</span> valid<span class="main">]</span> keys_fold_add_to_rbt<span class="main">[</span><span class="operator">OF</span> Branch<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
        rbt_lookup_add_to_rbt<span class="main">[</span><span class="operator">OF</span> valid<span class="main">]</span> Branch<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Branch<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> fold_set F1 F2
      <span class="keyword1"><span class="command">using</span></span> rbt_lookup_iff_keys<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> is_rbt_rbt_sorted<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> Branch<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Some <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> these_imageI<span class="main">)</span> <span class="comment1">(* slow *)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> comparator"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_to_rbt_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_to_rbt_comp</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> rbt_comp_lookup <span class="free">c</span> <span class="bound">t</span> <span class="bound">a</span> <span class="keyword1">of</span> None <span class="main">⇒</span> rbt_comp_insert <span class="free">c</span> <span class="bound">a</span> <span class="main">{</span><span class="bound">b</span><span class="main">}</span> <span class="bound">t</span>
  <span class="main">|</span> Some <span class="bound">X</span> <span class="main">⇒</span> rbt_comp_insert <span class="free">c</span> <span class="bound">a</span> <span class="main">(</span>insert <span class="bound">b</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_option_to_rbt_comp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">b</span> <span class="keyword1">of</span> Some <span class="bound">a</span> <span class="main">⇒</span> add_to_rbt_comp <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">t</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cluster_rbt_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> unit<span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cluster_rbt_comp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> RBT_Impl.fold <span class="main">(</span>add_option_to_rbt_comp <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> RBT_Impl.Empty"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_to_rbt_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"add_to_rbt_comp <span class="main">=</span> ord.add_to_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_to_rbt_comp_def ord.add_to_rbt_def rbt_comp_lookup<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span> rbt_comp_insert<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> cluster_rbt_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"cluster_rbt_comp <span class="main">=</span> ord.cluster_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cluster_rbt_comp_def ord.cluster_rbt_def add_to_rbt_comp
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> mapping_of_cluster <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> ccompare option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> unit<span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> mapping_rbt"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"cluster_rbt_comp ccomp"</span></span>
  <span class="keyword1"><span class="command">using</span></span> linorder.is_rbt_fold_add_to_rbt<span class="main">[</span><span class="operator">OF</span> comparator.linorder<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ID_ccompare'<span class="main"><span class="main">]</span></span> ord.Empty_is_rbt<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cluster_rbt_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ID_ccompare'<span class="main"><span class="main">]</span></span> ord.cluster_rbt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cluster_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">::</span> ccompare <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> ccompare option"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> unit<span class="main">)</span> mapping_rbt"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cluster <span class="free">f</span> <span class="main">(</span>RBT_set <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ID <span class="keyword1">CCOMPARE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span>
    Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''cluster: ccompare = None''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> cluster <span class="free">f</span> <span class="main">(</span>RBT_set <span class="free">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">c</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> ID <span class="keyword1">CCOMPARE</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span>
    Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''cluster: ccompare = None''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> cluster <span class="free">f</span> <span class="main">(</span>RBT_set <span class="free">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">c'</span> <span class="main">⇒</span> <span class="main">(</span>RBT_Mapping <span class="main">(</span>mapping_of_cluster <span class="free">f</span> <span class="main">(</span>RBT_Mapping2.impl_of <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">c'</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some <span class="skolem">c</span> <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some <span class="skolem">c'</span> <span class="main">::</span> <span class="tfree">'b</span> comparator option<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> c_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> ccomp"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> c'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> ccomp"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="main">(</span>ccomp <span class="main">::</span> <span class="tfree">'a</span> comparator<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ID_ccompare'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="main">(</span>ccomp <span class="main">::</span> <span class="tfree">'b</span> comparator<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ID_ccompare'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> c_class <span class="main">=</span> comparator.linorder<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> c'_class <span class="main">=</span> comparator.linorder<span class="main">[</span><span class="operator">OF</span> c'<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> rbt_lookup_cluster<span class="main">:</span> <span class="quoted"><span class="quoted">"ord.rbt_lookup cless <span class="main">(</span>cluster_rbt_comp ccomp <span class="free">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> Option.these <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> Some <span class="bound">x</span><span class="main">}</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="main">(</span><span class="skolem">t</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> unit<span class="main">)</span> rbt<span class="main">)</span> <span class="main">∨</span> ID ccompare <span class="main">=</span> <span class="main">(</span>None <span class="main">::</span> <span class="tfree">'b</span> comparator option<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> is_rbt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms that
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> cluster_rbt_comp<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span> ord.cluster_rbt_def linorder.rbt_lookup_fold_add_to_rbt<span class="main">[</span><span class="operator">OF</span> c_class ord.Empty_is_rbt<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ord.rbt_lookup.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> dom_ord_rbt_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="skolem">t</span> <span class="main">⟹</span> dom <span class="main">(</span>ord.rbt_lookup cless <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> unit<span class="main">)</span> rbt"</span></span>
      <span class="keyword1"><span class="command">using</span></span> linorder.rbt_lookup_keys<span class="main">[</span><span class="operator">OF</span> c'_class<span class="main">]</span> ord.is_rbt_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cluster <span class="free">f</span> <span class="main">(</span>Collect <span class="main">(</span>RBT_Set2.member <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Mapping <span class="main">(</span>RBT_Mapping2.lookup <span class="main">(</span>mapping_of_cluster <span class="free">f</span> <span class="main">(</span>mapping_rbt.impl_of <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> c'_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_these_eq rbt_comp_lookup<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span> rbt_comp_lookup<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c'<span class="main"><span class="main">]</span></span> rbt_lookup_cluster dom_ord_rbt_lookup<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> RBT_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</body>

</html>